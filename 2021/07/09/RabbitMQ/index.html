<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>RabbitMQ | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="什么是中间件我国企业从20世纪80年代开始就逐渐进行信息化建设，由于方法和体系的不成熟，以及企业业务和市场需求的不断变化，一个企业可能同时运行着多个不同的业务系统，这些系统可能基于不同的操作系统、不同的数据库、异构的网络环境。现在的问题是，如何把这些信息系统结合成一个有机地协同工作的整体，真正实现企业跨平台、分布式应用。中间件便是解决之道，它用自己的复杂换取了企业应用的简单。 &#x3D;&amp;#x3">
<meta property="og:type" content="article">
<meta property="og:title" content="RabbitMQ">
<meta property="og:url" content="http://example.com/2021/07/09/RabbitMQ/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="什么是中间件我国企业从20世纪80年代开始就逐渐进行信息化建设，由于方法和体系的不成熟，以及企业业务和市场需求的不断变化，一个企业可能同时运行着多个不同的业务系统，这些系统可能基于不同的操作系统、不同的数据库、异构的网络环境。现在的问题是，如何把这些信息系统结合成一个有机地协同工作的整体，真正实现企业跨平台、分布式应用。中间件便是解决之道，它用自己的复杂换取了企业应用的简单。 &#x3D;&amp;#x3">
<meta property="og:locale">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405201917954.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/5d65bd92f6618e21df29f41b6cdd5312.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405202629709.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405202758673.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405203150522.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405204344541.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405205206488.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405205218244.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405205407836.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405210958508.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405210958508.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405211250808.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405211346469.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405211741049.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406084643611.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406084800951.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406085804339.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406090135543.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406090327087.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406090828869.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406091046496.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/img_convert/e28ff1f413d828e8b402dd2fe88cfc46.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406145001020.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406145035860.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406150225693.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406150506734.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406150536421.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406150708940.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406151853436.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406151920363.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406152800041.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406154255072.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406160339849.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406160311806.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406161315892.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406165508844.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406165137438.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406165201115.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406165236876.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406165308261.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406171459555.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406180905263.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406180931720.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406191550679.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406192030159.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406192239080.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406192521053.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406192532532.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406195137846.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406195343336.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406195610243.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406195750242.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406195915214.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406200231666.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407095427057.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406201443205.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406201718486.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406202300017.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406202421943.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406202555229.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406202914027.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/img_convert/8afd6cf7c2bc96338d45dce37aa2abd9.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406203924937.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406204026498.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406204221227.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406205342685.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406205108834.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406205504306.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406212558013.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406212729952.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406213203552.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406212828093.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406213237436.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407103942848.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407104003053.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407104037139.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407104226459.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407144600455.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407144403289.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407144622568.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407150327015.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407150816089.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407150834670.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407150847495.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407152215139.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407152234794.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407163123572.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407163137334.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407191253719.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407191734860.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407191327135.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407191817109.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407191904744.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407200228348.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407200323408.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407204038190.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407204141970.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408092428938.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408094836815.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408102221466.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408102255173.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408102059004.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408102134051.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408143558031.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408143719926.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408143755920.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408144636622.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408144901766.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408144914670.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408160506167.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408160526382.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408155546379.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408160252699.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408160428220.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408183044785.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408183147408.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408183450378.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408183544176.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408183826833.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408183843552.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408205852053.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408205904842.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408205919570.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408205933522.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/img_convert/3dc25dcadc591a661fe44956066e6c54.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408205943898.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408205958185.png">
<meta property="og:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408210012467.png">
<meta property="article:published_time" content="2021-07-09T06:59:59.000Z">
<meta property="article:modified_time" content="2022-05-19T07:38:29.406Z">
<meta property="article:author" content="FH">
<meta property="article:tag" content="Rabbit">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405201917954.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Suche"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-RabbitMQ" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/07/09/RabbitMQ/" class="article-date">
  <time class="dt-published" datetime="2021-07-09T06:59:59.000Z" itemprop="datePublished">2021-07-09</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Java/">Java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      RabbitMQ
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="什么是中间件"><a href="#什么是中间件" class="headerlink" title="什么是中间件"></a>什么是中间件</h1><p>我国企业从20世纪80年代开始就逐渐进行信息化建设，由于方法和体系的不成熟，以及企业业务和市场需求的不断变化，一个企业可能同时运行着多个不同的业务系统，这些系统可能基于不同的操作系统、不同的数据库、异构的网络环境。现在的问题是，如何把这些信息系统结合成一个有机地协同工作的整体，真正实现企业跨平台、分布式应用。中间件便是解决之道，它用自己的复杂换取了企业应用的简单。</p>
<p>&#x3D;&#x3D;中间件（Middleware）是处于操作系统和应用程序之间的软件，也有人认为它应该属于操作系统中的一部分。人们在使用中间件时，往往是一组中间件集成在一起，构成一个平台（包括开发平台和运行平台），但在这组中间件中必须要有一个通信中间件，即中间件&#x3D;平台+通信，这个定义也限定了只有用于分布式系统中才能称为中间件，同时还可以把它与支撑软件和实用软件区分开来。中间件（Middleware）是处于操作系统和应用程序之间的软件，也有人认为它应该属于操作系统中的一部分。人们在使用中间件时，往往是一组中间件集成在一起，构成一个平台（包括开发平台和运行平台），但在这组中间件中必须要有一个通信中间件，即中间件&#x3D;平台+通信，这个定义也限定了只有用于分布式系统中才能称为中间件，同时还可以把它与支撑软件和实用软件区分开来。&#x3D;&#x3D;</p>
<p>举例：</p>
<ol>
<li>RMI（Remote Method Invocations, 远程调用）</li>
<li>Load Balancing(负载均衡，将访问负荷分散到各个服务器中)</li>
<li>Transparent Fail-over(透明的故障切换)</li>
<li>Clustering(集群,用多个小的服务器代替大型机）</li>
<li>Back-end-Integration(后端集成，用现有的、新开发的系统如何去集成遗留的系统)</li>
<li>Transaction事务（全局&#x2F;局部）全局事务（分布式事务）局部事务（在同一数据库联接内的事务）</li>
<li>Dynamic Redeployment(动态重新部署,在不停止原系统的情况下，部署新的系统）</li>
<li>System Management(系统管理)</li>
<li>Threading(多线程处理)</li>
<li>Message-oriented Middleware面向消息的中间件（异步的调用编程）</li>
<li>Component Life Cycle(组件的生命周期管理)</li>
<li>Resource pooling（资源池）</li>
<li>Security（安全）</li>
<li>Caching（缓存）</li>
</ol>
<h2 id="为什么需要使用消息中间件"><a href="#为什么需要使用消息中间件" class="headerlink" title="为什么需要使用消息中间件"></a>为什么需要使用消息中间件</h2><p>具体地说，中间件屏蔽了底层操作系统的复杂性，使程序开发人员面对一个简单而统一的开发环境，减少程序设计的复杂性，将注意力集中在自己的业务上，不必再为程序在不同系统软件上的移植而重复工作，从而大大减少了技术上的负担。中间件带给应用系统的，不只是开发的简便、开发周期的缩短，也减少了系统的维护、运行和管理的工作量，还减少了计算机总体费用的投入。</p>
<h2 id="中间件特点"><a href="#中间件特点" class="headerlink" title="中间件特点"></a>中间件特点</h2><p>为<strong>解决分布异构问题</strong>，人们提出了中间件(middleware)的概念。中间件是位于平台(硬件和操作系统)和应用之间的通用服务，如下图所示，这些服务具有标准的程序接口和协议。针对不同的操作系统和硬件平台，它们可以有符合接口和协议规范的多种实现。</p>
<img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405201917954.png" alt="image-20210405201917954" style="zoom:33%;" />

<p>也许很难给中间件一个严格的定义，但中间件应具有如下的一些特点：<br>（1）满足大量应用的需要<br>（2）运行于多种硬件和OS平台<br>（3）支持分布计算，提供跨网络、硬件和OS平台的透明性的应用或服务的交互<br>（4）支持标准的协议<br>（5）支持标准的接口</p>
<p>由于标准接口对于可移植性和标准协议对于互操作性的重要性，中间件已成为许多标准化工作的主要部分。对于应用软件开发，中间件远比操作系统和网络服务更为重要，中间件提供的程序接口定义了一个相对稳定的高层应用环境，不管底层的计算机硬件和系统软件怎样更新换代，只要将中间件升级更新，并保持中间件对外的接口定义不变，应用软件几乎不需任何修改，从而保护了企业在应用软件开发和维护中的重大投资。</p>
<blockquote>
<p>简单说：中间件有个很大的特点，是脱离于具体设计目标，而具备提供普遍独立功能需求的模块。这使得中间件一定是可替换的。如果一个系统设计中，中间件是不可替换的，不是架构、框架设计有问题，那么就是这个中间件，在 别处可能是个中间件，在这个系统内是引擎。哈。</p>
</blockquote>
<h2 id="在项目中什么时候使用中间件技术"><a href="#在项目中什么时候使用中间件技术" class="headerlink" title="在项目中什么时候使用中间件技术"></a>在项目中什么时候使用中间件技术</h2><p>在项目的架构和重构中，使用任何技术和架构的改变我们都需要谨慎斟酌和思考，因为任何技术的融入和变化都可能人员，技术，和成本的增加，中间件的技术一般现在一些互联网公司或者项目中使用比较多，如果你仅仅还只是一个初创公司建议还是使用单体架构，最多加个缓存中间件即可，不要盲目追求新或者所谓的高性能，而追求的背后一定是业务的驱动和项目的驱动，因为一旦追求就意味着你的学习成本，公司的人员结构以及服务器成本，维护和运维的成本都会增加，所以需要谨慎选择和考虑。</p>
<p>但是作为一个开放人员，一定要有学习中间件技术的能力和思维，否则很容易当项目发展到一个阶段在去掌握估计或者在面试中提及，就会给自己带来不小的困扰，在当今这个时代这些技术也并不是什么新鲜的东西，如果去掌握和挖掘最关键的还是自己花时间和花精力去探讨和研究。</p>
<h2 id="课程的规划和安排"><a href="#课程的规划和安排" class="headerlink" title="课程的规划和安排"></a>课程的规划和安排</h2><ul>
<li><p>消息中间件 ActiveMQ</p>
</li>
<li><p>消息中间件 RabbitMQ</p>
</li>
<li><p>消息中间件 Kafaka</p>
</li>
<li><p>消息中间件 RocketMQ</p>
</li>
<li><p>消息中间件应用场景说明</p>
</li>
<li><p>负载均衡中间件(Nginx&#x2F;Lvs)</p>
</li>
<li><p>缓存中间件(Memcache&#x2F;Redis)</p>
</li>
<li><p>数据库中间件(ShardingJdbc&#x2F;Mycat)</p>
</li>
</ul>
<h1 id="中间件技术及架构的概述"><a href="#中间件技术及架构的概述" class="headerlink" title="中间件技术及架构的概述"></a>中间件技术及架构的概述</h1><p>知识图谱</p>
<img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/5d65bd92f6618e21df29f41b6cdd5312.png" alt="5d65bd92f6618e21df29f41b6cdd5312" style="zoom:80%;" />

<h2 id="学习中间件的方式和技巧"><a href="#学习中间件的方式和技巧" class="headerlink" title="学习中间件的方式和技巧"></a>学习中间件的方式和技巧</h2><p>1：理解中间件在项目架构中的作用，以及各中间件的底层实现。<br>2：可以使用一些类比的生活概念去理解中间件，<br>3：使用一些流程图或者脑图的方式去梳理各个中间件在架构中的作用<br>4：尝试用Java技术去实现中间件的远离<br>5：静下来去思考中间件在项目中设计的和使用的原因<br>6：如果找到对应的替代总结方案<br>7：尝试编写博文总结类同中间件技术的对比和使用场景。<br>8：学会查看中间件的源码以及开开源项目和博文。</p>
<h2 id="学习目标"><a href="#学习目标" class="headerlink" title="学习目标"></a>学习目标</h2><ul>
<li>什么是消息中间件</li>
<li>什么是协议</li>
<li>什么是持久化</li>
<li>消息分发</li>
<li>消息的高可用</li>
<li>消息的集群</li>
<li>消息的容错</li>
<li>消息的冗余</li>
</ul>
<h2 id="什么是消息中间件"><a href="#什么是消息中间件" class="headerlink" title="什么是消息中间件"></a>什么是消息中间件</h2><p>在实际的项目中，大部分的企业项目开发中，在早期都采用的是单体的架构模式，如下图：</p>
<img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405202629709.png" alt="image-20210405202629709" style="zoom: 33%;" />

<h2 id="单体架构"><a href="#单体架构" class="headerlink" title="单体架构"></a>单体架构</h2><p>在企业开发的中，大部分的初期架构都采用的是单体架构的模式进行架构，而这种架构的典型的特点：<strong>就是把所有的业务和模块，源代码，静态资源文件等都放在一个一工程中，如果其中的一个模块升级或者迭代发生一个很小变动都会重新编译和重新部署项目。</strong> 这种的架构存在的问题就是：</p>
<ol>
<li>耦合度太高</li>
<li>运维的成本过高</li>
<li>不易维护</li>
<li>服务器的成本高</li>
<li>以及升级架构的复杂度也会增大</li>
</ol>
<p>这样就有后续的分布式架构系统。如下</p>
<h2 id="分布式架构"><a href="#分布式架构" class="headerlink" title="分布式架构"></a>分布式架构</h2><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405202758673.png" alt="image-20210405202758673" style="zoom: 33%;" />

<p>何谓分布式系统呢：</p>
<blockquote>
<p>通俗一点：就是一个请求由服务器端的多个服务（服务或者系统）协同处理完成</p>
</blockquote>
<p>和单体架构不同的是，单体架构是一个请求发起jvm调度线程（确切的是tomcat线程池）分配线程Thread来处理请求直到释放，而分布式是系统是：一个请求是由多个系统共同来协同完成，jvm和环境都可能是独立。如果生活中的比喻的话，单体架构就想建设一个小房子很快就能够搞定，如果你要建设一个鸟巢或者大型的建筑，你就必须是各个环节的协同和分布，这样目的也是项目发展都后期的时候要去部署和思考的问题。我们也不能看出来。</p>
<p>分布式架构系统存在的特点和问题如下：</p>
<p><strong>存在问题</strong></p>
<ol>
<li>学习成本高，技术栈过多</li>
<li>运维成本和服务器成本增高</li>
<li>人员的成本也会增高</li>
<li>项目的负载度也会上升</li>
<li>面临的错误和容错性也会成倍增加</li>
<li>占用的服务器端口和通讯的选择的成本高</li>
<li>安全性的考虑和因素逼迫可能选择RMI&#x2F;MQ相关的服务器端通讯。</li>
</ol>
<p><strong>好处</strong></p>
<ol>
<li>服务系统的独立，占用的服务器资源减少和占用的硬件成本减少，</li>
<li>确切的说是：可以合理的分配服务资源，不造成服务器资源的浪费</li>
<li>系统的独立维护和部署，耦合度降低，可插拔性。</li>
<li>系统的架构和技术栈的选择可以变的灵活（而不是单纯的选择java）</li>
<li>弹性的部署，不会造成平台因部署造成的瘫痪和停服的状态。</li>
</ol>
<h1 id="基于消息中间件的分布式系统的架构"><a href="#基于消息中间件的分布式系统的架构" class="headerlink" title="基于消息中间件的分布式系统的架构"></a>基于消息中间件的分布式系统的架构</h1><h2 id="基于消息中间件的分布式系统的架构-1"><a href="#基于消息中间件的分布式系统的架构-1" class="headerlink" title="基于消息中间件的分布式系统的架构"></a>基于消息中间件的分布式系统的架构</h2><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405203150522.png" alt="image-20210405203150522"></p>
<blockquote>
<p>选用中间件标准：</p>
</blockquote>
<ul>
<li>通信</li>
<li>高效</li>
<li>跨平台</li>
<li>持久化</li>
<li>容错率</li>
<li>………</li>
</ul>
<blockquote>
<p>消息中间件的是</p>
</blockquote>
<ol>
<li>利用可靠的消息传递机制进行系统和系统直接的通讯</li>
<li>通过提供消息传递和消息的排队机制，它可以在分布式系统环境下扩展进程间的通讯。</li>
</ol>
<h2 id="消息中间件应用的场景"><a href="#消息中间件应用的场景" class="headerlink" title="消息中间件应用的场景"></a>消息中间件应用的场景</h2><ol>
<li><p><strong>跨系统</strong>数据传递</p>
</li>
<li><p><strong>高并发</strong>的流量削峰</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405204344541.png" alt="image-20210405204344541"></p>
</li>
<li><p>数据的<strong>分发和异步</strong>处理</p>
</li>
<li><p><strong>大数据</strong>分析与传递</p>
</li>
<li><p><strong>分布式事务</strong></p>
</li>
</ol>
<p>比如你有一个数据要进行迁移或者请求并发过多的时候，比如你有10W的并发请求下订单，我们可以在这些订单入库之前，我们可以把订单请求堆积到消息队列中，让它稳健可靠的入库和执行。</p>
<h2 id="常见的消息中间件"><a href="#常见的消息中间件" class="headerlink" title="常见的消息中间件"></a>常见的消息中间件</h2><p>ActiveMQ、<strong>RabbitMQ</strong>、Kafka、RocketMQ等。</p>
<h2 id="消息中间件的本质及设计"><a href="#消息中间件的本质及设计" class="headerlink" title="消息中间件的本质及设计"></a>消息中间件的本质及设计</h2><p><strong>它是一种接受数据，接受请求、存储数据、发送数据等功能的技术服务。</strong></p>
<blockquote>
<p>MQ消息队列：负责数据的传接受，存储和传递，所以性能要过于普通服务和技术。</p>
</blockquote>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405205206488.png" alt="image-20210405205206488"></p>
<p>谁来生产消息，存储消息和消费消息呢？</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405205218244.png" alt="image-20210405205218244"></p>
<h2 id="消息中间件的核心组成部分"><a href="#消息中间件的核心组成部分" class="headerlink" title="消息中间件的核心组成部分"></a>消息中间件的核心组成部分</h2><ol>
<li>消息的<strong>协议</strong></li>
<li>消息的<strong>持久化</strong>机制</li>
<li>消息的<strong>分发</strong>策略</li>
<li>消息的<strong>高可用，高可靠</strong></li>
<li>消息的<strong>容错机制</strong></li>
</ol>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>其实不论选择单体架构还是分布式架构都是项目开发的一个阶段，在什么阶段选择适合的架构方式，而不能盲目追求，最后造成的后果和问题都需要自己买单。但是作为一个开发人员学习和探讨新的技术是我们每个程序开发者都应该去保持和思考的问题。当我们没办法去改变社会和世界的时候，我们为了生活和生存那就必须要迎合企业和市场的需求，发挥你的价值和所学的才能，创造价值和实现自我。</p>
<h1 id="消息队列协议"><a href="#消息队列协议" class="headerlink" title="消息队列协议"></a>消息队列协议</h1><h2 id="什么是协议"><a href="#什么是协议" class="headerlink" title="什么是协议"></a>什么是协议</h2><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405205407836.png" alt="image-20210405205407836"></p>
<p>我们知道&#x3D;&#x3D;<strong>消息中间件负责数据的传递，存储，和分发消费三个部分</strong>&#x3D;&#x3D;，数据的存储和分发的过程中肯定要遵循某种约定成俗的规范，你是采用底层的TCP&#x2F;IP，UDP协议还是其他的自己取构建等，而这些约定成俗的规范就称之为：协议。</p>
<blockquote>
<p>所谓协议是指：<br>1：计算机底层操作系统和应用程序通讯时共同遵守的一组约定，只有遵循共同的约定和规范，系统和底层操作系统之间才能相互交流。<br>2：和一般的网络应用程序的不同它主要负责数据的接受和传递，所以性能比较的高。<br>3：协议对数据格式和计算机之间交换数据都必须严格遵守规范。</p>
</blockquote>
<h2 id="网络协议的三要素"><a href="#网络协议的三要素" class="headerlink" title="网络协议的三要素"></a>网络协议的三要素</h2><ol>
<li><strong>语法</strong>。语法是用户数据与控制信息的结构与格式,以及数据出现的顺序。</li>
<li><strong>语义</strong>。语义是解释控制信息每个部分的意义。它规定了需要发出何种控制信息,以及完成的动作与做出什么样的响应。</li>
<li><strong>时序</strong>。时序是对事件发生顺序的详细说明。</li>
</ol>
<p>比如我MQ发送一个信息，是以什么数据格式发送到队列中，然后每个部分的含义是什么，发送完毕以后的执行的动作，以及消费者消费消息的动作，消费完毕的响应结果和反馈是什么，然后按照对应的执行顺序进行处理。如果你还是不理解：大家每天都在接触的http请求协议:</p>
<blockquote>
<p>1：语法：http规定了请求报文和响应报文的格式。<br>2：语义：客户端主动发起请求称之为请求。（这是一种定义，同时你发起的是post&#x2F;get请求）<br>3：时序：一个请求对应一个响应。（一定先有请求在有响应，这个是时序）</p>
</blockquote>
<p>而消息中间件采用的并不是http协议，而常见的消息中间件协议有：OpenWire、<strong>AMQP</strong>、<strong>MQTT</strong>、Kafka，OpenMessage协议。</p>
<blockquote>
<p><strong>面试题</strong>：为什么消息中间件不直接使用http协议呢？</p>
<p>1: 因为<strong>http请求报文头和响应报文头是比较复杂的</strong>，包含了cookie，数据的加密解密，状态码，响应码等附加的功能，但是对于一个消息而言，我们并不需要这么复杂，也没有这个必要性，它其实就是负责数据传递，存储，分发就行，一定要追求的是高性能。尽量简洁，快速。</p>
<p>2:大部分情况下<strong>http大部分都是短链接</strong>，在实际的交互过程中，一个请求到响应很有可能会中断，中断以后就不会进行持久化，就会造成请求的丢失。这样就不利于消息中间件的业务场景，因为消息中间件可能是一个长期的获取消息的过程，出现问题和故障要对数据或消息就行持久化等，目的是为了保证消息和数据的高可靠和稳健的运行。</p>
</blockquote>
<h2 id="AMQP协议"><a href="#AMQP协议" class="headerlink" title="AMQP协议"></a>AMQP协议</h2><p>AMQP：(全称：Advanced Message Queuing Protocol) 是高级消息队列协议。由摩根大通集团联合其他公司共同设计。是一个提供统一消息服务的应用层标准高级消息队列协议，是应用层协议的一个开放标准，为面向消息的中间件设计。基于此协议的客户端与消息中间件可传递消息，并不受客户端&#x2F;中间件不同产品，不同的开发语言等条件的限制。<strong>Erlang</strong>中的实现有RabbitMQ等。</p>
<p>特性：</p>
<ol>
<li>分布式事务支持。</li>
<li>消息的持久化支持。</li>
<li>高性能和高可靠的消息处理优势。</li>
</ol>
<p>AMQP协议的支持者：<br><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405210958508.png" alt="image-20210405210958508"></p>
<h2 id="MQTT协议"><a href="#MQTT协议" class="headerlink" title="MQTT协议"></a>MQTT协议</h2><p>MQTT协议：（Message Queueing Telemetry Transport）消息队列是IBM开放的一个即时通讯协议，<strong>物联网系统架构中的重要组成部分</strong>。</p>
<p>特点：</p>
<ol>
<li>轻量</li>
<li>结构简单</li>
<li>传输快，<strong>不支持事务</strong></li>
<li><strong>没有持久化设计</strong>。</li>
</ol>
<p>应用场景：</p>
<ol>
<li><p>适用于计算能力有限</p>
</li>
<li><p>低带宽</p>
</li>
<li><p>网络不稳定的场景。</p>
</li>
</ol>
<p>支持者：</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405210958508.png" alt="image-20210405210958508"></p>
<h2 id="OpenMessage协议"><a href="#OpenMessage协议" class="headerlink" title="OpenMessage协议"></a>OpenMessage协议</h2><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405211250808.png" alt="image-20210405211250808"></p>
<p>是近几年由阿里、雅虎和滴滴出行、Stremalio等公司共同参与创立的分布式消息中间件、流处理等领域的应用开发标准。</p>
<p>特点：</p>
<ol>
<li>结构简单</li>
<li>解析速度快</li>
<li>支持事务和持久化设计。</li>
</ol>
<h2 id="Kafka协议"><a href="#Kafka协议" class="headerlink" title="Kafka协议"></a>Kafka协议</h2><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405211346469.png" alt="image-20210405211346469"></p>
<p>Kafka协议是<strong>基于TCP&#x2F;IP的二进制协议</strong>。消息内部是通过长度来分割，由一些基本数据类型组成。</p>
<p>特点是：</p>
<ol>
<li>结构简单</li>
<li>解析速度快</li>
<li><strong>无事务支持</strong></li>
<li>有持久化设计</li>
</ol>
<h2 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h2><p>协议：是在tcp&#x2F;ip协议基础之上构建的一种约定成俗的规范和机制、它的主要目的可以让客户端（应用程序 Java go）进行沟通和通讯。并且这种协议下规范必须具有持久化，高可用，高可靠的性能。</p>
<h1 id="消息队列持久化"><a href="#消息队列持久化" class="headerlink" title="消息队列持久化"></a>消息队列持久化</h1><h2 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h2><p>简单来说就是将数据存入磁盘，而不是存在内存中随服务器重启断开而消失，使数据能够永久保存。</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210405211741049.png" alt="image-20210405211741049"></p>
<h2 id="常见的持久化方式"><a href="#常见的持久化方式" class="headerlink" title="常见的持久化方式"></a>常见的持久化方式</h2><table>
<thead>
<tr>
<th></th>
<th>ActiveMQ</th>
<th>RabbitMQ</th>
<th>Kafka</th>
<th>RocketMQ</th>
</tr>
</thead>
<tbody><tr>
<td>文件存储</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>数据库</td>
<td>支持</td>
<td>&#x2F;</td>
<td>&#x2F;</td>
<td>&#x2F;</td>
</tr>
</tbody></table>
<h1 id="消息的分发策略"><a href="#消息的分发策略" class="headerlink" title="消息的分发策略"></a>消息的分发策略</h1><h2 id="消息的分发策略-1"><a href="#消息的分发策略-1" class="headerlink" title="消息的分发策略"></a>消息的分发策略</h2><p>MQ消息队列有如下几个角色：</p>
<ol>
<li>生产者</li>
<li>存储消息</li>
<li>消费者</li>
</ol>
<p>那么生产者生成消息以后，MQ进行存储，消费者是如何获取消息的呢？一般获取数据的方式无外乎<strong>推（push）或者拉（pull）</strong>两种方式，典型的git就有推拉机制，我们发送的http请求就是一种典型的拉取数据库数据返回的过程。而消<strong>息队列MQ是一种推送的过程</strong>，而这些推机制会适用到很多的业务场景也有很多对应推机制策略。</p>
<h2 id="场景分析一"><a href="#场景分析一" class="headerlink" title="场景分析一"></a>场景分析一</h2><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406084643611.png" alt="image-20210406084643611"></p>
<blockquote>
<p>比如我在APP上下了一个订单，我们的系统和服务很多，我们如何得知这个消息被那个系统或者那些服务或者系统进行消费，那这个时候就需要一个分发的策略。这就需要消费策略。或者称之为消费的方法论。</p>
</blockquote>
<h2 id="场景分析二"><a href="#场景分析二" class="headerlink" title="场景分析二"></a>场景分析二</h2><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406084800951.png" alt="image-20210406084800951"></p>
<blockquote>
<p>在发送消息的过程中可能会出现异常，或者网络的抖动，故障等等因为造成消息的无法消费，比如用户在下订单，消费MQ接受，订单系统出现故障，导致用户支付失败，那么这个时候就需要消息中间件就必须支持消息重试机制策略。也就是支持：出现问题和故障的情况下，消息不丢失还可以进行重发。</p>
</blockquote>
<h2 id="消息分发策略的机制和对比"><a href="#消息分发策略的机制和对比" class="headerlink" title="消息分发策略的机制和对比"></a>消息分发策略的机制和对比</h2><table>
<thead>
<tr>
<th></th>
<th>ActiveMQ</th>
<th>RabbitMQ</th>
<th>Kafka</th>
<th>RocketMQ</th>
</tr>
</thead>
<tbody><tr>
<td>发布订阅</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>轮询分发</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
<td>&#x2F;</td>
</tr>
<tr>
<td>公平分发</td>
<td>&#x2F;</td>
<td>支持</td>
<td>支持</td>
<td>&#x2F;</td>
</tr>
<tr>
<td>重发</td>
<td>支持</td>
<td>支持</td>
<td>&#x2F;</td>
<td>支持</td>
</tr>
<tr>
<td>消息拉取</td>
<td>&#x2F;</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
</tbody></table>
<blockquote>
<p>轮询分发（自动应答）：公平分配，不会因为服务器的性能而影响</p>
</blockquote>
<blockquote>
<p>公平分发（手动应答（ACK））：会发生<strong>数据倾斜</strong>，能者多劳（服务器性能）</p>
</blockquote>
<h1 id="消息队列高可用和高可靠"><a href="#消息队列高可用和高可靠" class="headerlink" title="消息队列高可用和高可靠"></a>消息队列高可用和高可靠</h1><h2 id="什么是高可用机制"><a href="#什么是高可用机制" class="headerlink" title="什么是高可用机制"></a>什么是高可用机制</h2><p>所谓<strong>高可用</strong>：是指产品在规定的条件和规定的时刻或时间内处于可执行规定功能状态的能力。<br>当业务量增加时，请求也过大，一台消息中间件服务器的会触及硬件（CPU,内存，磁盘）的极限，一台消息服务器你已经无法满足业务的需求，所以消息中间件必须<strong>支持集群部署</strong>。来达到高可用的目的。</p>
<h3 id="集群模式1-Master-slave主从共享数据的部署方式"><a href="#集群模式1-Master-slave主从共享数据的部署方式" class="headerlink" title="集群模式1 - Master-slave主从共享数据的部署方式"></a>集群模式1 - Master-slave主从共享数据的部署方式</h3><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406085804339.png" alt="image-20210406085804339"></p>
<p>解说：生产者讲消费发送到Master节点，所有的都连接这个消息队列共享这块数据区域，Master节点负责写入，一旦Master挂掉，slave节点继续服务。从而形成高可用，</p>
<h3 id="集群模式2-Master-slave主从同步部署方式"><a href="#集群模式2-Master-slave主从同步部署方式" class="headerlink" title="集群模式2 - Master- slave主从同步部署方式"></a>集群模式2 - Master- slave主从同步部署方式</h3><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406090135543.png" alt="image-20210406090135543"></p>
<blockquote>
<p>单写多读</p>
</blockquote>
<p>解释：这种模式写入消息同样在Master主节点上，但是主节点会同步数据到slave节点形成副本，和zookeeper或者redis主从机制很类同。这样可以达到负载均衡的效果，如果消费者有多个这样就可以去不同的节进行消费，以为消息的拷贝和同步会暂用很大的带宽和网络资源。在后续的rabbitmq中会有使用。</p>
<h3 id="集群模式3-多主集群同步部署模式"><a href="#集群模式3-多主集群同步部署模式" class="headerlink" title="集群模式3 - 多主集群同步部署模式"></a>集群模式3 - 多主集群同步部署模式</h3><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406090327087.png" alt="image-20210406090327087"></p>
<blockquote>
<p>多写多读</p>
</blockquote>
<p>解释：和上面的区别不是特别的大，但是它的写入可以往任意节点去写入。</p>
<h3 id="集群模式4-多主集群转发部署模式"><a href="#集群模式4-多主集群转发部署模式" class="headerlink" title="集群模式4 - 多主集群转发部署模式"></a>集群模式4 - 多主集群转发部署模式</h3><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406090828869.png" alt="image-20210406090828869"></p>
<p>解释：如果你插入的数据是broker-1中，元数据信息会存储数据的相关描述和记录存放的位置（队列）。<br>它会对描述信息也就是元数据信息就行同步，如果消费者在broker-2中进行消费，发现自己几点没有对应的消息，可以从对应的元数据信息中去查询，然后返回对应的消息信息，场景：比如买火车票或者黄牛买演唱会门票，比如第一个黄牛有顾客说要买的演唱会门票，但是没有但是他会去联系其他的黄牛询问，如果有就返回。</p>
<h3 id="集群模式5-Master-slave与Breoker-cluster组合的方案"><a href="#集群模式5-Master-slave与Breoker-cluster组合的方案" class="headerlink" title="集群模式5 Master-slave与Breoker-cluster组合的方案"></a>集群模式5 Master-slave与Breoker-cluster组合的方案</h3><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406091046496.png" alt="image-20210406091046496"></p>
<p>解释：实现<strong>多主多从</strong>的热备机制来完成消息的高可用以及数据的热备机制，在生产规模达到一定的阶段的时候，这种使用的频率比较高。</p>
<p>这么集群模式，具体在后续的课程中会进行一个分析和讲解。他们的最终目的都是为<strong>保证：消息服务器不会挂掉，出现了故障依然可以抱着消息服务继续使用。</strong></p>
<p>反正终归三句话：</p>
<ol>
<li>要么消息共享，</li>
<li>要么消息同步</li>
<li>要么元数据共享</li>
</ol>
<h2 id="什么是高可靠机制"><a href="#什么是高可靠机制" class="headerlink" title="什么是高可靠机制"></a>什么是高可靠机制</h2><p>所谓<strong>高可靠是</strong>指：是指系统可以无故障低持续运行，比如一个系统突然崩溃，报错，异常等等并不影响线上业务的正常运行，出错的几率极低，就称之为：高可靠。</p>
<p>在高并发的业务场景中，如果不能保证系统的高可靠，那造成的隐患和损失是非常严重的。</p>
<p>如何保证中间件消息的可靠性呢？可以从两个方面考虑：</p>
<ol>
<li>消息的传输：通过<strong>协议</strong>来保证系统间数据解析的正确性。</li>
<li>消息的存储可靠：通过<strong>持久化</strong>来保证消息的可靠性。</li>
</ol>
<h1 id="RabbitMQ入门及安装-安装包"><a href="#RabbitMQ入门及安装-安装包" class="headerlink" title="RabbitMQ入门及安装(安装包)"></a>RabbitMQ入门及安装(安装包)</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>官网：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/">https://www.rabbitmq.com/</a><br>什么是RabbitMQ,官方给出来这样的解释：</p>
<blockquote>
<p>RabbitMQ is the most widely deployed open source message broker.<br>With tens of thousands of users, RabbitMQ is one of the most popular open source message brokers. From T-Mobile to Runtastic, RabbitMQ is used worldwide at small startups and large enterprises.<br>RabbitMQ is lightweight and easy to deploy on premises and in the cloud. It supports multiple messaging protocols. RabbitMQ can be deployed in distributed and federated configurations to meet high-scale, high-availability requirements.<br>RabbitMQ runs on many operating systems and cloud environments, and provides a wide range of developer tools for most popular languages.<br>翻译以后：<br>RabbitMQ是部署最广泛的开源消息代理。<br>RabbitMQ拥有成千上万的用户，是最受欢迎的开源消息代理之一。从T-Mobile 到Runtastic，RabbitMQ在全球范围内的小型初创企业和大型企业中都得到使用。<br>RabbitMQ轻巧，易于在内部和云中部署。它支持多种消息传递协议。RabbitMQ可以部署在分布式和联合配置中，以满足大规模，高可用性的要求。<br>RabbitMQ可在许多操作系统和云环境上运行，并为大多数流行语言提供了广泛的开发人员工具。</p>
</blockquote>
<p>简单概述：<br>RabbitMQ是一个开源的遵循AMQP协议实现的基于Erlang语言编写，支持多种客户端（语言）。用于在分布式系统中存储消息，转发消息，具有高可用，高可扩性，易用性等特征。</p>
<h2 id="安装RabbitMQ"><a href="#安装RabbitMQ" class="headerlink" title="安装RabbitMQ"></a>安装RabbitMQ</h2><p>1：下载地址：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/download.html">https://www.rabbitmq.com/download.html</a><br>2：环境准备：CentOS7.x+ &#x2F; Erlang<br>RabbitMQ是采用Erlang语言开发的，所以系统环境必须提供Erlang环境，第一步就是安装Erlang。</p>
<blockquote>
<p>erlang和RabbitMQ版本的按照比较: <a target="_blank" rel="noopener" href="https://www.rabbitmq.com/which-erlang.html">https://www.rabbitmq.com/which-erlang.html</a><br><img src="https://img-blog.csdnimg.cn/img_convert/e28ff1f413d828e8b402dd2fe88cfc46.png" alt="img"></p>
</blockquote>
<h2 id="Erlang安装"><a href="#Erlang安装" class="headerlink" title="Erlang安装"></a>Erlang安装</h2><p>查看系统版本号</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@iZm5eauu5f1ulwtdgwqnsbZ ~]# lsb_release -aLSB </span><br><span class="line">Version:    :core-4.1-amd64:core-4.1-noarchDistributor </span><br><span class="line">ID: CentOS</span><br><span class="line">Description:    CentOS Linux </span><br><span class="line">release 8.3.2011Release:        8.3.2011</span><br><span class="line">Codename:       n/a</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p>安装下载</p>
<p>参考地址：<a target="_blank" rel="noopener" href="https://www.erlang-solutions.com/downloads/">https://www.erlang-solutions.com/downloads/</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下载</span></span><br><span class="line">wget https://packages.erlang-solutions.com/erlang-solutions-2.0-1.noarch.rpm</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装</span></span><br><span class="line">rpm -Uvh erlang-solutions-2.0-1.noarch.rpm</span><br></pre></td></tr></table></figure>

<p>安装成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y erlang</span><br></pre></td></tr></table></figure>

<p>安装成功</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">erl -v</span><br></pre></td></tr></table></figure>

<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406145001020.png" alt="image-20210406145001020"></p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406145035860.png" alt="image-20210406145035860"></p>
<h2 id="安装socat"><a href="#安装socat" class="headerlink" title="安装socat"></a>安装socat</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y socat</span><br></pre></td></tr></table></figure>

<h2 id="安装rabbitmq"><a href="#安装rabbitmq" class="headerlink" title="安装rabbitmq"></a>安装rabbitmq</h2><p>下载地址：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/download.html">https://www.rabbitmq.com/download.html</a><br><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406150225693.png" alt="image-20210406150225693"></p>
<p>下载rabbitmq</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下载</span></span><br><span class="line">wget https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.8.13/rabbitmq-server-3.8.13-1.el8.noarch.rpm</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">解压</span></span><br><span class="line">rpm -Uvh rabbitmq-server-3.8.13-1.el8.noarch.rpm</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">安装</span></span><br><span class="line">yum install rabbitmq-server -y</span><br></pre></td></tr></table></figure>

<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406150506734.png" alt="image-20210406150506734"></p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406150536421.png" alt="image-20210406150536421"></p>
<p>启动rabbitmq服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动服务&gt; systemctl start rabbitmq-server</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看服务状态&gt; systemctl status rabbitmq-server</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止服务&gt; systemctl stop rabbitmq-server</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开机自启动服务&gt; systemctl <span class="built_in">enable</span> rabbitmq-server</span></span><br></pre></td></tr></table></figure>

<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406150708940.png" alt="image-20210406150708940"></p>
<h2 id="RabbitMQ的配置"><a href="#RabbitMQ的配置" class="headerlink" title="RabbitMQ的配置"></a>RabbitMQ的配置</h2><p>RabbitMQ默认情况下有一个配置文件，定义了RabbitMQ的相关配置信息，默认情况下能够满足日常的开发需求。如果需要修改需要，需要自己创建一个配置文件进行覆盖。<br>参考官网：<br>1:<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/documentation.html">https://www.rabbitmq.com/documentation.html</a><br>2:<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/configure.html">https://www.rabbitmq.com/configure.html</a><br>3:<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/configure.html#config-items">https://www.rabbitmq.com/configure.html#config-items</a><br>4：<a target="_blank" rel="noopener" href="https://github.com/rabbitmq/rabbitmq-server/blob/add-debug-messages-to-quorum_queue_SUITE/docs/rabbitmq.conf.example">https://github.com/rabbitmq/rabbitmq-server/blob/add-debug-messages-to-quorum_queue_SUITE/docs/rabbitmq.conf.example</a></p>
<h3 id="相关端口"><a href="#相关端口" class="headerlink" title="相关端口"></a>相关端口</h3><blockquote>
<p>5672:RabbitMQ的通讯端口<br>25672:RabbitMQ的节点间的CLI通讯端口是<br>15672:RabbitMQ HTTP_API的端口，管理员用户才能访问，用于管理RabbitMQ,需要启动Management插件。<br>1883，8883：MQTT插件启动时的端口。<br>61613、61614：STOMP客户端插件启用的时候的端口。<br>15674、15675：基于webscoket的STOMP端口和MOTT端口</p>
</blockquote>
<p>一定要注意：RabbitMQ 在安装完毕</p>
<h1 id="RabbitMQWeb管理界面及授权操作"><a href="#RabbitMQWeb管理界面及授权操作" class="headerlink" title="RabbitMQWeb管理界面及授权操作"></a>RabbitMQWeb管理界面及授权操作</h1><h2 id="管理界面"><a href="#管理界面" class="headerlink" title="管理界面"></a>管理界面</h2><h3 id="默认情况下，rabbitmq是没有安装web端的客户端插件，需要安装才可以生效"><a href="#默认情况下，rabbitmq是没有安装web端的客户端插件，需要安装才可以生效" class="headerlink" title="默认情况下，rabbitmq是没有安装web端的客户端插件，需要安装才可以生效"></a>默认情况下，rabbitmq是没有安装web端的客户端插件，需要安装才可以生效</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins enable rabbitmq_management</span><br></pre></td></tr></table></figure>

<blockquote>
<p>说明：rabbitmq有一个默认账号和密码是：<code>guest</code> 默认情况只能在localhost本机下访问，所以需要添加一个远程登录的用户。</p>
</blockquote>
<h3 id="安装完毕以后，重启服务即可"><a href="#安装完毕以后，重启服务即可" class="headerlink" title="安装完毕以后，重启服务即可"></a>安装完毕以后，重启服务即可</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart rabbitmq-server</span><br></pre></td></tr></table></figure>

<blockquote>
<p>一定要记住，在对应服务器(阿里云，腾讯云等)的安全组中开放<code>15672</code>的端口。</p>
</blockquote>
<h3 id="在浏览器访问"><a href="#在浏览器访问" class="headerlink" title="在浏览器访问"></a>在浏览器访问</h3><blockquote>
<p>端口未开无法访问</p>
</blockquote>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406151853436.png" alt="image-20210406151853436"></p>
<p><a target="_blank" rel="noopener" href="http://ip:15672/">http://ip:15672/</a> 如下：<br><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406151920363.png" alt="image-20210406151920363"></p>
<blockquote>
<p>开启5672端口，后面会用到</p>
</blockquote>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406152800041.png" alt="image-20210406152800041"></p>
<h2 id="授权账号和密码"><a href="#授权账号和密码" class="headerlink" title="授权账号和密码"></a>授权账号和密码</h2><h3 id="新增用户"><a href="#新增用户" class="headerlink" title="新增用户"></a>新增用户</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl add_user admin admin</span><br></pre></td></tr></table></figure>

<h3 id="设置用户分配操作权限"><a href="#设置用户分配操作权限" class="headerlink" title="设置用户分配操作权限"></a>设置用户分配操作权限</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl set_user_tags admin administrator</span><br></pre></td></tr></table></figure>

<p>用户级别：</p>
<ul>
<li>1、administrator 可以登录控制台、查看所有信息、可以对rabbitmq进行管理</li>
<li>2、monitoring 监控者 登录控制台，查看所有信息</li>
<li>3、policymaker 策略制定者 登录控制台,指定策略</li>
<li>4、managment 普通管理员 登录控制台</li>
</ul>
<h3 id="为用户添加资源权限"><a href="#为用户添加资源权限" class="headerlink" title="为用户添加资源权限"></a>为用户添加资源权限</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl set_permissions -p / admin &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;</span><br></pre></td></tr></table></figure>

<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406154255072.png" alt="image-20210406154255072"></p>
<h2 id="小结："><a href="#小结：" class="headerlink" title="小结："></a>小结：</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl add_user 账号 密码</span><br><span class="line">rabbitmqctl set_user_tags 账号 administrator</span><br><span class="line">rabbitmqctl change_password Username Newpassword #修改密码</span><br><span class="line">rabbitmqctl delete_user Username #删除用户</span><br><span class="line">rabbitmqctl list_users #查看用户清单</span><br><span class="line">rabbitmqctl.bat set_permissions -p /用户名&quot;.*&quot; &quot;、*” &quot;.*&quot; #为用户设置administrator角色rabbitmqctl.bat set_permissions -p / root &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;</span><br></pre></td></tr></table></figure>

<h1 id="RabbitMQ之Docker安装"><a href="#RabbitMQ之Docker安装" class="headerlink" title="RabbitMQ之Docker安装"></a>RabbitMQ之Docker安装</h1><h2 id="Docker安装RabbitMQ"><a href="#Docker安装RabbitMQ" class="headerlink" title="Docker安装RabbitMQ"></a>Docker安装RabbitMQ</h2><h3 id="虚拟化容器技术—Docker的安装"><a href="#虚拟化容器技术—Docker的安装" class="headerlink" title="虚拟化容器技术—Docker的安装"></a>虚拟化容器技术—Docker的安装</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">（1）yum 包更新到最新&gt; yum update</span><br><span class="line">（2）安装需要的软件包， yum-util 提供yum-config-manager功能，另外两个是devicemapper驱动依赖的&gt; </span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line">（3）设置yum源为阿里云&gt; yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line">（4）安装docker&gt; yum install docker-ce -y</span><br><span class="line">（5）安装后查看docker版本&gt; docker -v </span><br><span class="line">(6) 安装加速镜像 sudo mkdir -p /etc/docker sudo tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27; &#123;  &quot;registry-mirrors&quot;: [&quot;https://0wrdwnn6.mirror.aliyuncs.com&quot;] &#125; EOF sudo systemctl daemon-reload sudo systemctl restart docker</span><br></pre></td></tr></table></figure>

<h3 id="docker的相关命令"><a href="#docker的相关命令" class="headerlink" title="docker的相关命令"></a>docker的相关命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动docker：</span></span><br><span class="line">systemctl start docker</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止docker：</span></span><br><span class="line">systemctl stop docker</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启docker：</span></span><br><span class="line">systemctl restart docker</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看docker状态：</span></span><br><span class="line">systemctl status docker</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开机启动：</span>  </span><br><span class="line">systemctl enable dockersystemctl unenable docker</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看docker概要信息</span></span><br><span class="line">docker info</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看docker帮助文档</span></span><br><span class="line">docker --help</span><br></pre></td></tr></table></figure>

<h3 id="安装rabbitmq-1"><a href="#安装rabbitmq-1" class="headerlink" title="安装rabbitmq"></a>安装rabbitmq</h3><p>参考网站：<br>1：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/download.html">https://www.rabbitmq.com/download.html</a><br>2：<a target="_blank" rel="noopener" href="https://registry.hub.docker.com/_/rabbitmq/">https://registry.hub.docker.com/_/rabbitmq/</a></p>
<h3 id="获取rabbit镜像："><a href="#获取rabbit镜像：" class="headerlink" title="获取rabbit镜像："></a>获取rabbit镜像：</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull rabbitmq:management</span><br></pre></td></tr></table></figure>

<h3 id="创建并运行容器"><a href="#创建并运行容器" class="headerlink" title="创建并运行容器"></a>创建并运行容器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -di --name=myrabbit -p 15672:15672 rabbitmq:management</span><br></pre></td></tr></table></figure>

<p>—hostname：指定容器主机名称<br>—name:指定容器名称<br>-p:将mq端口号映射到本地</p>
<blockquote>
<p>或者运行时设置用户和密码</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -di --name myrabbit -e RABBITMQ_DEFAULT_USER=admin -e RABBITMQ_DEFAULT_PASS=admin -p 15672:15672 -p 5672:5672 -p 25672:25672 -p 61613:61613 -p 1883:1883 rabbitmq:management</span><br></pre></td></tr></table></figure>

<p>查看正在运行容器</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure>

<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406160339849.png" alt="image-20210406160339849"></p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406160311806.png" alt="image-20210406160311806"></p>
<p>启动rabbitmq_management(图形化界面 )</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it myrabbit rabbitmq-plugins enable rabbitmq_management</span><br></pre></td></tr></table></figure>

<p>查看日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs -f myrabbit</span><br></pre></td></tr></table></figure>

<h3 id="容器运行正常"><a href="#容器运行正常" class="headerlink" title="容器运行正常"></a>容器运行正常</h3><p>使用 <code>http://你的IP地址:15672</code> 访问rabbit控制台</p>
<h2 id="额外Linux相关排查命令"><a href="#额外Linux相关排查命令" class="headerlink" title="额外Linux相关排查命令"></a>额外Linux相关排查命令</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">more xxx.log  查看日记信息</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">netstat -naop|grep 5672 查看端口是否被占用</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">ps -ef | grep 5672  查看进程</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">systemctl stop 服务</span></span><br></pre></td></tr></table></figure>

<h1 id="RabbitMQ的角色分类"><a href="#RabbitMQ的角色分类" class="headerlink" title="RabbitMQ的角色分类"></a>RabbitMQ的角色分类</h1><h2 id="RabbitMQ的角色分类-1"><a href="#RabbitMQ的角色分类-1" class="headerlink" title="RabbitMQ的角色分类"></a>RabbitMQ的角色分类</h2><h3 id="none："><a href="#none：" class="headerlink" title="none："></a>none：</h3><ul>
<li>不能访问management plugin</li>
</ul>
<h3 id="management：查看自己相关节点信息"><a href="#management：查看自己相关节点信息" class="headerlink" title="management：查看自己相关节点信息"></a>management：查看自己相关节点信息</h3><ul>
<li>列出自己可以通过AMQP登入的虚拟机</li>
<li>查看自己的虚拟机节点 virtual hosts的queues,exchanges和bindings信息</li>
<li>查看和关闭自己的channels和connections</li>
<li>查看有关自己的虚拟机节点virtual hosts的统计信息。包括其他用户在这个节点virtual hosts中的活动信息。</li>
</ul>
<h3 id="Policymaker"><a href="#Policymaker" class="headerlink" title="Policymaker"></a>Policymaker</h3><ul>
<li>包含management所有权限</li>
<li>查看和创建和删除自己的virtual hosts所属的policies和parameters信息。</li>
</ul>
<h3 id="Monitoring"><a href="#Monitoring" class="headerlink" title="Monitoring"></a>Monitoring</h3><ul>
<li>包含management所有权限</li>
<li>罗列出所有的virtual hosts，包括不能登录的virtual hosts。</li>
<li>查看其他用户的connections和channels信息</li>
<li>查看节点级别的数据如clustering和memory使用情况</li>
<li>查看所有的virtual hosts的全局统计信息。</li>
</ul>
<h3 id="Administrator"><a href="#Administrator" class="headerlink" title="Administrator"></a>Administrator</h3><ul>
<li>最高权限</li>
<li>可以创建和删除virtual hosts</li>
<li>可以查看，创建和删除users</li>
<li>查看创建permisssions</li>
<li>关闭所有用户的connections</li>
</ul>
<h3 id="具体操作的界面"><a href="#具体操作的界面" class="headerlink" title="具体操作的界面"></a>具体操作的界面</h3><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406161315892.png" alt="image-20210406161315892"></p>
<h1 id="RabbitMQ入门案例-Simple-简单模式"><a href="#RabbitMQ入门案例-Simple-简单模式" class="headerlink" title="RabbitMQ入门案例 - Simple 简单模式"></a>RabbitMQ入门案例 - Simple 简单模式</h1><h2 id="实现步骤"><a href="#实现步骤" class="headerlink" title="实现步骤"></a>实现步骤</h2><p>1：jdk1.8<br>2：构建一个maven工程<br>3：导入rabbitmq的maven依赖<br>4：启动rabbitmq-server服务<br>5：定义生产者<br>6：定义消费者<br>7：观察消息的在rabbitmq-server服务中的过程</p>
<h2 id="构建一个maven工程"><a href="#构建一个maven工程" class="headerlink" title="构建一个maven工程"></a>构建一个maven工程</h2><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406165508844.png" alt="image-20210406165508844"></p>
<h2 id="导入rabbitmq的maven依赖"><a href="#导入rabbitmq的maven依赖" class="headerlink" title="导入rabbitmq的maven依赖"></a>导入rabbitmq的maven依赖</h2><h3 id="Java原生依赖"><a href="#Java原生依赖" class="headerlink" title="Java原生依赖"></a>Java原生依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rabbitmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>amqp-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.10.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="spring依赖"><a href="#spring依赖" class="headerlink" title="spring依赖"></a>spring依赖</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.amqp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.amqp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="springboot依赖"><a href="#springboot依赖" class="headerlink" title="springboot依赖"></a>springboot依赖</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--        spring-boot--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>上面根据自己的项目环境进行选择即可。</p>
<blockquote>
<p>番外：rabbitmq和spring同属一个公司开放的产品，所以他们的支持也是非常完善，这也是为什么推荐使用rabbitmq的一个原因。</p>
</blockquote>
<h2 id="启动rabbitmq-server服务"><a href="#启动rabbitmq-server服务" class="headerlink" title="启动rabbitmq-server服务"></a>启动rabbitmq-server服务</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl start rabbitmq-server或者docker start myrabbit</span><br></pre></td></tr></table></figure>

<h2 id="定义生产者"><a href="#定义生产者" class="headerlink" title="定义生产者"></a>定义生产者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kuang.rabbitmq.simple;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ-java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Package</span>: com.kuang.rabbitmq.simple</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Producer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: FH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/4/6 16:26</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 简单队列生产者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1: 创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        <span class="comment">// 2: 设置连接属性</span></span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;39.97.166.249&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 3: 从连接工厂中获取连接</span></span><br><span class="line">            connection = connectionFactory.newConnection(<span class="string">&quot;生产者&quot;</span>);</span><br><span class="line">            <span class="comment">// 4: 从连接中获取通道channel</span></span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line">            <span class="comment">// 5: 申明队列queue存储消息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> <span class="string">&quot;queue1&quot;</span>;</span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             *  如果队列不存在，则会创建</span></span><br><span class="line"><span class="comment">             *  Rabbitmq不允许创建两个相同的队列名称，否则会报错。</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             *  @params1： queue 队列的名称</span></span><br><span class="line"><span class="comment">             *  @params2： durable 队列是否持久化</span></span><br><span class="line"><span class="comment">             *  @params3： exclusive 是否排他，即是否私有的，如果为true,会对当前队列加锁，其他的通道不能访问，并且连接自动关闭</span></span><br><span class="line"><span class="comment">             *  @params4： autoDelete 是否自动删除，当最后一个消费者断开连接之后是否自动删除消息。</span></span><br><span class="line"><span class="comment">             *  @params5： arguments 可以设置队列附加参数，设置队列的有效期，消息的最大长度，队列的消息生命周期等等。</span></span><br><span class="line"><span class="comment">             * */</span></span><br><span class="line">            channel.queueDeclare(queueName, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// 6： 准备发送消息的内容</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;你好，RabbitMQ！！！&quot;</span>;</span><br><span class="line">            <span class="comment">// 7: 发送消息给中间件rabbitmq-server</span></span><br><span class="line">            <span class="comment">// @params1: 交换机exchange</span></span><br><span class="line">            <span class="comment">// @params2: 队列名称/routing</span></span><br><span class="line">            <span class="comment">// @params3: 属性配置</span></span><br><span class="line">            <span class="comment">// @params4: 发送消息的内容</span></span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>, queueName, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;消息发送成功!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">            System.out.println(<span class="string">&quot;发送消息出现异常...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 7: 释放连接关闭通道</span></span><br><span class="line">            <span class="keyword">if</span> (channel != <span class="literal">null</span> &amp;&amp; channel.isOpen()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    channel.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>1：执行发送，这个时候可以在web控制台查看到这个队列queue的信息</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406165137438.png" alt="image-20210406165137438"></p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406165201115.png" alt="image-20210406165201115"></p>
<p>2：我们可以进行对队列的消息进行预览和测试如下：</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406165236876.png" alt="image-20210406165236876"></p>
<p>3:进行预览和获取消息进行测试</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406165308261.png" alt="image-20210406165308261"></p>
<h2 id="定义消费者"><a href="#定义消费者" class="headerlink" title="定义消费者"></a>定义消费者</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kuang.rabbitmq.simple;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ-java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Package</span>: com.kuang.rabbitmq.simple</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Consumer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: FH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/4/6 16:26</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desciption</span> 简单消费者队列</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1: 创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        <span class="comment">// 2: 设置连接属性</span></span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;39.97.166.249&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 3: 从连接工厂中获取连接</span></span><br><span class="line">            connection = connectionFactory.newConnection(<span class="string">&quot;生产者&quot;</span>);</span><br><span class="line">            <span class="comment">// 4: 从连接中获取通道channel</span></span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line"></span><br><span class="line">            channel.basicConsume(<span class="string">&quot;queue1&quot;</span>, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String consumerTag, Delivery message)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;收到的消息是：&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(message.getBody(), <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="keyword">new</span> <span class="title class_">CancelCallback</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String consumerTag)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;接受失败了&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            System.out.println(<span class="string">&quot;开始接收消息&quot;</span>);</span><br><span class="line">            System.in.read();</span><br><span class="line">            &#125; <span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">                <span class="comment">// 7: 释放连接关闭通道</span></span><br><span class="line">                <span class="keyword">if</span> (channel != <span class="literal">null</span> &amp;&amp; channel.isOpen()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        channel.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (connection != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        connection.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406171459555.png" alt="image-20210406171459555"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuexiangban.rabbitmq.simple;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span>: 学相伴-飞哥</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span>: Producer 简单队列生产者</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> : 2021/3/2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1: 创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        <span class="comment">// 2: 设置连接属性</span></span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;47.104.141.27&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 3: 从连接工厂中获取连接</span></span><br><span class="line">            connection = connectionFactory.newConnection(<span class="string">&quot;生产者&quot;</span>);</span><br><span class="line">            <span class="comment">// 4: 从连接中获取通道channel</span></span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line">            <span class="comment">// 5: 申明队列queue存储消息</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             *  如果队列不存在，则会创建</span></span><br><span class="line"><span class="comment">             *  Rabbitmq不允许创建两个相同的队列名称，否则会报错。</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             *  @params1： queue 队列的名称</span></span><br><span class="line"><span class="comment">             *  @params2： durable 队列是否持久化</span></span><br><span class="line"><span class="comment">             *  @params3： exclusive 是否排他，即是否私有的，如果为true,会对当前队列加锁，其他的通道不能访问，并且连接自动关闭</span></span><br><span class="line"><span class="comment">             *  @params4： autoDelete 是否自动删除，当最后一个消费者断开连接之后是否自动删除消息。</span></span><br><span class="line"><span class="comment">             *  @params5： arguments 可以设置队列附加参数，设置队列的有效期，消息的最大长度，队列的消息生命周期等等。</span></span><br><span class="line"><span class="comment">             * */</span></span><br><span class="line">            channel.queueDeclare(<span class="string">&quot;queue1&quot;</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// 6： 准备发送消息的内容</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;你好，学相伴！！！&quot;</span>;</span><br><span class="line">            <span class="comment">// 7: 发送消息给中间件rabbitmq-server</span></span><br><span class="line">            <span class="comment">// @params1: 交换机exchange</span></span><br><span class="line">            <span class="comment">// @params2: 队列名称/routing</span></span><br><span class="line">            <span class="comment">// @params3: 属性配置</span></span><br><span class="line">            <span class="comment">// @params4: 发送消息的内容</span></span><br><span class="line">            channel.basicPublish(<span class="string">&quot;&quot;</span>, <span class="string">&quot;queue1&quot;</span>, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;消息发送成功!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">            System.out.println(<span class="string">&quot;发送消息出现异常...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 7: 释放连接关闭通道</span></span><br><span class="line">            <span class="keyword">if</span> (channel != <span class="literal">null</span> &amp;&amp; channel.isOpen()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    channel.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="观察消息的在rabbitmq-server服务中的过程"><a href="#观察消息的在rabbitmq-server服务中的过程" class="headerlink" title="观察消息的在rabbitmq-server服务中的过程"></a>观察消息的在rabbitmq-server服务中的过程</h2><ul>
<li>具体详细视频教程</li>
</ul>
<h1 id="什么是AMQP"><a href="#什么是AMQP" class="headerlink" title="什么是AMQP"></a>什么是AMQP</h1><h2 id="什么是AMQP-1"><a href="#什么是AMQP-1" class="headerlink" title="什么是AMQP"></a>什么是AMQP</h2><p>AMQP全称：Advanced Message Queuing Protocol(高级消息队列协议)。是应用层协议的一个开发标准，为面向消息的中间件设计。</p>
<h2 id="AMQP生产者流转过程"><a href="#AMQP生产者流转过程" class="headerlink" title="AMQP生产者流转过程"></a>AMQP生产者流转过程</h2><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406180905263.png" alt="image-20210406180905263" style="zoom: 33%;" />

<blockquote>
<p>RabbitMQ为什么是基于channel（通道）去处理而不是连接？</p>
</blockquote>
<p>在使用rabbitmq时不管是消费还是生产都需要创建信道（channel） 和connection（连接），如下图producer示例。我们完全可以直接使用Connection就能完成信道的工作，为什么还要引入信道呢，试想这样一个场景，一个应用有多个线程需要从rabbitmq中消费，或是生产消息，那么必然会建立很多个connection ,也就是多个tcp连接，对操作系统而言，建立和销毁tcp连接是很昂贵的开销，如果遇到使用高峰，性能瓶颈也随之显现，rabbitmq采用类似nio的做法，连接tcp连接复用，不仅可以减少性能开销，同时也便于管理。</p>
<p>每个线程都把持一个信道，所以信道复用了TCP连接。同时rabbitmq可以确保每个线程的私密性，就像拥有独立的连接一样。当每个信道的流量不是很大时，复用单一的connection可以再产生性能瓶颈的情况下有效地节省tcp连接资源，但是当信道本身的流量很大时，这时候多个信道复用一个connection就会产生性能瓶颈，进而是整体的流量被限制了。此时就需要开辟多个connection，将这些信道均摊到这些connection中，至于这些相关调优策略需要根据业务自身的实际情况进行调节。</p>
<h2 id="AMQP消费者流转过程"><a href="#AMQP消费者流转过程" class="headerlink" title="AMQP消费者流转过程"></a>AMQP消费者流转过程</h2><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406180931720.png" alt="image-20210406180931720" style="zoom: 50%;" />

<h1 id="RabbitMQ的核心组成部分"><a href="#RabbitMQ的核心组成部分" class="headerlink" title="RabbitMQ的核心组成部分"></a>RabbitMQ的核心组成部分</h1><h2 id="RabbitMQ的核心组成部分-1"><a href="#RabbitMQ的核心组成部分-1" class="headerlink" title="RabbitMQ的核心组成部分"></a>RabbitMQ的核心组成部分</h2><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406191550679.png" alt="image-20210406191550679"></p>
<p>核心概念：<br><strong>Server</strong>：又称Broker ,接受客户端的连接，实现AMQP实体服务。 安装rabbitmq-server<br><strong>Connection</strong>：连接，应用程序与Broker的网络连接 TCP&#x2F;IP&#x2F; 三次握手和四次挥手<br><strong>Channel</strong>：网络信道，几乎所有的操作都在Channel中进行，Channel是进行消息读写的通道，客户端可以建立对各Channel，每个Channel代表一个会话任务。<br><strong>Message</strong> :消息：服务与应用程序之间传送的数据，由Properties和body组成，Properties可是对消息进行修饰，比如消息的优先级，延迟等高级特性，Body则就是消息体的内容。<br><strong>Virtual Host</strong> 虚拟地址，用于进行逻辑隔离，最上层的消息路由，一个虚拟主机理由可以有若干个Exhange和Queueu，同一个虚拟主机里面不能有相同名字的Exchange<br><strong>Exchange</strong>：交换机，接受消息，根据路由键发送消息到绑定的队列。<strong>不指定会默认有</strong>(不具备消息存储的能力)<br><strong>Bindings</strong>：Exchange和Queue之间的虚拟连接，binding中可以保护多个routing key.<br><strong>Routing key</strong>：是一个路由规则，虚拟机可以用它来确定如何路由一个特定消息。<br><strong>Queue</strong>：队列：也成为Message Queue,消息队列，保存消息并将它们转发给消费者。</p>
<h2 id="RabbitMQ整体架构是什么样子的？"><a href="#RabbitMQ整体架构是什么样子的？" class="headerlink" title="RabbitMQ整体架构是什么样子的？"></a>RabbitMQ整体架构是什么样子的？</h2><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406192030159.png" alt="image-20210406192030159"></p>
<h2 id="RabbitMQ的运行流程"><a href="#RabbitMQ的运行流程" class="headerlink" title="RabbitMQ的运行流程"></a>RabbitMQ的运行流程</h2><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406192239080.png" alt="image-20210406192239080"></p>
<h2 id="RabbitMQ支持消息的模式"><a href="#RabbitMQ支持消息的模式" class="headerlink" title="RabbitMQ支持消息的模式"></a>RabbitMQ支持消息的模式</h2><p>参考官网：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/getstarted.html">https://www.rabbitmq.com/getstarted.html</a></p>
<h3 id="简单模式-Simple"><a href="#简单模式-Simple" class="headerlink" title="简单模式 Simple"></a>简单模式 Simple</h3><ul>
<li>参考第12章节</li>
</ul>
<h3 id="工作模式-Work"><a href="#工作模式-Work" class="headerlink" title="工作模式 Work"></a>工作模式 Work</h3><ul>
<li>web操作查看视频</li>
<li>类型：无</li>
<li>特点：分发机制</li>
</ul>
<h3 id="发布订阅模式"><a href="#发布订阅模式" class="headerlink" title="发布订阅模式"></a>发布订阅模式</h3><ul>
<li>web操作查看视频</li>
<li>类型：fanout</li>
<li>特点：Fanout—发布与订阅模式，是一种广播机制，它是<strong>没有路由key的模式</strong>。</li>
</ul>
<h3 id="路由模式"><a href="#路由模式" class="headerlink" title="路由模式"></a>路由模式</h3><ul>
<li>web操作查看视频</li>
<li>类型：direct</li>
<li>特点：有routing-key的匹配模式</li>
</ul>
<h3 id="主题Topic模式"><a href="#主题Topic模式" class="headerlink" title="主题Topic模式"></a>主题Topic模式</h3><ul>
<li>web操作查看视频</li>
<li>类型：topic</li>
<li>特点：模糊的routing-key的匹配模式</li>
</ul>
<h3 id="参数模式"><a href="#参数模式" class="headerlink" title="参数模式"></a>参数模式</h3><ul>
<li>web操作查看视频</li>
<li>类型：headers</li>
<li>特点：参数匹配模式</li>
</ul>
<h2 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h2><ul>
<li>rabbitmq发送消息一定有一个交换机</li>
<li>如果队列没有指定交换机会默认绑定一个交换机<br><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406192521053.png" alt="image-20210406192521053"></li>
</ul>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406192532532.png" alt="image-20210406192532532"></p>
<h1 id="RabbitMQ入门案例-四大模式"><a href="#RabbitMQ入门案例-四大模式" class="headerlink" title="RabbitMQ入门案例-四大模式"></a>RabbitMQ入门案例-四大模式</h1><h2 id="RabbitMQ入门案例-fanout模式"><a href="#RabbitMQ入门案例-fanout模式" class="headerlink" title="RabbitMQ入门案例 - fanout模式"></a>RabbitMQ入门案例 - fanout模式</h2><p>参考官网：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/getstarted.html">https://www.rabbitmq.com/getstarted.html</a></p>
<h3 id="RabbitMQ的模式之发布订阅模式"><a href="#RabbitMQ的模式之发布订阅模式" class="headerlink" title="RabbitMQ的模式之发布订阅模式"></a>RabbitMQ的模式之发布订阅模式</h3><p>&#x3D;&#x3D;特点：Fanout—发布与订阅模式，是一种广播机制，它是没有路由key的模式。&#x3D;&#x3D;</p>
<h4 id="图解"><a href="#图解" class="headerlink" title="图解"></a>图解</h4><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406195137846.png" alt="image-20210406195137846"></p>
<h3 id="发布订阅模式web端实现"><a href="#发布订阅模式web端实现" class="headerlink" title="发布订阅模式web端实现"></a>发布订阅模式web端实现</h3><blockquote>
<p>建立交换机</p>
</blockquote>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406195343336.png" alt="image-20210406195343336"></p>
<blockquote>
<p>创建3个队列</p>
</blockquote>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406195610243.png" alt="image-20210406195610243"></p>
<blockquote>
<p>为队列绑定交换机</p>
</blockquote>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406195750242.png" alt="image-20210406195750242"></p>
<blockquote>
<p>发布消息</p>
</blockquote>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406195915214.png" alt="image-20210406195915214"></p>
<blockquote>
<p>接收message  queue2 和queue3也可以接收到</p>
</blockquote>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406200231666.png" alt="image-20210406200231666"></p>
<h3 id="发布订阅模式代码实现"><a href="#发布订阅模式代码实现" class="headerlink" title="发布订阅模式代码实现"></a>发布订阅模式代码实现</h3><h4 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h4><blockquote>
<p>代码没有进行 交换机和队列绑定，因为此处用的web界面进行的绑定</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kuang.rabbitmq.simple;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ-java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Package</span>: com.kuang.rabbitmq.simple</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Producer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: FH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/4/6 16:26</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> fanout模式生产(发布订阅模式)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1: 创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        <span class="comment">// 2: 设置连接属性</span></span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;39.97.166.249&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 3: 从连接工厂中获取连接</span></span><br><span class="line">            connection = connectionFactory.newConnection(<span class="string">&quot;生产者&quot;</span>);</span><br><span class="line">            <span class="comment">// 4: 从连接中获取通道channel</span></span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 6： 准备发送消息的内容</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;fanout-exchange&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">routeKey</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;你好，RabbitMQ！！！&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> <span class="string">&quot;fanout&quot;</span>;</span><br><span class="line">            <span class="comment">// 7: 发送消息给中间件rabbitmq-server</span></span><br><span class="line">            <span class="comment">// @params1: 交换机exchange</span></span><br><span class="line">            <span class="comment">// @params2: 队列名称/routing</span></span><br><span class="line">            <span class="comment">// @params3: 属性配置</span></span><br><span class="line">            <span class="comment">// @params4: 发送消息的内容</span></span><br><span class="line">            channel.basicPublish(exchangeName, routeKey, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;消息发送成功!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">            System.out.println(<span class="string">&quot;发送消息出现异常...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 7: 释放连接关闭通道</span></span><br><span class="line">            <span class="keyword">if</span> (channel != <span class="literal">null</span> &amp;&amp; channel.isOpen()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    channel.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h4><blockquote>
<p>一旦消费，就可看为全部出队</p>
</blockquote>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407095427057.png" alt="image-20210407095427057"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kuang.rabbitmq.simple;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.PushbackInputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ-java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Package</span>: com.kuang.rabbitmq.simple</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Consumer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: FH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/4/6 16:26</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desciption</span> fanout模式消费</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// 1: 创建连接工厂</span></span><br><span class="line">            <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">            <span class="comment">// 2: 设置连接属性</span></span><br><span class="line">            connectionFactory.setHost(<span class="string">&quot;39.97.166.249&quot;</span>);</span><br><span class="line">            connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">            connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">            connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">            connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">            <span class="comment">//获取队列的名称</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> Thread.currentThread().getName();</span><br><span class="line">            <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 3: 从连接工厂中获取连接</span></span><br><span class="line">                connection = connectionFactory.newConnection(<span class="string">&quot;生产者&quot;</span>);</span><br><span class="line">                <span class="comment">// 4: 从连接中获取通道channel</span></span><br><span class="line">                channel = connection.createChannel();</span><br><span class="line">                <span class="comment">// 5: 申明队列queue存储消息</span></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 *  如果队列不存在，则会创建</span></span><br><span class="line"><span class="comment">                 *  Rabbitmq不允许创建两个相同的队列名称，否则会报错。</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 *  @params1： queue 队列的名称</span></span><br><span class="line"><span class="comment">                 *  @params2： durable 队列是否持久化</span></span><br><span class="line"><span class="comment">                 *  @params3： exclusive 是否排他，即是否私有的，如果为true,会对当前队列加锁，其他的通道不能访问，并且连接自动关闭</span></span><br><span class="line"><span class="comment">                 *  @params4： autoDelete 是否自动删除，当最后一个消费者断开连接之后是否自动删除消息。</span></span><br><span class="line"><span class="comment">                 *  @params5： arguments 可以设置队列附加参数，设置队列的有效期，消息的最大长度，队列的消息生命周期等等。</span></span><br><span class="line"><span class="comment">                 * */</span></span><br><span class="line">                <span class="comment">// 这里如果queue已经被创建过一次了，可以不需要定义</span></span><br><span class="line">                <span class="comment">//channel.queueDeclare(&quot;queue1&quot;, false, false, false, null);</span></span><br><span class="line">                <span class="comment">// 6： 定义接受消息的回调</span></span><br><span class="line">                <span class="type">Channel</span> <span class="variable">finalChannel</span> <span class="operator">=</span> channel;</span><br><span class="line">                finalChannel.basicConsume(queueName, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                        System.out.println(queueName + <span class="string">&quot;：收到消息是：&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="keyword">new</span> <span class="title class_">CancelCallback</span>() &#123;</span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                System.out.println(queueName + <span class="string">&quot;：开始接受消息&quot;</span>);</span><br><span class="line">                System.in.read();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">                System.out.println(<span class="string">&quot;发送消息出现异常...&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 7: 释放连接关闭通道</span></span><br><span class="line">                <span class="keyword">if</span> (channel != <span class="literal">null</span> &amp;&amp; channel.isOpen()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        channel.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (connection != <span class="literal">null</span> &amp;&amp; connection.isOpen()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        connection.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 启动三个线程去执行</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable, <span class="string">&quot;queue1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable, <span class="string">&quot;queue2&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable, <span class="string">&quot;queue3&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RabbitMQ入门案例-Direct模式"><a href="#RabbitMQ入门案例-Direct模式" class="headerlink" title="RabbitMQ入门案例 - Direct模式"></a>RabbitMQ入门案例 - Direct模式</h2><p>参考官网：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/getstarted.html">https://www.rabbitmq.com/getstarted.html</a></p>
<h3 id="RabbitMQ的模式之Direct模式"><a href="#RabbitMQ的模式之Direct模式" class="headerlink" title="RabbitMQ的模式之Direct模式"></a>RabbitMQ的模式之Direct模式</h3><p>&#x3D;&#x3D;特点：Direct模式是fanout模式上的一种叠加，增加了路由RoutingKey的模式。&#x3D;&#x3D;</p>
<h4 id="图解-1"><a href="#图解-1" class="headerlink" title="图解"></a>图解</h4><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406201443205.png" alt="image-20210406201443205"></p>
<h3 id="发布订阅模式web端实现-1"><a href="#发布订阅模式web端实现-1" class="headerlink" title="发布订阅模式web端实现"></a>发布订阅模式web端实现</h3><blockquote>
<p>建立交换机   类型：direct</p>
</blockquote>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406201718486.png" alt="image-20210406201718486"></p>
<blockquote>
<p>创建队列    用上面建立的三个</p>
</blockquote>
<blockquote>
<p>队列  -绑定- 交换机</p>
</blockquote>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406202300017.png" alt="image-20210406202300017"></p>
<blockquote>
<p>发送消息</p>
</blockquote>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406202421943.png" alt="image-20210406202421943"></p>
<blockquote>
<p>接收消息</p>
</blockquote>
<p>&#x3D;&#x3D;queue1里有email路由，故而有direct message&#x3D;&#x3D;</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406202555229.png" alt="image-20210406202555229"></p>
<p>&#x3D;&#x3D;queue2里没有email路由，没有direct message&#x3D;&#x3D;</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406202914027.png" alt="image-20210406202914027"></p>
<h3 id="发布订阅模式代码实现-1"><a href="#发布订阅模式代码实现-1" class="headerlink" title="发布订阅模式代码实现"></a>发布订阅模式代码实现</h3><h4 id="生产者-1"><a href="#生产者-1" class="headerlink" title="生产者"></a>生产者</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kuang.rabbitmq.direct;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ-java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Package</span>: com.kuang.rabbitmq.simple</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Producer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: FH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/4/6 16:26</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 路由模式队列生产者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1: 创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        <span class="comment">// 2: 设置连接属性</span></span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;39.97.166.249&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 3: 从连接工厂中获取连接</span></span><br><span class="line">            connection = connectionFactory.newConnection(<span class="string">&quot;生产者&quot;</span>);</span><br><span class="line">            <span class="comment">// 4: 从连接中获取通道channel</span></span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 6： 准备发送消息的内容</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;direct_exchange&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">routeKey</span> <span class="operator">=</span> <span class="string">&quot;email&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;你好，RabbitMQ！！！&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> <span class="string">&quot;direct&quot;</span>;</span><br><span class="line">            <span class="comment">// 7: 发送消息给中间件rabbitmq-server</span></span><br><span class="line">            <span class="comment">// @params1: 交换机exchange</span></span><br><span class="line">            <span class="comment">// @params2: 队列名称/routing</span></span><br><span class="line">            <span class="comment">// @params3: 属性配置</span></span><br><span class="line">            <span class="comment">// @params4: 发送消息的内容</span></span><br><span class="line">            channel.basicPublish(exchangeName, routeKey, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;消息发送成功!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">            System.out.println(<span class="string">&quot;发送消息出现异常...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 7: 释放连接关闭通道</span></span><br><span class="line">            <span class="keyword">if</span> (channel != <span class="literal">null</span> &amp;&amp; channel.isOpen()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    channel.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="消费者-1"><a href="#消费者-1" class="headerlink" title="消费者"></a>消费者</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kuang.rabbitmq.direct;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ-java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Package</span>: com.kuang.rabbitmq.simple</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Consumer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: FH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/4/6 16:26</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desciption</span> 路由模式消费者队列</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// 1: 创建连接工厂</span></span><br><span class="line">            <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">            <span class="comment">// 2: 设置连接属性</span></span><br><span class="line">            connectionFactory.setHost(<span class="string">&quot;39.97.166.249&quot;</span>);</span><br><span class="line">            connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">            connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">            connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">            connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">            <span class="comment">//获取队列的名称</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> Thread.currentThread().getName();</span><br><span class="line">            <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 3: 从连接工厂中获取连接</span></span><br><span class="line">                connection = connectionFactory.newConnection(<span class="string">&quot;生产者&quot;</span>);</span><br><span class="line">                <span class="comment">// 4: 从连接中获取通道channel</span></span><br><span class="line">                channel = connection.createChannel();</span><br><span class="line">                <span class="comment">// 5: 申明队列queue存储消息</span></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 *  如果队列不存在，则会创建</span></span><br><span class="line"><span class="comment">                 *  Rabbitmq不允许创建两个相同的队列名称，否则会报错。</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 *  @params1： queue 队列的名称</span></span><br><span class="line"><span class="comment">                 *  @params2： durable 队列是否持久化</span></span><br><span class="line"><span class="comment">                 *  @params3： exclusive 是否排他，即是否私有的，如果为true,会对当前队列加锁，其他的通道不能访问，并且连接自动关闭</span></span><br><span class="line"><span class="comment">                 *  @params4： autoDelete 是否自动删除，当最后一个消费者断开连接之后是否自动删除消息。</span></span><br><span class="line"><span class="comment">                 *  @params5： arguments 可以设置队列附加参数，设置队列的有效期，消息的最大长度，队列的消息生命周期等等。</span></span><br><span class="line"><span class="comment">                 * */</span></span><br><span class="line">                <span class="comment">// 这里如果queue已经被创建过一次了，可以不需要定义</span></span><br><span class="line">                <span class="comment">//channel.queueDeclare(&quot;queue1&quot;, false, false, false, null);</span></span><br><span class="line">                <span class="comment">// 6： 定义接受消息的回调</span></span><br><span class="line">                <span class="type">Channel</span> <span class="variable">finalChannel</span> <span class="operator">=</span> channel;</span><br><span class="line">                finalChannel.basicConsume(queueName, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                        System.out.println(queueName + <span class="string">&quot;：收到消息是：&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="keyword">new</span> <span class="title class_">CancelCallback</span>() &#123;</span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                System.out.println(queueName + <span class="string">&quot;：开始接受消息&quot;</span>);</span><br><span class="line">                System.in.read();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">                System.out.println(<span class="string">&quot;发送消息出现异常...&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 7: 释放连接关闭通道</span></span><br><span class="line">                <span class="keyword">if</span> (channel != <span class="literal">null</span> &amp;&amp; channel.isOpen()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        channel.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (connection != <span class="literal">null</span> &amp;&amp; connection.isOpen()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        connection.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 启动三个线程去执行</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable, <span class="string">&quot;queue1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable, <span class="string">&quot;queue2&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable, <span class="string">&quot;queue3&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RabbitMQ入门案例-Topic模式"><a href="#RabbitMQ入门案例-Topic模式" class="headerlink" title="RabbitMQ入门案例 - Topic模式"></a>RabbitMQ入门案例 - Topic模式</h2><p>参考官网：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/getstarted.html">https://www.rabbitmq.com/getstarted.html</a></p>
<h3 id="RabbitMQ的模式之Topic模式"><a href="#RabbitMQ的模式之Topic模式" class="headerlink" title="RabbitMQ的模式之Topic模式"></a>RabbitMQ的模式之Topic模式</h3><p>&#x3D;&#x3D;特点：Topic模式是direct模式上的一种叠加，增加了模糊路由RoutingKey的模式。&#x3D;&#x3D;</p>
<h4 id="图解-2"><a href="#图解-2" class="headerlink" title="图解"></a>图解</h4><p><img src="https://img-blog.csdnimg.cn/img_convert/8afd6cf7c2bc96338d45dce37aa2abd9.png" alt="img"></p>
<h3 id="主题模式web端实现"><a href="#主题模式web端实现" class="headerlink" title="主题模式web端实现"></a>主题模式web端实现</h3><blockquote>
<p>创建交换机</p>
</blockquote>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406203924937.png" alt="image-20210406203924937"></p>
<blockquote>
<p>创建队列</p>
</blockquote>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406204026498.png" alt="image-20210406204026498"></p>
<blockquote>
<p>交换机 - 绑定- 队列  #代表0个或一个或多个；  *代表有且只能有一个   .用来隔开，进行判定前后分别有几个</p>
</blockquote>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406204221227.png" alt="image-20210406204221227"></p>
<blockquote>
<p>发送消息</p>
</blockquote>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406205342685.png" alt="image-20210406205342685"></p>
<p>&#x3D;&#x3D;接收前&#x3D;&#x3D;</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406205108834.png" alt="image-20210406205108834"></p>
<blockquote>
<p>接收消息</p>
</blockquote>
<p>&#x3D;&#x3D;接收后&#x3D;&#x3D;</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406205504306.png" alt="image-20210406205504306"></p>
<h3 id="主题模式代码实现"><a href="#主题模式代码实现" class="headerlink" title="主题模式代码实现"></a>主题模式代码实现</h3><h4 id="生产者-2"><a href="#生产者-2" class="headerlink" title="生产者"></a>生产者</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kuang.rabbitmq.topics;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ-java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Package</span>: com.kuang.rabbitmq.simple</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Producer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: FH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/4/6 16:26</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 主题模式队列生产者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1: 创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        <span class="comment">// 2: 设置连接属性</span></span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;39.97.166.249&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 3: 从连接工厂中获取连接</span></span><br><span class="line">            connection = connectionFactory.newConnection(<span class="string">&quot;生产者&quot;</span>);</span><br><span class="line">            <span class="comment">// 4: 从连接中获取通道channel</span></span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 6： 准备发送消息的内容</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;topic_exchange&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">routeKey</span> <span class="operator">=</span> <span class="string">&quot;com.course.user.order&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;你好，RabbitMQ！！！&quot;</span>;</span><br><span class="line">            <span class="type">String</span> <span class="variable">type</span> <span class="operator">=</span> <span class="string">&quot;topic&quot;</span>;</span><br><span class="line">            <span class="comment">// 7: 发送消息给中间件rabbitmq-server</span></span><br><span class="line">            <span class="comment">// @params1: 交换机exchange</span></span><br><span class="line">            <span class="comment">// @params2: 队列名称/routing</span></span><br><span class="line">            <span class="comment">// @params3: 属性配置</span></span><br><span class="line">            <span class="comment">// @params4: 发送消息的内容</span></span><br><span class="line">            channel.basicPublish(exchangeName, routeKey, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;消息发送成功!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">            System.out.println(<span class="string">&quot;发送消息出现异常...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 7: 释放连接关闭通道</span></span><br><span class="line">            <span class="keyword">if</span> (channel != <span class="literal">null</span> &amp;&amp; channel.isOpen()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    channel.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="消费者-2"><a href="#消费者-2" class="headerlink" title="消费者"></a>消费者</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kuang.rabbitmq.topics;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ-java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Package</span>: com.kuang.rabbitmq.simple</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Consumer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: FH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/4/6 16:26</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desciption</span> 主题模式消费者队列</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// 1: 创建连接工厂</span></span><br><span class="line">            <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">            <span class="comment">// 2: 设置连接属性</span></span><br><span class="line">            connectionFactory.setHost(<span class="string">&quot;39.97.166.249&quot;</span>);</span><br><span class="line">            connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">            connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">            connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">            connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">            <span class="comment">//获取队列的名称</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> Thread.currentThread().getName();</span><br><span class="line">            <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 3: 从连接工厂中获取连接</span></span><br><span class="line">                connection = connectionFactory.newConnection(<span class="string">&quot;生产者&quot;</span>);</span><br><span class="line">                <span class="comment">// 4: 从连接中获取通道channel</span></span><br><span class="line">                channel = connection.createChannel();</span><br><span class="line">                <span class="comment">// 5: 申明队列queue存储消息</span></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 *  如果队列不存在，则会创建</span></span><br><span class="line"><span class="comment">                 *  Rabbitmq不允许创建两个相同的队列名称，否则会报错。</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 *  @params1： queue 队列的名称</span></span><br><span class="line"><span class="comment">                 *  @params2： durable 队列是否持久化</span></span><br><span class="line"><span class="comment">                 *  @params3： exclusive 是否排他，即是否私有的，如果为true,会对当前队列加锁，其他的通道不能访问，并且连接自动关闭</span></span><br><span class="line"><span class="comment">                 *  @params4： autoDelete 是否自动删除，当最后一个消费者断开连接之后是否自动删除消息。</span></span><br><span class="line"><span class="comment">                 *  @params5： arguments 可以设置队列附加参数，设置队列的有效期，消息的最大长度，队列的消息生命周期等等。</span></span><br><span class="line"><span class="comment">                 * */</span></span><br><span class="line">                <span class="comment">// 这里如果queue已经被创建过一次了，可以不需要定义</span></span><br><span class="line">                <span class="comment">//channel.queueDeclare(&quot;queue1&quot;, false, false, false, null);</span></span><br><span class="line">                <span class="comment">// 6： 定义接受消息的回调</span></span><br><span class="line">                <span class="type">Channel</span> <span class="variable">finalChannel</span> <span class="operator">=</span> channel;</span><br><span class="line">                finalChannel.basicConsume(queueName, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                        System.out.println(queueName + <span class="string">&quot;：收到消息是：&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="keyword">new</span> <span class="title class_">CancelCallback</span>() &#123;</span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                System.out.println(queueName + <span class="string">&quot;：开始接受消息&quot;</span>);</span><br><span class="line">                System.in.read();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">                System.out.println(<span class="string">&quot;发送消息出现异常...&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 7: 释放连接关闭通道</span></span><br><span class="line">                <span class="keyword">if</span> (channel != <span class="literal">null</span> &amp;&amp; channel.isOpen()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        channel.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (connection != <span class="literal">null</span> &amp;&amp; connection.isOpen()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        connection.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 启动三个线程去执行</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable, <span class="string">&quot;queue1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable, <span class="string">&quot;queue2&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable, <span class="string">&quot;queue3&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable, <span class="string">&quot;queue4&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="RabbitMQ入门案例-Headers模式"><a href="#RabbitMQ入门案例-Headers模式" class="headerlink" title="RabbitMQ入门案例 - Headers模式"></a>RabbitMQ入门案例 - Headers模式</h2><p>web端实现</p>
<blockquote>
<p>创建交换机</p>
</blockquote>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406212558013.png" alt="image-20210406212558013"></p>
<blockquote>
<p>使用上面的队列</p>
</blockquote>
<blockquote>
<p>交换机 -绑定- 队列</p>
</blockquote>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406212729952.png" alt="image-20210406212729952"></p>
<blockquote>
<p>发送消息</p>
</blockquote>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406213203552.png" alt="image-20210406213203552"></p>
<p>&#x3D;&#x3D;发送前&#x3D;&#x3D;</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406212828093.png" alt="image-20210406212828093"></p>
<blockquote>
<p>接收消息</p>
</blockquote>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210406213237436.png" alt="image-20210406213237436"></p>
<h1 id="RabbitMQ-四大模式代码完整实现"><a href="#RabbitMQ-四大模式代码完整实现" class="headerlink" title="RabbitMQ-四大模式代码完整实现"></a>RabbitMQ-四大模式代码完整实现</h1><blockquote>
<p>生产者</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kuang.rabbitmq.all;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ-java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Package</span>: com.kuang.rabbitmq.simple</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Producer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: FH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/4/6 16:26</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 路由模式队列生产者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1: 创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        <span class="comment">// 2: 设置连接属性</span></span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;39.97.166.249&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 3: 从连接工厂中获取连接</span></span><br><span class="line">            connection = connectionFactory.newConnection(<span class="string">&quot;生产者&quot;</span>);</span><br><span class="line">            <span class="comment">// 4: 从连接中获取通道channel</span></span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 6： 准备发送消息的内容</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="string">&quot;你好，RabbitMQ！！！&quot;</span>;</span><br><span class="line"></span><br><span class="line">            <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;direct_order_exchange&quot;</span>;</span><br><span class="line"><span class="comment">//            String routeKey = &quot;&quot;;</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">exchangeType</span> <span class="operator">=</span> <span class="string">&quot;direct&quot;</span>;</span><br><span class="line">            <span class="comment">// 7: 发送消息给中间件rabbitmq-server</span></span><br><span class="line">            <span class="comment">// @params1: 交换机exchange</span></span><br><span class="line">            <span class="comment">// @params2: 队列名称/routing</span></span><br><span class="line">            <span class="comment">// @params3: 属性配置</span></span><br><span class="line">            <span class="comment">// @params4: 发送消息的内容</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//            声明交换机</span></span><br><span class="line">            <span class="comment">//名称，类型，持久化</span></span><br><span class="line">            channel.exchangeDeclare(exchangeName,exchangeType,<span class="literal">true</span>);</span><br><span class="line"><span class="comment">//          声明队列 名称 持久化 排他性 自动删除 参数</span></span><br><span class="line">            channel.queueDeclare(<span class="string">&quot;queue5&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">            channel.queueDeclare(<span class="string">&quot;queue6&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line">            channel.queueDeclare(<span class="string">&quot;queue7&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br><span class="line"><span class="comment">//          绑定队列</span></span><br><span class="line">            channel.queueBind(<span class="string">&quot;queue5&quot;</span>,exchangeName,<span class="string">&quot;order&quot;</span>);</span><br><span class="line">            channel.queueBind(<span class="string">&quot;queue6&quot;</span>,exchangeName,<span class="string">&quot;order&quot;</span>);</span><br><span class="line">            channel.queueBind(<span class="string">&quot;queue7&quot;</span>,exchangeName,<span class="string">&quot;course&quot;</span>);</span><br><span class="line"></span><br><span class="line">            channel.basicPublish(exchangeName, <span class="string">&quot;order&quot;</span>, <span class="literal">null</span>, message.getBytes());</span><br><span class="line">            System.out.println(<span class="string">&quot;消息发送成功!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">            System.out.println(<span class="string">&quot;发送消息出现异常...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 7: 释放连接关闭通道</span></span><br><span class="line">            <span class="keyword">if</span> (channel != <span class="literal">null</span> &amp;&amp; channel.isOpen()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    channel.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407103942848.png" alt="image-20210407103942848"></p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407104003053.png" alt="image-20210407104003053"></p>
<img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407104037139.png" alt="image-20210407104037139" style="zoom:50%;" />

<blockquote>
<p>生产者</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kuang.rabbitmq.all;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: RabbitMQ-java</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Package</span>: com.kuang.rabbitmq.simple</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: Consumer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: FH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/4/6 16:26</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@desciption</span> 路由模式消费者队列</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// 1: 创建连接工厂</span></span><br><span class="line">            <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">            <span class="comment">// 2: 设置连接属性</span></span><br><span class="line">            connectionFactory.setHost(<span class="string">&quot;39.97.166.249&quot;</span>);</span><br><span class="line">            connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">            connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">            connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">            connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">            <span class="comment">//获取队列的名称</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">String</span> <span class="variable">queueName</span> <span class="operator">=</span> Thread.currentThread().getName();</span><br><span class="line">            <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 3: 从连接工厂中获取连接</span></span><br><span class="line">                connection = connectionFactory.newConnection(<span class="string">&quot;消费者&quot;</span>);</span><br><span class="line">                <span class="comment">// 4: 从连接中获取通道channel</span></span><br><span class="line">                channel = connection.createChannel();</span><br><span class="line">                <span class="comment">// 5: 申明队列queue存储消息</span></span><br><span class="line">                <span class="comment">/*</span></span><br><span class="line"><span class="comment">                 *  如果队列不存在，则会创建</span></span><br><span class="line"><span class="comment">                 *  Rabbitmq不允许创建两个相同的队列名称，否则会报错。</span></span><br><span class="line"><span class="comment">                 *</span></span><br><span class="line"><span class="comment">                 *  @params1： queue 队列的名称</span></span><br><span class="line"><span class="comment">                 *  @params2： durable 队列是否持久化</span></span><br><span class="line"><span class="comment">                 *  @params3： exclusive 是否排他，即是否私有的，如果为true,会对当前队列加锁，其他的通道不能访问，并且连接自动关闭</span></span><br><span class="line"><span class="comment">                 *  @params4： autoDelete 是否自动删除，当最后一个消费者断开连接之后是否自动删除消息。</span></span><br><span class="line"><span class="comment">                 *  @params5： arguments 可以设置队列附加参数，设置队列的有效期，消息的最大长度，队列的消息生命周期等等。</span></span><br><span class="line"><span class="comment">                 * */</span></span><br><span class="line">                <span class="comment">// 这里如果queue已经被创建过一次了，可以不需要定义</span></span><br><span class="line">                <span class="comment">//channel.queueDeclare(&quot;queue1&quot;, false, false, false, null);</span></span><br><span class="line">                <span class="comment">// 6： 定义接受消息的回调</span></span><br><span class="line">                <span class="type">Channel</span> <span class="variable">finalChannel</span> <span class="operator">=</span> channel;</span><br><span class="line">                finalChannel.basicConsume(queueName, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                        System.out.println(queueName + <span class="string">&quot;：收到消息是：&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;, <span class="keyword">new</span> <span class="title class_">CancelCallback</span>() &#123;</span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                System.out.println(queueName + <span class="string">&quot;：开始接受消息&quot;</span>);</span><br><span class="line">                System.in.read();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                ex.printStackTrace();</span><br><span class="line">                System.out.println(<span class="string">&quot;发送消息出现异常...&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 7: 释放连接关闭通道</span></span><br><span class="line">                <span class="keyword">if</span> (channel != <span class="literal">null</span> &amp;&amp; channel.isOpen()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        channel.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (connection != <span class="literal">null</span> &amp;&amp; connection.isOpen()) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        connection.close();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 启动三个线程去执行</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable, <span class="string">&quot;queue5&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable, <span class="string">&quot;queue6&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable, <span class="string">&quot;queue7&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407104226459.png" alt="image-20210407104226459" style="zoom: 50%;" />

<blockquote>
<p>注：交换机，队列，绑定在生产者处或消费者处声明皆可</p>
</blockquote>
<h1 id="RabbitMQ入门案例-Work模式"><a href="#RabbitMQ入门案例-Work模式" class="headerlink" title="RabbitMQ入门案例 - Work模式"></a>RabbitMQ入门案例 - Work模式</h1><p>参考官网：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/getstarted.html">https://www.rabbitmq.com/getstarted.html</a></p>
<h2 id="Work模式轮询模式（Round-Robin）"><a href="#Work模式轮询模式（Round-Robin）" class="headerlink" title="Work模式轮询模式（Round-Robin）"></a>Work模式轮询模式（Round-Robin）</h2><h3 id="图解-3"><a href="#图解-3" class="headerlink" title="图解"></a>图解</h3><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407144600455.png" alt="image-20210407144600455"></p>
<p>当有多个消费者时，我们的消息会被哪个消费者消费呢，我们又该如何均衡消费者消费信息的多少呢?<br>主要有两种模式：<br><strong>1、轮询模式</strong>的分发：一个消费者一条，<strong>按均分配</strong>；<br>2、<strong>公平分发</strong>：根据消费者的消费能力进行公平分发，处理快的处理的多，处理慢的处理的少；<strong>按劳分配</strong>；</p>
<ul>
<li>类型：无</li>
<li>特点：该模式接收消息是当有多个消费者接入时，消息的分配模式是一个消费者分配一条，直至消息消费完成；</li>
</ul>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><h4 id="生产者-3"><a href="#生产者-3" class="headerlink" title="生产者"></a>生产者</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kuang.rabbitmq.work.lunxun;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1: 创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        <span class="comment">// 2: 设置连接属性</span></span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;39.97.166.249&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 3: 从连接工厂中获取连接</span></span><br><span class="line">            connection = connectionFactory.newConnection(<span class="string">&quot;生产者&quot;</span>);</span><br><span class="line">            <span class="comment">// 4: 从连接中获取通道channel</span></span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line">            <span class="comment">// 6： 准备发送消息的内容</span></span><br><span class="line">            <span class="comment">//===============================end topic模式==================================</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">20</span>; i++) &#123;</span><br><span class="line">                <span class="comment">//消息的内容</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;学相伴:&quot;</span> + i;</span><br><span class="line">                <span class="comment">// 7: 发送消息给中间件rabbitmq-server</span></span><br><span class="line">                <span class="comment">// @params1: 交换机exchange</span></span><br><span class="line">                <span class="comment">// @params2: 队列名称/routingkey</span></span><br><span class="line">                <span class="comment">// @params3: 属性配置</span></span><br><span class="line">                <span class="comment">// @params4: 发送消息的内容</span></span><br><span class="line">                channel.basicPublish(<span class="string">&quot;&quot;</span>, <span class="string">&quot;queue1&quot;</span>, <span class="literal">null</span>, msg.getBytes());</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;消息发送成功!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">            System.out.println(<span class="string">&quot;发送消息出现异常...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 7: 释放连接关闭通道</span></span><br><span class="line">            <span class="keyword">if</span> (channel != <span class="literal">null</span> &amp;&amp; channel.isOpen()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    channel.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="消费者-Work1"><a href="#消费者-Work1" class="headerlink" title="消费者 - Work1"></a>消费者 - Work1</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kuang.rabbitmq.work.lunxun;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Work1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1: 创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        <span class="comment">// 2: 设置连接属性</span></span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;39.97.166.249&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 3: 从连接工厂中获取连接</span></span><br><span class="line">            connection = connectionFactory.newConnection(<span class="string">&quot;消费者-Work1&quot;</span>);</span><br><span class="line">            <span class="comment">// 4: 从连接中获取通道channel</span></span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line">            <span class="comment">// 5: 申明队列queue存储消息</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             *  如果队列不存在，则会创建</span></span><br><span class="line"><span class="comment">             *  Rabbitmq不允许创建两个相同的队列名称，否则会报错。</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             *  @params1： queue 队列的名称</span></span><br><span class="line"><span class="comment">             *  @params2： durable 队列是否持久化</span></span><br><span class="line"><span class="comment">             *  @params3： exclusive 是否排他，即是否私有的，如果为true,会对当前队列加锁，其他的通道不能访问，并且连接自动关闭</span></span><br><span class="line"><span class="comment">             *  @params4： autoDelete 是否自动删除，当最后一个消费者断开连接之后是否自动删除消息。</span></span><br><span class="line"><span class="comment">             *  @params5： arguments 可以设置队列附加参数，设置队列的有效期，消息的最大长度，队列的消息生命周期等等。</span></span><br><span class="line"><span class="comment">             * */</span></span><br><span class="line">            <span class="comment">// 这里如果queue已经被创建过一次了，可以不需要定义</span></span><br><span class="line"><span class="comment">//            channel.queueDeclare(&quot;queue1&quot;, false, false, false, null);</span></span><br><span class="line">            <span class="comment">// 同一时刻，服务器只会推送一条消息给消费者</span></span><br><span class="line">            <span class="comment">// 6： 定义接受消息的回调</span></span><br><span class="line">            <span class="type">Channel</span> <span class="variable">finalChannel</span> <span class="operator">=</span> channel;</span><br><span class="line"><span class="comment">//            finalChannel.basicQos(1);</span></span><br><span class="line">            finalChannel.basicConsume(<span class="string">&quot;queue1&quot;</span>, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                    <span class="keyword">try</span>&#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;Work1-收到消息是：&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                    &#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="keyword">new</span> <span class="title class_">CancelCallback</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            System.out.println(<span class="string">&quot;Work1-开始接受消息&quot;</span>);</span><br><span class="line">            System.in.read();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">            System.out.println(<span class="string">&quot;发送消息出现异常...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 7: 释放连接关闭通道</span></span><br><span class="line">            <span class="keyword">if</span> (channel != <span class="literal">null</span> &amp;&amp; channel.isOpen()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    channel.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="literal">null</span> &amp;&amp; connection.isOpen()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="消费者-Work2"><a href="#消费者-Work2" class="headerlink" title="消费者 - Work2"></a>消费者 - Work2</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kuang.rabbitmq.work.lunxun;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Work2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1: 创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        <span class="comment">// 2: 设置连接属性</span></span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;39.97.166.249&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 3: 从连接工厂中获取连接</span></span><br><span class="line">            connection = connectionFactory.newConnection(<span class="string">&quot;消费者-Work2&quot;</span>);</span><br><span class="line">            <span class="comment">// 4: 从连接中获取通道channel</span></span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line">            <span class="comment">// 5: 申明队列queue存储消息</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             *  如果队列不存在，则会创建</span></span><br><span class="line"><span class="comment">             *  Rabbitmq不允许创建两个相同的队列名称，否则会报错。</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             *  @params1： queue 队列的名称</span></span><br><span class="line"><span class="comment">             *  @params2： durable 队列是否持久化</span></span><br><span class="line"><span class="comment">             *  @params3： exclusive 是否排他，即是否私有的，如果为true,会对当前队列加锁，其他的通道不能访问，并且连接自动关闭</span></span><br><span class="line"><span class="comment">             *  @params4： autoDelete 是否自动删除，当最后一个消费者断开连接之后是否自动删除消息。</span></span><br><span class="line"><span class="comment">             *  @params5： arguments 可以设置队列附加参数，设置队列的有效期，消息的最大长度，队列的消息生命周期等等。</span></span><br><span class="line"><span class="comment">             * */</span></span><br><span class="line">            <span class="comment">// 这里如果queue已经被创建过一次了，可以不需要定义</span></span><br><span class="line">            <span class="comment">//channel.queueDeclare(&quot;queue1&quot;, false, true, false, null);</span></span><br><span class="line">            <span class="comment">// 同一时刻，服务器只会推送一条消息给消费者</span></span><br><span class="line">            <span class="comment">//channel.basicQos(1);</span></span><br><span class="line">            <span class="comment">// 6： 定义接受消息的回调</span></span><br><span class="line">            <span class="type">Channel</span> <span class="variable">finalChannel</span> <span class="operator">=</span> channel;</span><br><span class="line"><span class="comment">//            finalChannel.basicQos(1);</span></span><br><span class="line">            finalChannel.basicConsume(<span class="string">&quot;queue1&quot;</span>, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;<span class="comment">//true 自动应答autoACK</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                    <span class="keyword">try</span>&#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;Work2-收到消息是：&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                        Thread.sleep(<span class="number">200</span>);</span><br><span class="line">                    &#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="keyword">new</span> <span class="title class_">CancelCallback</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            System.out.println(<span class="string">&quot;Work2-开始接受消息&quot;</span>);</span><br><span class="line">            System.in.read();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">            System.out.println(<span class="string">&quot;发送消息出现异常...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 7: 释放连接关闭通道</span></span><br><span class="line">            <span class="keyword">if</span> (channel != <span class="literal">null</span> &amp;&amp; channel.isOpen()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    channel.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="literal">null</span> &amp;&amp; connection.isOpen()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="小结-3"><a href="#小结-3" class="headerlink" title="小结"></a>小结</h3><p>work1和work2的消息处理能力不同，但是最后处理的消息条数相同，是“按均分配”。</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407144403289.png" alt="image-20210407144403289"></p>
<h2 id="Work模式-公平分发（Fair-Dispatch）"><a href="#Work模式-公平分发（Fair-Dispatch）" class="headerlink" title="Work模式 - 公平分发（Fair Dispatch）"></a>Work模式 - 公平分发（Fair Dispatch）</h2><p>参考官网：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/getstarted.html">https://www.rabbitmq.com/getstarted.html</a></p>
<h3 id="图解-4"><a href="#图解-4" class="headerlink" title="图解"></a>图解</h3><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407144622568.png" alt="image-20210407144622568"></p>
<p>当有多个消费者时，我们的消息会被哪个消费者消费呢，我们又该如何均衡消费者消费信息的多少呢?<br>主要有两种模式：<br>1、轮询模式的分发：一个消费者一条，<strong>按均分配</strong>；<br>2、公平分发：根据消费者的消费能力进行公平分发，处理快的处理的多，处理慢的处理的少；<strong>按劳分配</strong>；</p>
<ul>
<li>类型：无</li>
<li>特点：由于消息接收者处理消息的能力不同，存在处理快慢的问题，我们就需要能者多劳，处理快的多处理，处理慢的少处理；</li>
</ul>
<h3 id="代码-1"><a href="#代码-1" class="headerlink" title="代码"></a>代码</h3><h4 id="生产者-4"><a href="#生产者-4" class="headerlink" title="生产者"></a>生产者</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kuang.rabbitmq.work.fair;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Channel;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.Connection;</span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Producer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1: 创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        <span class="comment">// 2: 设置连接属性</span></span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;39.97.166.249&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 3: 从连接工厂中获取连接</span></span><br><span class="line">            connection = connectionFactory.newConnection(<span class="string">&quot;生产者&quot;</span>);</span><br><span class="line">            <span class="comment">// 4: 从连接中获取通道channel</span></span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line">            <span class="comment">// 6： 准备发送消息的内容</span></span><br><span class="line">            <span class="comment">//===============================end topic模式==================================</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= <span class="number">20</span>; i++) &#123;</span><br><span class="line">                <span class="comment">//消息的内容</span></span><br><span class="line">                <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;学相伴:&quot;</span> + i;</span><br><span class="line">                <span class="comment">// 7: 发送消息给中间件rabbitmq-server</span></span><br><span class="line">                <span class="comment">// @params1: 交换机exchange</span></span><br><span class="line">                <span class="comment">// @params2: 队列名称/routingkey</span></span><br><span class="line">                <span class="comment">// @params3: 属性配置</span></span><br><span class="line">                <span class="comment">// @params4: 发送消息的内容</span></span><br><span class="line">                channel.basicPublish(<span class="string">&quot;&quot;</span>, <span class="string">&quot;queue1&quot;</span>, <span class="literal">null</span>, msg.getBytes());</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;消息发送成功!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">            System.out.println(<span class="string">&quot;发送消息出现异常...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 7: 释放连接关闭通道</span></span><br><span class="line">            <span class="keyword">if</span> (channel != <span class="literal">null</span> &amp;&amp; channel.isOpen()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    channel.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="消费者-Work1-1"><a href="#消费者-Work1-1" class="headerlink" title="消费者 - Work1"></a>消费者 - Work1</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kuang.rabbitmq.work.fair;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Work1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1: 创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        <span class="comment">// 2: 设置连接属性</span></span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;39.97.166.249&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 3: 从连接工厂中获取连接</span></span><br><span class="line">            connection = connectionFactory.newConnection(<span class="string">&quot;消费者-Work1&quot;</span>);</span><br><span class="line">            <span class="comment">// 4: 从连接中获取通道channel</span></span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line">            <span class="comment">// 5: 申明队列queue存储消息</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             *  如果队列不存在，则会创建</span></span><br><span class="line"><span class="comment">             *  Rabbitmq不允许创建两个相同的队列名称，否则会报错。</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             *  @params1： queue 队列的名称</span></span><br><span class="line"><span class="comment">             *  @params2： durable 队列是否持久化</span></span><br><span class="line"><span class="comment">             *  @params3： exclusive 是否排他，即是否私有的，如果为true,会对当前队列加锁，其他的通道不能访问，并且连接自动关闭</span></span><br><span class="line"><span class="comment">             *  @params4： autoDelete 是否自动删除，当最后一个消费者断开连接之后是否自动删除消息。</span></span><br><span class="line"><span class="comment">             *  @params5： arguments 可以设置队列附加参数，设置队列的有效期，消息的最大长度，队列的消息生命周期等等。</span></span><br><span class="line"><span class="comment">             * */</span></span><br><span class="line">            <span class="comment">// 这里如果queue已经被创建过一次了，可以不需要定义</span></span><br><span class="line"><span class="comment">//            channel.queueDeclare(&quot;queue1&quot;, false, false, false, null);</span></span><br><span class="line">            <span class="comment">// 同一时刻，服务器只会推送一条消息给消费者</span></span><br><span class="line">            <span class="comment">// 6： 定义接受消息的回调</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Channel</span> <span class="variable">finalChannel</span> <span class="operator">=</span> channel;</span><br><span class="line"><span class="comment">//            指标：每次从服务器中取出多少条message  默认为0</span></span><br><span class="line">            finalChannel.basicQos(<span class="number">1</span>);</span><br><span class="line">            finalChannel.basicConsume(<span class="string">&quot;queue1&quot;</span>, <span class="literal">false</span>, <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                    <span class="keyword">try</span>&#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;Work1-收到消息是：&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line"><span class="comment">//                        公平分发,手动应答</span></span><br><span class="line">                        finalChannel.basicAck(delivery.getEnvelope().getDeliveryTag(),<span class="literal">false</span>);</span><br><span class="line">                    &#125;<span class="keyword">catch</span>(Exception ex)&#123;</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="keyword">new</span> <span class="title class_">CancelCallback</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            System.out.println(<span class="string">&quot;Work1-开始接受消息&quot;</span>);</span><br><span class="line">            System.in.read();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">            System.out.println(<span class="string">&quot;发送消息出现异常...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 7: 释放连接关闭通道</span></span><br><span class="line">            <span class="keyword">if</span> (channel != <span class="literal">null</span> &amp;&amp; channel.isOpen()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    channel.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="literal">null</span> &amp;&amp; connection.isOpen()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="消费者-Work2-1"><a href="#消费者-Work2-1" class="headerlink" title="消费者 - Work2"></a>消费者 - Work2</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kuang.rabbitmq.work.fair;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.rabbitmq.client.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Work2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1: 创建连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">connectionFactory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        <span class="comment">// 2: 设置连接属性</span></span><br><span class="line">        connectionFactory.setHost(<span class="string">&quot;39.97.166.249&quot;</span>);</span><br><span class="line">        connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">        connectionFactory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        connectionFactory.setUsername(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        connectionFactory.setPassword(<span class="string">&quot;admin&quot;</span>);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 3: 从连接工厂中获取连接</span></span><br><span class="line">            connection = connectionFactory.newConnection(<span class="string">&quot;消费者-Work2&quot;</span>);</span><br><span class="line">            <span class="comment">// 4: 从连接中获取通道channel</span></span><br><span class="line">            channel = connection.createChannel();</span><br><span class="line">            <span class="comment">// 5: 申明队列queue存储消息</span></span><br><span class="line">            <span class="comment">/*</span></span><br><span class="line"><span class="comment">             *  如果队列不存在，则会创建</span></span><br><span class="line"><span class="comment">             *  Rabbitmq不允许创建两个相同的队列名称，否则会报错。</span></span><br><span class="line"><span class="comment">             *</span></span><br><span class="line"><span class="comment">             *  @params1： queue 队列的名称</span></span><br><span class="line"><span class="comment">             *  @params2： durable 队列是否持久化</span></span><br><span class="line"><span class="comment">             *  @params3： exclusive 是否排他，即是否私有的，如果为true,会对当前队列加锁，其他的通道不能访问，并且连接自动关闭</span></span><br><span class="line"><span class="comment">             *  @params4： autoDelete 是否自动删除，当最后一个消费者断开连接之后是否自动删除消息。</span></span><br><span class="line"><span class="comment">             *  @params5： arguments 可以设置队列附加参数，设置队列的有效期，消息的最大长度，队列的消息生命周期等等。</span></span><br><span class="line"><span class="comment">             * */</span></span><br><span class="line">            <span class="comment">// 这里如果queue已经被创建过一次了，可以不需要定义</span></span><br><span class="line">            <span class="comment">//channel.queueDeclare(&quot;queue1&quot;, false, true, false, null);</span></span><br><span class="line">            <span class="comment">// 同一时刻，服务器只会推送一条消息给消费者</span></span><br><span class="line">            <span class="comment">//channel.basicQos(1);</span></span><br><span class="line">            <span class="comment">// 6： 定义接受消息的回调</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Channel</span> <span class="variable">finalChannel</span> <span class="operator">=</span> channel;</span><br><span class="line">            finalChannel.basicQos(<span class="number">1</span>);</span><br><span class="line">            finalChannel.basicConsume(<span class="string">&quot;queue1&quot;</span>, <span class="literal">false</span>, <span class="keyword">new</span> <span class="title class_">DeliverCallback</span>() &#123;<span class="comment">//false 手动应答</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s, Delivery delivery)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;Work2-收到消息是：&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(delivery.getBody(), <span class="string">&quot;UTF-8&quot;</span>));</span><br><span class="line">                        Thread.sleep(<span class="number">200</span>);</span><br><span class="line"><span class="comment">//                      手动应答</span></span><br><span class="line">                        finalChannel.basicAck(delivery.getEnvelope().getDeliveryTag(),<span class="literal">false</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                        ex.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="keyword">new</span> <span class="title class_">CancelCallback</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handle</span><span class="params">(String s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            System.out.println(<span class="string">&quot;Work2-开始接受消息&quot;</span>);</span><br><span class="line">            System.in.read();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            ex.printStackTrace();</span><br><span class="line">            System.out.println(<span class="string">&quot;发送消息出现异常...&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 7: 释放连接关闭通道</span></span><br><span class="line">            <span class="keyword">if</span> (channel != <span class="literal">null</span> &amp;&amp; channel.isOpen()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    channel.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (connection != <span class="literal">null</span> &amp;&amp; connection.isOpen()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    connection.close();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                    ex.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="小结-4"><a href="#小结-4" class="headerlink" title="小结"></a>小结</h3><p>从结果可以看到，消费者1在相同时间内，处理了更多的消息；以上代码我们实现了公平分发模式；</p>
<ul>
<li>消费者一次接收一条消息，代码channel.BasicQos(0, 1, false);</li>
<li>公平分发需要消费者开启手动应答，关闭自动应答</li>
<li>关闭自动应答代码channel.BasicConsume(“queue_test”, false, consumer);</li>
<li>消费者开启手动应答代码：channel.BasicAck(ea.DeliveryTag, false);</li>
</ul>
<img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407150327015.png" alt="image-20210407150327015" style="zoom:50%;" />

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>（1）当队列里消息较多时，我们通常会开启多个消费者处理消息；公平分发和轮询分发都是我们经常使用的模式。<br>（2）轮询分发的主要思想是“按均分配”，不考虑消费者的处理能力，所有消费者均分；这种情况下，处理能力弱的服务器，一直都在处理消息，而处理能力强的服务器，在处理完消息后，处于空闲状态；<br>(3) 公平分发的主要思想是”能者多劳”，按需分配，能力强的干的多。</p>
<h1 id="RabbitMQ使用场景"><a href="#RabbitMQ使用场景" class="headerlink" title="RabbitMQ使用场景"></a>RabbitMQ使用场景</h1><h2 id="解耦、削峰、异步"><a href="#解耦、削峰、异步" class="headerlink" title="解耦、削峰、异步"></a>解耦、削峰、异步</h2><h3 id="同步异步的问题（串行）"><a href="#同步异步的问题（串行）" class="headerlink" title="同步异步的问题（串行）"></a>同步异步的问题（串行）</h3><p>串行方式：将订单信息写入数据库成功后，发送注册邮件，再发送注册短信。以上三个任务全部完成后，返回给客户端</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407150816089.png" alt="image-20210407150816089"></p>
<p><strong>代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">makeOrder</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 1 :保存订单 </span></span><br><span class="line">    orderService.saveOrder();</span><br><span class="line">    <span class="comment">// 2： 发送短信服务</span></span><br><span class="line">    messageService.sendSMS(<span class="string">&quot;order&quot;</span>);<span class="comment">//1-2 s</span></span><br><span class="line">    <span class="comment">// 3： 发送email服务</span></span><br><span class="line">    emailService.sendEmail(<span class="string">&quot;order&quot;</span>);<span class="comment">//1-2 s</span></span><br><span class="line">    <span class="comment">// 4： 发送APP服务</span></span><br><span class="line">    appService.sendApp(<span class="string">&quot;order&quot;</span>);    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="并行方式-异步线程池"><a href="#并行方式-异步线程池" class="headerlink" title="并行方式 异步线程池"></a>并行方式 异步线程池</h3><p>并行方式：将订单信息写入数据库成功后，发送注册邮件的同时，发送注册短信。以上三个任务完成后，返回给客户端。与串行的差别是，<strong>并行的方式可以提高处理的时间</strong></p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407150834670.png" alt="image-20210407150834670"></p>
<p><strong>代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">makeOrder</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 1 :保存订单 </span></span><br><span class="line">    orderService.saveOrder();</span><br><span class="line">   <span class="comment">// 相关发送</span></span><br><span class="line">   relationMessage();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">relationMessage</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 异步</span></span><br><span class="line">     theadpool.submit(<span class="keyword">new</span> <span class="title class_">Callable</span>&lt;Object&gt;&#123;</span><br><span class="line">         <span class="keyword">public</span> Object <span class="title function_">call</span><span class="params">()</span>&#123;</span><br><span class="line">             <span class="comment">// 2： 发送短信服务  </span></span><br><span class="line">             messageService.sendSMS(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;)</span><br><span class="line">    <span class="comment">// 异步</span></span><br><span class="line">     theadpool.submit(<span class="keyword">new</span> <span class="title class_">Callable</span>&lt;Object&gt;&#123;</span><br><span class="line">         <span class="keyword">public</span> Object <span class="title function_">call</span><span class="params">()</span>&#123;</span><br><span class="line">              <span class="comment">// 3： 发送email服务</span></span><br><span class="line">            emailService.sendEmail(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;)</span><br><span class="line">      <span class="comment">// 异步</span></span><br><span class="line">     theadpool.submit(<span class="keyword">new</span> <span class="title class_">Callable</span>&lt;Object&gt;&#123;</span><br><span class="line">         <span class="keyword">public</span> Object <span class="title function_">call</span><span class="params">()</span>&#123;</span><br><span class="line">             <span class="comment">// 4： 发送短信服务</span></span><br><span class="line">             appService.sendApp(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;)</span><br><span class="line">      <span class="comment">// 异步</span></span><br><span class="line">         theadpool.submit(<span class="keyword">new</span> <span class="title class_">Callable</span>&lt;Object&gt;&#123;</span><br><span class="line">         <span class="keyword">public</span> Object <span class="title function_">call</span><span class="params">()</span>&#123;</span><br><span class="line">             <span class="comment">// 4： 发送短信服务</span></span><br><span class="line">             appService.sendApp(<span class="string">&quot;order&quot;</span>);</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>存在问题：<br>1：<strong>耦合度高</strong><br>2：需要自己写线程池自己维护成本太高<br>3：出现了消息可能会丢失，需要你自己做消息补偿<br>4：如何保证消息的可靠性你自己写<br>5：如果服务器承载不了，你需要自己去写高可用</p>
<h3 id="异步消息队列的方式"><a href="#异步消息队列的方式" class="headerlink" title="异步消息队列的方式"></a>异步消息队列的方式</h3><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407150847495.png" alt="image-20210407150847495"></p>
<p><strong>好处</strong><br>1：<strong>完全解耦</strong>，用MQ建立桥接<br>2：有独立的线程池和运行模型<br>3：出现了消息可能会丢失，MQ有持久化功能<br>4：如何保证消息的可靠性，死信队列和消息转移的等<br>5：如果服务器承载不了，你需要自己去写高可用，HA镜像模型高可用。<br>按照以上约定，用户的响应时间相当于是订单信息写入数据库的时间，也就是50毫秒。注册邮件，发送短信写入消息队列后，直接返回，因此写入消息队列的速度很快，基本可以忽略，因此用户的响应时间可能是50毫秒。因此架构改变后，系统的吞吐量提高到每秒20 QPS。比串行提高了3倍，比并行提高了两倍</p>
<p><strong>代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">makeOrder</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="comment">// 1 :保存订单 </span></span><br><span class="line">    orderService.saveOrder();   </span><br><span class="line">    rabbitTemplate.convertSend(<span class="string">&quot;ex&quot;</span>,<span class="string">&quot;2&quot;</span>,<span class="string">&quot;消息内容&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="高内聚，低耦合"><a href="#高内聚，低耦合" class="headerlink" title="高内聚，低耦合"></a>高内聚，低耦合</h2><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407152215139.png" alt="image-20210407152215139"></p>
<h2 id="流量的削峰"><a href="#流量的削峰" class="headerlink" title="流量的削峰"></a>流量的削峰</h2><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407152234794.png" alt="image-20210407152234794"></p>
<p>04、分布式事务的可靠消费和可靠生产<br>05、索引、缓存、静态化处理的数据同步<br>06、流量监控<br>07、日志监控（ELK）<br>08、下单、订单分发、抢票</p>
<h1 id="RabbitMQ-SpringBoot案例-fanout模式"><a href="#RabbitMQ-SpringBoot案例-fanout模式" class="headerlink" title="RabbitMQ-SpringBoot案例 -fanout模式"></a>RabbitMQ-SpringBoot案例 -fanout模式</h1><h2 id="整体核心"><a href="#整体核心" class="headerlink" title="整体核心"></a>整体核心</h2><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407163123572.png" alt="image-20210407163123572"></p>
<h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>使用springboot完成rabbitmq的消费模式-Fanout</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407163137334.png" alt="image-20210407163137334"></p>
<h2 id="实现步骤-1"><a href="#实现步骤-1" class="headerlink" title="实现步骤"></a>实现步骤</h2><p>1：创建生产者工程：sspringboot-rabbitmq-fanout-producer<br>2：创建消费者工程：springboot-rabbitmq-fanout-consumer<br>3：引入spring-boot-rabbitmq的依赖<br>4：进行消息的分发和测试<br>5：查看和观察web控制台的状况</p>
<h2 id="生产者-5"><a href="#生产者-5" class="headerlink" title="生产者"></a>生产者</h2><h3 id="创建生产者工程：sspringboot-rabbitmq-fanout-producer"><a href="#创建生产者工程：sspringboot-rabbitmq-fanout-producer" class="headerlink" title="创建生产者工程：sspringboot-rabbitmq-fanout-producer"></a>创建生产者工程：sspringboot-rabbitmq-fanout-producer</h3><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407191253719.png" alt="image-20210407191253719"></p>
<h3 id="在pom-xml中引入依赖"><a href="#在pom-xml中引入依赖" class="headerlink" title="在pom.xml中引入依赖"></a>在pom.xml中引入依赖</h3><blockquote>
<p>web依赖   rabbitmq依赖</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.amqp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-rabbit-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="在application-yml进行配置"><a href="#在application-yml进行配置" class="headerlink" title="在application.yml进行配置"></a>在application.yml进行配置</h3><blockquote>
<p>生产者，消费者都需要  但端口不能一样</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#服务端口</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置rabbitmq服务</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">39.97</span><span class="number">.166</span><span class="number">.249</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br></pre></td></tr></table></figure>

<h3 id="定义订单的生产者"><a href="#定义订单的生产者" class="headerlink" title="定义订单的生产者"></a>定义订单的生产者</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaung.rabbitmq.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: springboot-order-rabbitmq-producer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Package</span>: com.kaung.rabbitmq.service</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: OrderService</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: FH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/4/7 16:45</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Method</span> makeOrder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Param</span>: [userid, productid, num]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Version</span>  1.0</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span> 模拟用户下单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">makeOrder</span><span class="params">(String userid,String productid,<span class="type">int</span> num)</span>&#123;</span><br><span class="line">        <span class="comment">//1.根据商品id查询库存是否充足</span></span><br><span class="line">        <span class="comment">//2.保存订单</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">orderId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        <span class="comment">//3.通过MQ来完成消息的分发</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;fanout_order_exchange&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">routingKey</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="comment">//参数1 交换机  参数2 路由key/队列名   参数3   消息内容</span></span><br><span class="line">        rabbitTemplate.convertAndSend(exchangeName,routingKey,orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="绑定关系"><a href="#绑定关系" class="headerlink" title="绑定关系"></a>绑定关系</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaung.rabbitmq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Binding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.FanoutExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: springboot-order-rabbitmq-producer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Package</span>: com.kaung.rabbitmq.config</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: RabbitMQConfig</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: FH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/4/7 16:57</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//l:声明注册fanout模式的交换机</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> FanoutExchange <span class="title function_">fanoutExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(<span class="string">&quot;fanout_order_exchange&quot;</span>,<span class="literal">true</span>,<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2:声明队列sms. fanout. queue   email.fanout. queue , duanxin.fanout. queue</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">smsQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;sms.fanout.queue&quot;</span>,<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">duanXinQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;duanXin.fanout.queue&quot;</span>,<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">emailQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;email.fanout.queue&quot;</span>,<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3:完成绑定关系（队列和交换机完成绑定关系)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">smsBinding</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(smsQueue()).to(fanoutExchange());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">duanXinBinding</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(duanXinQueue()).to(fanoutExchange());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">emailBinding</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(emailQueue()).to(fanoutExchange());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="进行测试"><a href="#进行测试" class="headerlink" title="进行测试"></a>进行测试</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaung.rabbitmq;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kaung.rabbitmq.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SpringbootOrderRabbitmqProducerApplicationTests</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">contextLoads</span><span class="params">()</span> &#123;</span><br><span class="line">        orderService.makeOrder(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;1&quot;</span>,<span class="number">12</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407191734860.png" alt="image-20210407191734860"></p>
<h2 id="定义消费者-1"><a href="#定义消费者-1" class="headerlink" title="定义消费者"></a>定义消费者</h2><h3 id="创建消费者工程：springboot-rabbitmq-fanout-consumer"><a href="#创建消费者工程：springboot-rabbitmq-fanout-consumer" class="headerlink" title="创建消费者工程：springboot-rabbitmq-fanout-consumer"></a>创建消费者工程：springboot-rabbitmq-fanout-consumer</h3><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407191327135.png" alt="image-20210407191327135"></p>
<h3 id="引入依赖pom-xml"><a href="#引入依赖pom-xml" class="headerlink" title="引入依赖pom.xml"></a>引入依赖pom.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.amqp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-rabbit-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="在application-yml进行配置-1"><a href="#在application-yml进行配置-1" class="headerlink" title="在application.yml进行配置"></a>在application.yml进行配置</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#服务端口</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置rabbitmq服务</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">39.97</span><span class="number">.166</span><span class="number">.249</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br></pre></td></tr></table></figure>

<h3 id="消费者-邮件服务"><a href="#消费者-邮件服务" class="headerlink" title="消费者 - 邮件服务"></a>消费者 - 邮件服务</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kuang.rabbitmq.service.fanout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: springboot-order-rabbitmq-producer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Package</span>: com.kuang.rabbitmq.service.fanout</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: FanoutSMSConsumer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: FH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/4/7 18:10</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;email.fanout.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FanoutEmailConsumer</span> &#123;</span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reviceMessage</span><span class="params">(String message)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;email.fanout.queue----接收到了订单信息是：-》&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="消费者-短信服务"><a href="#消费者-短信服务" class="headerlink" title="消费者 - 短信服务"></a>消费者 - 短信服务</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kuang.rabbitmq.service.fanout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: springboot-order-rabbitmq-producer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Package</span>: com.kuang.rabbitmq.service.fanout</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: FanoutSMSConsumer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: FH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/4/7 18:10</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;duanXin.fanout.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FanoutDuanXinConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reviceMessage</span><span class="params">(String message)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;duanXin.fanout.queue----接收到了订单信息是：-》&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="消费者-SMS服务"><a href="#消费者-SMS服务" class="headerlink" title="消费者 - SMS服务"></a>消费者 - SMS服务</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kuang.rabbitmq.service.fanout;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: springboot-order-rabbitmq-producer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Package</span>: com.kuang.rabbitmq.service.fanout</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: FanoutSMSConsumer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: FH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/4/7 18:10</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;sms.fanout.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FanoutSMSConsumer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reviceMessage</span><span class="params">(String message)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;sms.fanout.queue----接收到了订单信息是：-》&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="启动服务Producer服务，查看效果"><a href="#启动服务Producer服务，查看效果" class="headerlink" title="启动服务Producer服务，查看效果"></a>启动服务Producer服务，查看效果</h3><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407191817109.png" alt="image-20210407191817109"></p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407191904744.png" alt="image-20210407191904744"></p>
<h1 id="RabbitMQ-SpringBoot案例-direct模式"><a href="#RabbitMQ-SpringBoot案例-direct模式" class="headerlink" title="RabbitMQ-SpringBoot案例 -direct模式"></a>RabbitMQ-SpringBoot案例 -direct模式</h1><p>&#x3D;&#x3D;依赖，配置  和fanout模式一样&#x3D;&#x3D;</p>
<blockquote>
<p>生产者</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaung.rabbitmq.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: springboot-order-rabbitmq-producer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Package</span>: com.kaung.rabbitmq.service</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: OrderService</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: FH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/4/7 16:45</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Method</span> makeOrderDirect</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Param</span>: [userid, productid, num]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Version</span>  1.0</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>   direct(路由模式)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">makeOrderDirect</span><span class="params">(String userid,String productid,<span class="type">int</span> num)</span>&#123;</span><br><span class="line">        <span class="comment">//1.根据商品id查询库存是否充足</span></span><br><span class="line">        <span class="comment">//2.保存订单</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">orderId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        <span class="comment">//3.通过MQ来完成消息的分发</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;direct_order_exchange&quot;</span>;</span><br><span class="line"><span class="comment">//        String routingKey = &quot;&quot;;</span></span><br><span class="line">        <span class="comment">//参数1 交换机  参数2 路由key/队列名   参数3   消息内容</span></span><br><span class="line">        rabbitTemplate.convertAndSend(exchangeName,<span class="string">&quot;sms&quot;</span>,orderId);</span><br><span class="line">        rabbitTemplate.convertAndSend(exchangeName,<span class="string">&quot;email&quot;</span>,orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>交换机、队列声明—绑定             配置类放在服务者或消费者都可以</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaung.rabbitmq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Binding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.DirectExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: springboot-order-rabbitmq-producer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Package</span>: com.kaung.rabbitmq.config</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: RabbitMQConfig</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: FH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/4/7 16:57</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Direct_RabbitMQConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//l:声明注册direct模式的交换机</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">directExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(<span class="string">&quot;direct_order_exchange&quot;</span>,<span class="literal">true</span>,<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2:声明队列sms. direct. queue   email.direct. queue , duanXin.direct. queue</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">DirectSmsQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;sms.direct.queue&quot;</span>,<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">DirectDuanXinQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;duanXin.direct.queue&quot;</span>,<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">DirectEmailQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;email.direct.queue&quot;</span>,<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3:完成绑定关系（队列和交换机完成绑定关系)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">DirectSmsBinding</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(DirectSmsQueue()).to(directExchange()).with(<span class="string">&quot;sms&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">DirectDuanXinBinding</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(DirectDuanXinQueue()).to(directExchange()).with(<span class="string">&quot;duanXin&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">DirectEmailBinding</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(DirectEmailQueue()).to(directExchange()).with(<span class="string">&quot;email&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>消费者   sms和短信   与下列代码相似</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kuang.rabbitmq.service.direct;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitHandler;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.RabbitListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: springboot-order-rabbitmq-producer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Package</span>: com.kuang.rabbitmq.service.fanout</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: FanoutSMSConsumer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: FH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/4/7 18:10</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RabbitListener(queues = &quot;email.direct.queue&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DirectEmailConsumer</span> &#123;</span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reviceMessage</span><span class="params">(String message)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;email.direct.queue----接收到了订单信息是：-》&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试</p>
</blockquote>
<p><strong>启动服务端</strong></p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407200228348.png" alt="image-20210407200228348"></p>
<p><strong>启动消费端</strong></p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407200323408.png" alt="image-20210407200323408"></p>
<h1 id="RabbitMQ-SpringBoot案例-topic模式"><a href="#RabbitMQ-SpringBoot案例-topic模式" class="headerlink" title="RabbitMQ-SpringBoot案例 -topic模式"></a>RabbitMQ-SpringBoot案例 -topic模式</h1><p>&#x3D;&#x3D;依赖，配置  和fanout模式一样&#x3D;&#x3D;</p>
<blockquote>
<p>生产者</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaung.rabbitmq.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: springboot-order-rabbitmq-producer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Package</span>: com.kaung.rabbitmq.service</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: OrderService</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: FH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/4/7 16:45</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Method</span> makeOrderTopic</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Param</span>: [userid, productid, num]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Version</span>  1.0</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>  topic模式</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">makeOrderTopic</span><span class="params">(String userid,String productid,<span class="type">int</span> num)</span>&#123;</span><br><span class="line">        <span class="comment">//1.根据商品id查询库存是否充足</span></span><br><span class="line">        <span class="comment">//2.保存订单</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">orderId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        <span class="comment">//3.通过MQ来完成消息的分发</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;topic_order_exchange&quot;</span>;</span><br><span class="line">        <span class="comment">//*.duanXin.#  *.email.*  #.sms.#</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">routingKey</span> <span class="operator">=</span> <span class="string">&quot;com.duanXin.sms.email.test&quot;</span>;</span><br><span class="line">        <span class="comment">//参数1 交换机  参数2 路由key/队列名   参数3   消息内容</span></span><br><span class="line">        rabbitTemplate.convertAndSend(exchangeName,routingKey,orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用注解进行绑定     duanXin和sms和下列代码相似</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kuang.rabbitmq.service.topic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.ExchangeTypes;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.annotation.*;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: springboot-order-rabbitmq-producer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Package</span>: com.kuang.rabbitmq.service.fanout</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: FanoutSMSConsumer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: FH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/4/7 18:10</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RabbitListener(bindings = @QueueBinding(</span></span><br><span class="line"><span class="meta">        value = @Queue(value = &quot;email.topic.queue&quot;,durable = &quot;true&quot;,autoDelete = &quot;false&quot;),</span></span><br><span class="line"><span class="meta">        exchange = @Exchange(value = &quot;topic_order_exchange&quot;,type = ExchangeTypes.TOPIC),</span></span><br><span class="line"><span class="meta">        key = &quot;*.email.*&quot;</span></span><br><span class="line"><span class="meta">))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TopicEmailConsumer</span> &#123;</span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reviceMessage</span><span class="params">(String message)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;email.topic.queue----接收到了订单信息是：-》&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>测试</p>
</blockquote>
<p><strong>启动服务端</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testOrderTopic</span><span class="params">()</span> &#123;</span><br><span class="line">    orderService.makeOrderTopic(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;1&quot;</span>,<span class="number">12</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407204038190.png" alt="image-20210407204038190"></p>
<p><strong>启动消费端</strong></p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210407204141970.png" alt="image-20210407204141970"></p>
<h1 id="RabbitMQ高级-过期时间TTL"><a href="#RabbitMQ高级-过期时间TTL" class="headerlink" title="RabbitMQ高级-过期时间TTL"></a>RabbitMQ高级-过期时间TTL</h1><h2 id="概述-1"><a href="#概述-1" class="headerlink" title="概述"></a>概述</h2><p>过期时间TTL表示可以对消息设置预期的时间，在这个时间内都可以被消费者接收获取；过了之后消息将自动被删除。RabbitMQ可以对<strong>消息和队列</strong>设置TTL。目前有两种方法可以设置。</p>
<ul>
<li>第一种方法是通过队列属性设置，队列中所有消息都有相同的过期时间。</li>
<li>第二种方法是对消息进行单独设置，每条消息TTL可以不同。</li>
</ul>
<p>如果上述两种方法同时使用，则消息的过期时间以两者之间TTL较小的那个数值为准。消息在队列的生存时间一旦超过设置的TTL值，就称为dead message被投递到死信队列， 消费者将无法再收到该消息。</p>
<h2 id="设置队列TTL"><a href="#设置队列TTL" class="headerlink" title="设置队列TTL"></a>设置队列TTL</h2><h3 id="配置类"><a href="#配置类" class="headerlink" title="配置类"></a>配置类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaung.rabbitmq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Binding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.DirectExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TTL_Direct_RabbitMQConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//l:声明注册direct模式的交换机</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">TTL_directExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(<span class="string">&quot;TTL_direct_order_exchange&quot;</span>,<span class="literal">true</span>,<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2:声明队列</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">TTL_DirectSmsQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        args.put(<span class="string">&quot;x-message-ttl&quot;</span>,<span class="number">5000</span>);<span class="comment">//一定是int</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;sms.TTL.queue&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3:完成绑定关系（队列和交换机完成绑定关系)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">TTL_DirectSmsBinding</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(TTL_DirectSmsQueue()).to(TTL_directExchange()).with(<span class="string">&quot;ttl&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="服务提供"><a href="#服务提供" class="headerlink" title="服务提供"></a>服务提供</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaung.rabbitmq.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.rabbit.core.RabbitTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ProjectName</span>: springboot-order-rabbitmq-producer</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Package</span>: com.kaung.rabbitmq.service</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@ClassName</span>: OrderService</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: FH</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>: 2021/4/7 16:45</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span>: 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Method</span> makeOrderTTL</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Param</span>: [userid, productid, num]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Version</span>  1.0</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>   TTL过期时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">makeOrderTTL</span><span class="params">(String userid,String productid,<span class="type">int</span> num)</span>&#123;</span><br><span class="line">        <span class="comment">//1.根据商品id查询库存是否充足</span></span><br><span class="line">        <span class="comment">//2.保存订单</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">orderId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        <span class="comment">//3.通过MQ来完成消息的分发</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;TTL_direct_order_exchange&quot;</span>;</span><br><span class="line">        <span class="comment">//routingKey</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">routingKey</span> <span class="operator">=</span> <span class="string">&quot;ttl&quot;</span>;</span><br><span class="line">        <span class="comment">//参数1 交换机  参数2 路由key/队列名   参数3   消息内容</span></span><br><span class="line">        rabbitTemplate.convertAndSend(exchangeName,routingKey,orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试类"><a href="#测试类" class="headerlink" title="测试类"></a>测试类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testOrderTTL</span><span class="params">()</span> &#123;</span><br><span class="line">    orderService.makeOrderTTL(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;1&quot;</span>,<span class="number">12</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>参数 x-message-ttl 的值 必须是非负 32 位整数 (0 &lt;&#x3D; n &lt;&#x3D; 2^32-1) ，以毫秒为单位表示 TTL 的值。这样，值 6000 表示存在于 队列 中的当前 消息 将最多只存活 6 秒钟。</p>
</blockquote>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408092428938.png" alt="image-20210408092428938"></p>
<h2 id="设置消息TTL"><a href="#设置消息TTL" class="headerlink" title="设置消息TTL"></a>设置消息TTL</h2><p>消息的过期时间；只需要在发送消息（可以发送到任何队列，不管该队列是否属于某个交换机）的时候设置过期时间即可。在测试类中编写如下方法发送消息并设置过期时间到队列：</p>
<p><strong>配置类中添加声明一个队列</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="keyword">public</span> Queue <span class="title function_">TTL_message_DirectSmsQueue</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;sms.TTL_message.queue&quot;</span>,<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>服务类中添加服务</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">makeOrderTTL_message</span><span class="params">(String userid,String productid,<span class="type">int</span> num)</span>&#123;</span><br><span class="line">       <span class="comment">//1.根据商品id查询库存是否充足</span></span><br><span class="line">       <span class="comment">//2.保存订单</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">orderId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">       <span class="comment">//3.通过MQ来完成消息的分发</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;TTL_direct_order_exchange&quot;</span>;</span><br><span class="line">       <span class="comment">//routingKey</span></span><br><span class="line">       <span class="type">String</span> <span class="variable">routingKey</span> <span class="operator">=</span> <span class="string">&quot;ttl_message&quot;</span>;</span><br><span class="line">       <span class="comment">//给消息设置过期时间</span></span><br><span class="line">       <span class="type">MessagePostProcessor</span> <span class="variable">postProcessor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessagePostProcessor</span>() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> Message <span class="title function_">postProcessMessage</span><span class="params">(Message message)</span> <span class="keyword">throws</span> AmqpException &#123;</span><br><span class="line">               <span class="comment">//这里就是字符串</span></span><br><span class="line">               message.getMessageProperties().setExpiration(<span class="string">&quot;5000&quot;</span>);</span><br><span class="line">               message.getMessageProperties().setContentEncoding(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">               <span class="keyword">return</span> message;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;;</span><br><span class="line">       <span class="comment">//参数1 交换机  参数2 路由key/队列名   参数3   消息内容</span></span><br><span class="line">       rabbitTemplate.convertAndSend(exchangeName,routingKey,orderId,postProcessor);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testOrderTTLmessage</span><span class="params">()</span> &#123;</span><br><span class="line">    orderService.makeOrderTTL_message(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;1&quot;</span>,<span class="number">12</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408094836815.png" alt="image-20210408094836815"></p>
<blockquote>
<p>expiration 字段以微秒为单位表示 TTL 值。且与 x-message-ttl 具有相同的约束条件。因为 expiration 字段必须为字符串类型，broker 将只会接受以字符串形式表达的数字。<br>当同时指定了 queue 和 message 的 TTL 值，则两者中较小的那个才会起作用。</p>
</blockquote>
<h1 id="RabbitMQ高级-消息确认机制的配置"><a href="#RabbitMQ高级-消息确认机制的配置" class="headerlink" title="RabbitMQ高级-消息确认机制的配置"></a>RabbitMQ高级-消息确认机制的配置</h1><p>NONE值是禁用发布确认模式，是默认值<br>CORRELATED值是发布消息成功到交换器后会触发回调方法，如1示例<br>SIMPLE值经测试有两种效果，其一效果和CORRELATED值一样会触发回调方法，其二在发布消息成功后使用rabbitTemplate调用waitForConfirms或waitForConfirmsOrDie方法等待broker节点返回发送结果，根据返回结果来判定下一步的逻辑，要注意的点是waitForConfirmsOrDie方法如果返回false则会关闭channel，则接下来无法发送消息到broker;</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端口</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="comment"># 配置rabbitmq服务</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">47.104</span><span class="number">.141</span><span class="number">.27</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">correlatedy</span></span><br><span class="line"></span><br><span class="line"><span class="string">package</span> <span class="string">com.xuexiangban.rabbitmq.springbootorderrabbitmqproducer.callback;</span></span><br><span class="line"><span class="string">import</span> <span class="string">org.springframework.amqp.rabbit.connection.CorrelationData;</span></span><br><span class="line"><span class="string">import</span> <span class="string">org.springframework.amqp.rabbit.core.RabbitTemplate;</span></span><br><span class="line"><span class="string">import</span> <span class="string">org.springframework.stereotype.Component;</span></span><br><span class="line"><span class="string">/**</span></span><br><span class="line"> <span class="string">*</span> <span class="string">@description:</span></span><br><span class="line"> <span class="string">*</span> <span class="string">@author:</span> <span class="string">xuke</span></span><br><span class="line"> <span class="string">*</span> <span class="string">@time:</span> <span class="number">2021</span><span class="string">/3/5</span> <span class="number">23</span><span class="string">:25</span></span><br><span class="line"> <span class="string">*/</span></span><br><span class="line"><span class="string">public</span> <span class="string">class</span> <span class="string">MessageConfirmCallback</span> <span class="string">implements</span> <span class="string">RabbitTemplate.ConfirmCallback</span> &#123;</span><br><span class="line">    <span class="string">@Override</span></span><br><span class="line">    <span class="string">public</span> <span class="string">void</span> <span class="string">confirm(CorrelationData</span> <span class="string">correlationData</span>, <span class="string">boolean</span> <span class="string">ack</span>, <span class="string">String</span> <span class="string">cause)</span> &#123;</span><br><span class="line">        <span class="string">if(ack)</span>&#123;</span><br><span class="line">            <span class="string">System.out.println(&quot;消息确认成功!!!!&quot;);</span></span><br><span class="line">        &#125;<span class="string">else</span>&#123;</span><br><span class="line">            <span class="string">System.out.println(&quot;消息确认失败!!!!&quot;);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">/**</span></span><br><span class="line">     <span class="string">*</span> <span class="string">@Author</span> <span class="string">xuke</span></span><br><span class="line">     <span class="string">*</span> <span class="string">@Description</span> <span class="string">模拟用户购买商品下单的业务</span></span><br><span class="line">     <span class="string">*</span> <span class="string">@Date</span> <span class="number">22</span><span class="string">:26</span> <span class="number">2021</span><span class="string">/3/5</span></span><br><span class="line">     <span class="string">*</span> <span class="string">@Param</span> [<span class="string">userId</span>, <span class="string">productId</span>, <span class="string">num</span>]</span><br><span class="line">     <span class="string">*</span> <span class="string">@return</span> <span class="string">void</span></span><br><span class="line">     <span class="string">**/</span></span><br><span class="line">    <span class="string">public</span> <span class="string">void</span> <span class="string">makeOrderTopic(String</span> <span class="string">userId,String</span> <span class="string">productId,int</span> <span class="string">num)&#123;</span></span><br><span class="line">        <span class="string">//</span> <span class="attr">1:</span> <span class="string">根据商品id查询库存是否充足</span></span><br><span class="line">        <span class="string">//</span> <span class="attr">2:</span> <span class="string">保存订单</span></span><br><span class="line">        <span class="string">String</span> <span class="string">orderId</span> <span class="string">=</span> <span class="string">UUID.randomUUID().toString();</span></span><br><span class="line">        <span class="string">System.out.println(&quot;保存订单成功：id是：&quot;</span> <span class="string">+</span> <span class="string">orderId);</span></span><br><span class="line">        <span class="string">//</span> <span class="attr">3:</span> <span class="string">发送消息</span></span><br><span class="line">        <span class="string">//com.#</span>  <span class="string">duanxin</span></span><br><span class="line">        <span class="string">//#.email.*</span> <span class="string">email</span></span><br><span class="line">        <span class="string">//#.sms.#</span> <span class="string">sms</span></span><br><span class="line">        <span class="string">//</span> <span class="string">设置消息确认机制</span></span><br><span class="line">        <span class="string">rabbitTemplate.setConfirmCallback(new</span> <span class="string">MessageConfirmCallback());</span></span><br><span class="line">        <span class="string">rabbitTemplate.convertAndSend(&quot;topic_order_ex&quot;,&quot;com.email.sms.xxx&quot;,orderId);</span></span><br><span class="line">    <span class="string">&#125;RabbitMQ高级-消息确认机制的配置</span></span><br><span class="line"><span class="string">NONE值是禁用发布确认模式，是默认值</span></span><br><span class="line"><span class="string">CORRELATED值是发布消息成功到交换器后会触发回调方法，如1示例</span></span><br><span class="line"><span class="string">SIMPLE值经测试有两种效果，其一效果和CORRELATED值一样会触发回调方法，其二在发布消息成功后使用rabbitTemplate调用waitForConfirms或waitForConfirmsOrDie方法等待broker节点返回发送结果，根据返回结果来判定下一步的逻辑，要注意的点是waitForConfirmsOrDie方法如果返回false则会关闭channel，则接下来无法发送消息到broker;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务端口</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line"><span class="comment"># 配置rabbitmq服务</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">47.104</span><span class="number">.141</span><span class="number">.27</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">correlatedy</span></span><br><span class="line"></span><br><span class="line"><span class="string">package</span> <span class="string">com.xuexiangban.rabbitmq.springbootorderrabbitmqproducer.callback;</span></span><br><span class="line"><span class="string">import</span> <span class="string">org.springframework.amqp.rabbit.connection.CorrelationData;</span></span><br><span class="line"><span class="string">import</span> <span class="string">org.springframework.amqp.rabbit.core.RabbitTemplate;</span></span><br><span class="line"><span class="string">import</span> <span class="string">org.springframework.stereotype.Component;</span></span><br><span class="line"><span class="string">/**</span></span><br><span class="line"> <span class="string">*</span> <span class="string">@description:</span></span><br><span class="line"> <span class="string">*</span> <span class="string">@author:</span> <span class="string">xuke</span></span><br><span class="line"> <span class="string">*</span> <span class="string">@time:</span> <span class="number">2021</span><span class="string">/3/5</span> <span class="number">23</span><span class="string">:25</span></span><br><span class="line"> <span class="string">*/</span></span><br><span class="line"><span class="string">public</span> <span class="string">class</span> <span class="string">MessageConfirmCallback</span> <span class="string">implements</span> <span class="string">RabbitTemplate.ConfirmCallback</span> &#123;</span><br><span class="line">    <span class="string">@Override</span></span><br><span class="line">    <span class="string">public</span> <span class="string">void</span> <span class="string">confirm(CorrelationData</span> <span class="string">correlationData</span>, <span class="string">boolean</span> <span class="string">ack</span>, <span class="string">String</span> <span class="string">cause)</span> &#123;</span><br><span class="line">        <span class="string">if(ack)</span>&#123;</span><br><span class="line">            <span class="string">System.out.println(&quot;消息确认成功!!!!&quot;);</span></span><br><span class="line">        &#125;<span class="string">else</span>&#123;</span><br><span class="line">            <span class="string">System.out.println(&quot;消息确认失败!!!!&quot;);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">/**</span></span><br><span class="line">     <span class="string">*</span> <span class="string">@Author</span> <span class="string">xuke</span></span><br><span class="line">     <span class="string">*</span> <span class="string">@Description</span> <span class="string">模拟用户购买商品下单的业务</span></span><br><span class="line">     <span class="string">*</span> <span class="string">@Date</span> <span class="number">22</span><span class="string">:26</span> <span class="number">2021</span><span class="string">/3/5</span></span><br><span class="line">     <span class="string">*</span> <span class="string">@Param</span> [<span class="string">userId</span>, <span class="string">productId</span>, <span class="string">num</span>]</span><br><span class="line">     <span class="string">*</span> <span class="string">@return</span> <span class="string">void</span></span><br><span class="line">     <span class="string">**/</span></span><br><span class="line">    <span class="string">public</span> <span class="string">void</span> <span class="string">makeOrderTopic(String</span> <span class="string">userId,String</span> <span class="string">productId,int</span> <span class="string">num)&#123;</span></span><br><span class="line">        <span class="string">//</span> <span class="attr">1:</span> <span class="string">根据商品id查询库存是否充足</span></span><br><span class="line">        <span class="string">//</span> <span class="attr">2:</span> <span class="string">保存订单</span></span><br><span class="line">        <span class="string">String</span> <span class="string">orderId</span> <span class="string">=</span> <span class="string">UUID.randomUUID().toString();</span></span><br><span class="line">        <span class="string">System.out.println(&quot;保存订单成功：id是：&quot;</span> <span class="string">+</span> <span class="string">orderId);</span></span><br><span class="line">        <span class="string">//</span> <span class="attr">3:</span> <span class="string">发送消息</span></span><br><span class="line">        <span class="string">//com.#</span>  <span class="string">duanxin</span></span><br><span class="line">        <span class="string">//#.email.*</span> <span class="string">email</span></span><br><span class="line">        <span class="string">//#.sms.#</span> <span class="string">sms</span></span><br><span class="line">        <span class="string">//</span> <span class="string">设置消息确认机制</span></span><br><span class="line">        <span class="string">rabbitTemplate.setConfirmCallback(new</span> <span class="string">MessageConfirmCallback());</span></span><br><span class="line">        <span class="string">rabbitTemplate.convertAndSend(&quot;topic_order_ex&quot;,&quot;com.email.sms.xxx&quot;,orderId);</span></span><br><span class="line">    <span class="string">&#125;</span></span><br></pre></td></tr></table></figure>

<h1 id="RabbitMQ高级-死信队列"><a href="#RabbitMQ高级-死信队列" class="headerlink" title="RabbitMQ高级-死信队列"></a>RabbitMQ高级-死信队列</h1><h2 id="概述-2"><a href="#概述-2" class="headerlink" title="概述"></a>概述</h2><p>DLX，全称为Dead-Letter-Exchange , 可以称之为死信交换机，也有人称之为死信邮箱。当消息在一个队列中变成死信(dead message)之后，它能被重新发送到另一个交换机中，这个交换机就是DLX ，<strong>绑定DLX的队列就称之为死信队列。</strong><br>&#x3D;&#x3D;消息变成死信&#x3D;&#x3D;，可能是由于以下的原因：</p>
<ul>
<li>&#x3D;&#x3D;消息被拒绝&#x3D;&#x3D;</li>
<li>&#x3D;&#x3D;消息过期&#x3D;&#x3D;</li>
<li>&#x3D;&#x3D;队列达到最大长度&#x3D;&#x3D;</li>
</ul>
<p>DLX也是一个正常的交换机，和一般的交换机没有区别，它能在任何的队列上被指定，实际上就是设置某一个队列的属性。当这个队列中存在死信时，Rabbitmq就会自动地将这个消息重新发布到设置的DLX上去，进而被路由到另一个队列，即死信队列。<br>要想使用死信队列，只需要在定义队列的时候设置队列参数 <code>x-dead-letter-exchange</code> 指定交换机即可。</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408102221466.png" alt="image-20210408102221466"></p>
<p><strong>流程</strong><br><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408102255173.png" alt="image-20210408102255173"></p>
<h2 id="死信队列测试"><a href="#死信队列测试" class="headerlink" title="死信队列测试"></a>死信队列测试</h2><p><strong>创建死信交换机</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaung.rabbitmq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Binding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.DirectExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dead_Direct_RabbitMQConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//l:声明注册direct模式的交换机</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">Dead_directExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(<span class="string">&quot;Dead_direct_exchange&quot;</span>,<span class="literal">true</span>,<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2:声明队列</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">Dead_DirectSmsQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;dead.direct.queue&quot;</span>,<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3:完成绑定关系（队列和交换机完成绑定关系)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">Dead_DirectSmsBinding</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(Dead_DirectSmsQueue()).to(Dead_directExchange()).with(<span class="string">&quot;dead&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>正常交换机在声明队列时绑定死信交换机</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kaung.rabbitmq.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Binding;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.BindingBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.DirectExchange;</span><br><span class="line"><span class="keyword">import</span> org.springframework.amqp.core.Queue;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TTL_Direct_RabbitMQConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//l:声明注册direct模式的交换机</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DirectExchange <span class="title function_">TTL_directExchange</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(<span class="string">&quot;TTL_direct_order_exchange&quot;</span>,<span class="literal">true</span>,<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2:声明队列</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">TTL_DirectSmsQueue</span><span class="params">()</span>&#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        args.put(<span class="string">&quot;x-message-ttl&quot;</span>,<span class="number">5000</span>);</span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>,<span class="string">&quot;Dead_direct_exchange&quot;</span>);</span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-routing-key&quot;</span>,<span class="string">&quot;dead&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;sms.TTL.queue&quot;</span>,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Bean</span></span><br><span class="line"><span class="comment">//    public Queue TTL_message_DirectSmsQueue()&#123;</span></span><br><span class="line"><span class="comment">//        return new Queue(&quot;sms.TTL_message.queue&quot;,true);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3:完成绑定关系（队列和交换机完成绑定关系)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">TTL_DirectSmsBinding</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(TTL_DirectSmsQueue()).to(TTL_directExchange()).with(<span class="string">&quot;ttl&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    @Bean</span></span><br><span class="line"><span class="comment">//    public Binding TTL_message_DirectSmsBinding()&#123;</span></span><br><span class="line"><span class="comment">//        return BindingBuilder.bind(TTL_message_DirectSmsQueue()).to(TTL_directExchange()).with(&quot;ttl_message&quot;);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>服务类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Method</span> makeOrderTTL</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Param</span>: [userid, productid, num]</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Author</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Version</span>  1.0</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>   队列过期时间</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">makeOrderTTL</span><span class="params">(String userid,String productid,<span class="type">int</span> num)</span>&#123;</span><br><span class="line">        <span class="comment">//1.根据商品id查询库存是否充足</span></span><br><span class="line">        <span class="comment">//2.保存订单</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">orderId</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line">        <span class="comment">//3.通过MQ来完成消息的分发</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">exchangeName</span> <span class="operator">=</span> <span class="string">&quot;TTL_direct_order_exchange&quot;</span>;</span><br><span class="line">        <span class="comment">//routingKey</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">routingKey</span> <span class="operator">=</span> <span class="string">&quot;ttl&quot;</span>;</span><br><span class="line">        <span class="comment">//参数1 交换机  参数2 路由key/队列名   参数3   消息内容</span></span><br><span class="line">        rabbitTemplate.convertAndSend(exchangeName,routingKey,orderId);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">testOrderTTL</span><span class="params">()</span> &#123;</span><br><span class="line">    orderService.makeOrderTTL(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;1&quot;</span>,<span class="number">12</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="在rabbitMQ管理界面中结果"><a href="#在rabbitMQ管理界面中结果" class="headerlink" title="在rabbitMQ管理界面中结果"></a>在rabbitMQ管理界面中结果</h2><p>消息过期前</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408102059004.png" alt="image-20210408102059004"></p>
<p>消息过期后</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408102134051.png" alt="image-20210408102134051"></p>
<h1 id="RabbitMQ运维-持久化机制"><a href="#RabbitMQ运维-持久化机制" class="headerlink" title="RabbitMQ运维-持久化机制"></a>RabbitMQ运维-持久化机制</h1><h2 id="RibbitMQ持久化"><a href="#RibbitMQ持久化" class="headerlink" title="RibbitMQ持久化"></a>RibbitMQ持久化</h2><p>&#x3D;&#x3D;持久化就把信息写入到磁盘的过程。&#x3D;&#x3D;</p>
<h2 id="RabbitMQ持久化消息"><a href="#RabbitMQ持久化消息" class="headerlink" title="RabbitMQ持久化消息"></a>RabbitMQ持久化消息</h2><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408143558031.png" alt="image-20210408143558031"></p>
<blockquote>
<p>把消息默认放在内存中是为了加快传输和消费的速度，存入磁盘是保证消息数据的持久化&gt;</p>
</blockquote>
<h2 id="RabbitMQ非持久化消息"><a href="#RabbitMQ非持久化消息" class="headerlink" title="RabbitMQ非持久化消息"></a>RabbitMQ非持久化消息</h2><p>非持久消息：是指当内存不够用的时候，会把消息和数据转移到磁盘，但是重启以后非持久化队列消息就丢失。</p>
<h2 id="RabbitMQ持久化分类"><a href="#RabbitMQ持久化分类" class="headerlink" title="RabbitMQ持久化分类"></a>RabbitMQ持久化分类</h2><p>RabbitMQ的持久化队列分为：<br>1：队列持久化<br>2：消息持久化<br>3：交换机持久化<br>不论是持久化的消息还是非持久化的消息都可以写入到磁盘中，只不过非持久的是等内存不足的情况下才会被写入到磁盘中。</p>
<h2 id="RabbitMQ队列持久化的代码实现"><a href="#RabbitMQ队列持久化的代码实现" class="headerlink" title="RabbitMQ队列持久化的代码实现"></a>RabbitMQ队列持久化的代码实现</h2><p>队列的持久化是声明队列时的durable参数来实现的，Durable为true时，队列才会持久化。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数1：名字  </span></span><br><span class="line"><span class="comment">// 参数2：是否持久化，</span></span><br><span class="line"><span class="comment">// 参数3：独du占的queue， </span></span><br><span class="line"><span class="comment">// 参数4：不使用时是否自动删除，</span></span><br><span class="line"><span class="comment">// 参数5：其他参数</span></span><br><span class="line">channel.queueDeclare(queueName,<span class="literal">true</span>,<span class="literal">false</span>,<span class="literal">false</span>,<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<p>其中参数2：设置为true,就代表的是持久化的含义。即durable&#x3D;true。持久化的队列在web控制台中有一个<code>D</code> 的标记</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408143719926.png" alt="image-20210408143719926"></p>
<h3 id="测试步骤"><a href="#测试步骤" class="headerlink" title="测试步骤"></a>测试步骤</h3><p>1：可以建立一个临时队列</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408143755920.png" alt="image-20210408143755920"></p>
<p>2：然后重启rabbit-server服务，会发现持久化队列依然在，而非持久队列会丢失。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systecmctl restart rabbitmq-server</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">或者</span></span><br><span class="line">docker restart myrabbit</span><br></pre></td></tr></table></figure>

<h2 id="RabbitMQ消息持久化"><a href="#RabbitMQ消息持久化" class="headerlink" title="RabbitMQ消息持久化"></a>RabbitMQ消息持久化</h2><p>消息持久化是通过消息的属性deliveryMode来设置是否持久化，在发送消息时通过basicPublish的参数传入。</p>
<blockquote>
<p>在整合springboot中，可以在rabbitTemplate.convertAndSend();中显示声明消息持久化</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数1：交换机的名字</span></span><br><span class="line"><span class="comment">// 参数2：队列或者路由key</span></span><br><span class="line"><span class="comment">// 参数3：是否进行消息持久化</span></span><br><span class="line"><span class="comment">// 参数4：发送消息的内容</span></span><br><span class="line">channel.basicPublish(exchangeName, routingKey1, MessageProperties.PERSISTENT_TEXT_PLAIN, message.getBytes());</span><br></pre></td></tr></table></figure>

<h2 id="RabbitMQ交换机持久化"><a href="#RabbitMQ交换机持久化" class="headerlink" title="RabbitMQ交换机持久化"></a>RabbitMQ交换机持久化</h2><p>和队列一样，交换机也需要在定义的时候设置持久化的标识，否则在rabbit-server服务重启以后将丢失。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数1：交换机的名字</span></span><br><span class="line"><span class="comment">// 参数2：交换机的类型，topic/direct/fanout/headers</span></span><br><span class="line"><span class="comment">// 参数3：是否持久化</span></span><br><span class="line">channel.exchangeDeclare(exchangeName,exchangeType,<span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<h1 id="RabbitMQ运维-内存磁盘的监控"><a href="#RabbitMQ运维-内存磁盘的监控" class="headerlink" title="RabbitMQ运维-内存磁盘的监控"></a>RabbitMQ运维-内存磁盘的监控</h1><h2 id="RabbitMQ的内存警告"><a href="#RabbitMQ的内存警告" class="headerlink" title="RabbitMQ的内存警告"></a>RabbitMQ的内存警告</h2><p>当内存使用超过配置的<strong>阈值</strong>或者磁盘空间剩余空间对于配置的阈值时，RabbitMQ会暂时阻塞客户端的连接，并且停止接收从客户端发来的消息，以此避免服务器的崩溃，客户端与服务端的心跳检测机制也会失效。<br>如下图：</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408144636622.png" alt="image-20210408144636622"><br>&#x3D;&#x3D;当出现blocking或blocked话说明到达了阈值和以及高负荷运行了。&#x3D;&#x3D;</p>
<h2 id="RabbitMQ的内存控制"><a href="#RabbitMQ的内存控制" class="headerlink" title="RabbitMQ的内存控制"></a>RabbitMQ的内存控制</h2><p>参考帮助文档：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/configure.html">https://www.rabbitmq.com/configure.html</a><br>当出现警告的时候，可以通过配置去修改和调整</p>
<h3 id="命令的方式"><a href="#命令的方式" class="headerlink" title="命令的方式"></a>命令的方式</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl set_vm_memory_high_watermark &lt;fraction&gt; #相对</span><br><span class="line">rabbitmqctl set_vm_memory_high_watermark absolute 50MB #绝对</span><br></pre></td></tr></table></figure>

<p>fraction&#x2F;value 为内存阈值。默认情况是：0.4&#x2F;2GB，代表的含义是：当RabbitMQ的内存超过40%时，就会产生警告并且阻塞所有生产者的连接。&#x3D;&#x3D;通过此命令修改阈值在Broker重启以后将会失效，通过修改配置文件方式设置的阈值则不会随着重启而消失，但修改了配置文件一样要重启broker才会生效。&#x3D;&#x3D;</p>
<p>分析：</p>
<blockquote>
<p>rabbitmqctl set_vm_memory_high_watermark absolute 50MB</p>
</blockquote>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408144901766.png" alt="image-20210408144901766"></p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408144914670.png" alt="image-20210408144914670"></p>
<h3 id="配置文件方式-rabbitmq-conf"><a href="#配置文件方式-rabbitmq-conf" class="headerlink" title="配置文件方式 rabbitmq.conf"></a>配置文件方式 rabbitmq.conf</h3><blockquote>
<p>当前配置文件：&#x2F;etc&#x2F;rabbitmq&#x2F;rabbitmq.conf</p>
</blockquote>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#默认</span></span><br><span class="line"><span class="comment">#vm_memory_high_watermark.relative = 0.4</span></span><br><span class="line"><span class="comment"># 使用relative相对值进行设置fraction,建议取值在04~0.7之间，不建议超过0.7.</span></span><br><span class="line"><span class="attr">vm_memory_high_watermark.relative</span> = <span class="string">0.6</span></span><br><span class="line"><span class="comment"># 使用absolute的绝对值的方式，但是是KB,MB,GB对应的命令如下</span></span><br><span class="line"><span class="attr">vm_memory_high_watermark.absolute</span> = <span class="string">2GB</span></span><br></pre></td></tr></table></figure>

<h2 id="RabbitMQ的内存换页"><a href="#RabbitMQ的内存换页" class="headerlink" title="RabbitMQ的内存换页"></a>RabbitMQ的内存换页</h2><p>在某个Broker节点及内存阻塞生产者之前，它会尝试将队列中的消息换页到磁盘以释放内存空间，持久化和非持久化的消息都会写入磁盘中，其中持久化的消息本身就在磁盘中有一个副本，所以在转移的过程中持久化的消息会先从内存中清除掉。</p>
<blockquote>
<p>默认情况下，内存到达的阈值是50%时就会换页处理。<br>也就是说，在默认情况下该内存的阈值是0.4的情况下，当内存超过0.4*0.5&#x3D;0.2时，会进行换页动作。</p>
</blockquote>
<p>比如有1000MB内存，当内存的使用率达到了400MB,已经达到了极限，但是因为配置的换页内存0.5，这个时候会在达到极限400mb之前，会把内存中的200MB进行转移到磁盘中。从而达到稳健的运行。</p>
<p>可以通过设置 <code>vm_memory_high_watermark_paging_ratio</code> 来进行调整</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">vm_memory_high_watermark.relative</span> = <span class="string">0.4</span></span><br><span class="line"><span class="attr">vm_memory_high_watermark_paging_ratio</span> = <span class="string">0.7（设置小于1的值）</span></span><br></pre></td></tr></table></figure>

<p>为什么设置小于1，以为你如果你设置为1的阈值。内存都已经达到了极限了。你在去换页意义不是很大了。</p>
<h2 id="RabbitMQ的磁盘预警"><a href="#RabbitMQ的磁盘预警" class="headerlink" title="RabbitMQ的磁盘预警"></a>RabbitMQ的磁盘预警</h2><p>当磁盘的剩余空间低于确定的阈值时，RabbitMQ同样会阻塞生产者，这样可以避免因非持久化的消息持续换页而耗尽磁盘空间导致服务器崩溃。</p>
<blockquote>
<p>默认情况下：磁盘预警为50MB的时候会进行预警。表示当前磁盘空间第50MB的时候会阻塞生产者并且停止内存消息换页到磁盘的过程。<br>这个阈值可以减小，但是不能完全的消除因磁盘耗尽而导致崩溃的可能性。比如在两次磁盘空间的检查空隙内，第一次检查是：60MB ，第二检查可能就是1MB,就会出现警告。</p>
</blockquote>
<p>通过命令方式修改如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rabbitmqctl</span> <span class="string">set_disk_free_limit  &lt;disk_limit&gt;</span></span><br><span class="line"><span class="attr">rabbitmqctl</span> <span class="string">set_disk_free_limit memory_limit  &lt;fraction&gt;</span></span><br><span class="line"><span class="attr">disk_limit：固定单位</span> <span class="string">KB MB GB</span></span><br><span class="line"><span class="attr">fraction</span> <span class="string">：是相对阈值，建议范围在:1.0~2.0之间。（相对于内存）</span></span><br></pre></td></tr></table></figure>

<p>通过配置文件配置如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">disk_free_limit.relative</span> = <span class="string">3.0</span></span><br><span class="line"><span class="attr">disk_free_limit.absolute</span> = <span class="string">50mb</span></span><br></pre></td></tr></table></figure>

<h1 id="RabbitMQ-高级-集群"><a href="#RabbitMQ-高级-集群" class="headerlink" title="RabbitMQ-高级-集群"></a>RabbitMQ-高级-集群</h1><h2 id="RabbitMQ-集群"><a href="#RabbitMQ-集群" class="headerlink" title="RabbitMQ 集群"></a>RabbitMQ 集群</h2><p>RabbitMQ这款消息队列中间件产品本身是基于Erlang编写，Erlang语言天生具备分布式特性（通过同步Erlang集群各节点的magic cookie来实现）。因此，RabbitMQ天然支持Clustering。这使得RabbitMQ本身不需要像ActiveMQ、Kafka那样通过ZooKeeper分别来实现HA方案和保存集群的元数据。集群是保证可靠性的一种方式，同时可以通过水平扩展以达到增加消息吞吐量能力的目的。<br>在实际使用过程中多采取多机多实例部署方式，为了便于同学们练习搭建，有时候你不得不在一台机器上去搭建一个rabbitmq集群，本章主要针对单机多实例这种方式来进行开展。</p>
<blockquote>
<p>主要参考官方文档：<a target="_blank" rel="noopener" href="https://www.rabbitmq.com/clustering.html">https://www.rabbitmq.com/clustering.html</a></p>
</blockquote>
<h2 id="集群搭建"><a href="#集群搭建" class="headerlink" title="集群搭建"></a>集群搭建</h2><p>配置的前提是你的rabbitmq可以运行起来，比如”ps aux|grep rabbitmq”你能看到相关进程，又比如运行“rabbitmqctl status”你可以看到类似如下信息，而不报错：</p>
<p>执行下面命令进行查看：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ps aux|grep rabbitmq</span><br></pre></td></tr></table></figure>

<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408160506167.png" alt="image-20210408160506167"></p>
<p>或者</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status rabbitmq-server</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：确保RabbitMQ可以运行的，确保完成之后，把单机版的RabbitMQ服务停止，后台看不到RabbitMQ的进程为止</p>
</blockquote>
<h2 id="单机多实例搭建"><a href="#单机多实例搭建" class="headerlink" title="单机多实例搭建"></a>单机多实例搭建</h2><blockquote>
<p>不推荐</p>
</blockquote>
<p><strong>场景：</strong>假设有两个rabbitmq节点，分别为rabbit-1, rabbit-2，rabbit-1作为主节点，rabbit-2作为从节点。<br><strong>启动命令</strong>：RABBITMQ_NODE_PORT&#x3D;5672 RABBITMQ_NODENAME&#x3D;rabbit-1 rabbitmq-server -detached<br><strong>结束命令</strong>：rabbitmqctl -n rabbit-1 stop</p>
<h3 id="第一步：启动第一个节点rabbit-1"><a href="#第一步：启动第一个节点rabbit-1" class="headerlink" title="第一步：启动第一个节点rabbit-1"></a><strong>第一步</strong>：启动第一个节点rabbit-1</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">sudo RABBITMQ_NODE_PORT=5672 RABBITMQ_NODENAME=rabbit-1 rabbitmq-server start &amp;</span></span><br><span class="line">...............省略...................</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash"><span class="comment">#########  Logs: /var/log/rabbitmq/rabbit-1.log</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash"><span class="comment">#####  ##        /var/log/rabbitmq/rabbit-1-sasl.log</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash"><span class="comment">#########</span></span></span><br><span class="line">              Starting broker...</span><br><span class="line"> completed with 7 plugins.</span><br></pre></td></tr></table></figure>

<p>至此节点rabbit-1启动完成。</p>
<h3 id="启动第二个节点rabbit-2"><a href="#启动第二个节点rabbit-2" class="headerlink" title="启动第二个节点rabbit-2"></a>启动第二个节点rabbit-2</h3><blockquote>
<p>注意：web管理插件端口占用,所以还要指定其web插件占用的端口号<br>RABBITMQ_SERVER_START_ARGS&#x3D;”-rabbitmq_management listener [{port,15673}]”</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo RABBITMQ_NODE_PORT=5673 RABBITMQ_SERVER_START_ARGS=&quot;-rabbitmq_management listener [&#123;port,15673&#125;]&quot; RABBITMQ_NODENAME=rabbit-2 rabbitmq-server start &amp;</span><br><span class="line">..............省略..................</span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash"><span class="comment">#########  Logs: /var/log/rabbitmq/rabbit-2.log</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash"><span class="comment">#####  ##        /var/log/rabbitmq/rabbit-2-sasl.log</span></span></span><br><span class="line"><span class="meta prompt_">  #</span><span class="language-bash"><span class="comment">#########</span></span></span><br><span class="line">              Starting broker...</span><br><span class="line"> completed with 7 plugins.</span><br></pre></td></tr></table></figure>

<p>至此节点rabbit-2启动完成</p>
<h3 id="验证启动-“ps-aux-grep-rabbitmq”"><a href="#验证启动-“ps-aux-grep-rabbitmq”" class="headerlink" title="验证启动 “ps aux|grep rabbitmq”"></a>验证启动 “ps aux|grep rabbitmq”</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq  2022  2.7  0.4 5349380 77020 ?       Sl   11:03   0:06 /usr/lib/erlang/erts-9.2/bin/beam.smp -W w -A 128 -P 1048576 -t 5000000 -stbt db -zdbbl 128000 -K true -B i -- -root /usr/lib/erlang -progname erl -- -home /var/lib/rabbitmq -- -pa /usr/lib/rabbitmq/lib/rabbitmq_server-3.6.15/ebin -noshell -noinput -s rabbit boot -sname rabbit-1 -boot start_sasl -kernel inet_default_connect_options [&#123;nodelay,true&#125;] -rabbit tcp_listeners [&#123;&quot;auto&quot;,5672&#125;] -sasl errlog_type error -sasl sasl_error_logger false -rabbit error_logger &#123;file,&quot;/var/log/rabbitmq/rabbit-1.log&quot;&#125; -rabbit sasl_error_logger &#123;file,&quot;/var/log/rabbitmq/rabbit-1-sasl.log&quot;&#125; -rabbit enabled_plugins_file &quot;/etc/rabbitmq/enabled_plugins&quot; -rabbit plugins_dir &quot;/usr/lib/rabbitmq/plugins:/usr/lib/rabbitmq/lib/rabbitmq_server-3.6.15/plugins&quot; -rabbit plugins_expand_dir &quot;/var/lib/rabbitmq/mnesia/rabbit-1-plugins-expand&quot; -os_mon start_cpu_sup false -os_mon start_disksup false -os_mon start_memsup false -mnesia dir &quot;/var/lib/rabbitmq/mnesia/rabbit-1&quot; -kernel inet_dist_listen_min 25672 -kernel inet_dist_listen_max 25672 start</span><br><span class="line">rabbitmq  2402  4.2  0.4 5352196 77196 ?       Sl   11:05   0:05 /usr/lib/erlang/erts-9.2/bin/beam.smp -W w -A 128 -P 1048576 -t 5000000 -stbt db -zdbbl 128000 -K true -B i -- -root /usr/lib/erlang -progname erl -- -home /var/lib/rabbitmq -- -pa /usr/lib/rabbitmq/lib/rabbitmq_server-3.6.15/ebin -noshell -noinput -s rabbit boot -sname rabbit-2 -boot start_sasl -kernel inet_default_connect_options [&#123;nodelay,true&#125;] -rabbit tcp_listeners [&#123;&quot;auto&quot;,5673&#125;] -sasl errlog_type error -sasl sasl_error_logger false -rabbit error_logger &#123;file,&quot;/var/log/rabbitmq/rabbit-2.log&quot;&#125; -rabbit sasl_error_logger &#123;file,&quot;/var/log/rabbitmq/rabbit-2-sasl.log&quot;&#125; -rabbit enabled_plugins_file &quot;/etc/rabbitmq/enabled_plugins&quot; -rabbit plugins_dir &quot;/usr/lib/rabbitmq/plugins:/usr/lib/rabbitmq/lib/rabbitmq_server-3.6.15/plugins&quot; -rabbit plugins_expand_dir &quot;/var/lib/rabbitmq/mnesia/rabbit-2-plugins-expand&quot; -os_mon start_cpu_sup false -os_mon start_disksup false -os_mon start_memsup false -mnesia dir &quot;/var/lib/rabbitmq/mnesia/rabbit-2&quot; -rabbitmq_management listener [&#123;port,15673&#125;] -kernel inet_dist_listen_min 25673 -kernel inet_dist_listen_max 25673 start</span><br></pre></td></tr></table></figure>

<h3 id="rabbit-1操作作为主节点"><a href="#rabbit-1操作作为主节点" class="headerlink" title="rabbit-1操作作为主节点"></a>rabbit-1操作作为主节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">停止应用</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">sudo rabbitmqctl -n rabbit-1 stop_app</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">目的是清除节点上的历史数据（如果不清除，无法将节点加入到集群）</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">sudo rabbitmqctl -n rabbit-1 reset</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">启动应用</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">sudo rabbitmqctl -n rabbit-1 start_app</span></span><br></pre></td></tr></table></figure>

<h3 id="rabbit2操作为从节点"><a href="#rabbit2操作为从节点" class="headerlink" title="rabbit2操作为从节点"></a>rabbit2操作为从节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止应用</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">sudo rabbitmqctl -n rabbit-2 stop_app</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">目的是清除节点上的历史数据（如果不清除，无法将节点加入到集群）</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">sudo rabbitmqctl -n rabbit-2 reset</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将rabbit2节点加入到rabbit1（主节点）集群当中【Server-node服务器的主机名】</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">sudo rabbitmqctl -n rabbit-2 join_cluster rabbit-1@<span class="string">&#x27;Server-node&#x27;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动应用</span></span><br><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">sudo rabbitmqctl -n rabbit-2 start_app</span></span><br></pre></td></tr></table></figure>

<h3 id="验证集群状态"><a href="#验证集群状态" class="headerlink" title="验证集群状态"></a>验证集群状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">sudo rabbitmqctl cluster_status -n rabbit-1</span></span><br><span class="line">//集群有两个节点：rabbit-1@Server-node、rabbit-2@Server-node</span><br><span class="line">[&#123;nodes,[&#123;disc,[&#x27;rabbit-1@Server-node&#x27;,&#x27;rabbit-2@Server-node&#x27;]&#125;]&#125;,</span><br><span class="line"> &#123;running_nodes,[&#x27;rabbit-2@Server-node&#x27;,&#x27;rabbit-1@Server-node&#x27;]&#125;,</span><br><span class="line"> &#123;cluster_name,&lt;&lt;&quot;rabbit-1@Server-node.localdomain&quot;&gt;&gt;&#125;,</span><br><span class="line"> &#123;partitions,[]&#125;,</span><br><span class="line"> &#123;alarms,[&#123;&#x27;rabbit-2@Server-node&#x27;,[]&#125;,&#123;&#x27;rabbit-1@Server-node&#x27;,[]&#125;]&#125;]docker </span><br></pre></td></tr></table></figure>

<h3 id="Web监控"><a href="#Web监控" class="headerlink" title="Web监控"></a>Web监控</h3><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408160526382.png" alt="image-20210408160526382"></p>
<blockquote>
<p>注意在访问的时候：web结面的管理需要给15672 node-1 和15673的node-2 设置用户名和密码。如下:</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">rabbitmqctl -n rabbit-1 add_user admin admin</span><br><span class="line">rabbitmqctl -n rabbit-1 set_user_tags admin administrator</span><br><span class="line">rabbitmqctl -n rabbit-1 set_permissions -p / admin &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;</span><br><span class="line">rabbitmqctl -n rabbit-2 add_user admin admin</span><br><span class="line">rabbitmqctl -n rabbit-2 set_user_tags admin administrator</span><br><span class="line">rabbitmqctl -n rabbit-2 set_permissions -p / admin &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;</span><br><span class="line">123456</span><br></pre></td></tr></table></figure>

<h3 id="小结-5"><a href="#小结-5" class="headerlink" title="小结"></a>小结</h3><blockquote>
<p><strong>Tips：</strong><br>如果采用多机部署方式，需读取其中一个节点的cookie, 并复制到其他节点（节点之间通过cookie确定相互是否可通信）。cookie存放在&#x2F;var&#x2F;lib&#x2F;rabbitmq&#x2F;.erlang.cookie。<br>例如：主机名分别为rabbit-1、rabbit-2<br>1、逐个启动各节点<br>2、配置各节点的hosts文件( vim &#x2F;etc&#x2F;hosts)<br>​ ip1：rabbit-1<br>​ ip2：rabbit-2<br>其它步骤雷同单机部署方式</p>
</blockquote>
<h2 id="docker搭建RabbitMQ集群"><a href="#docker搭建RabbitMQ集群" class="headerlink" title="docker搭建RabbitMQ集群"></a>docker搭建RabbitMQ集群</h2><blockquote>
<p>docker pull   rabbitmq:management镜像</p>
</blockquote>
<h3 id="步骤一：安装RabbitMQ"><a href="#步骤一：安装RabbitMQ" class="headerlink" title="步骤一：安装RabbitMQ"></a>步骤一：安装RabbitMQ</h3><blockquote>
<p>创建两个容器 rabbit1 rabbit2</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --hostname rabbit1 --name myrabbit1 -p 15672:15672 -p 5672:5672 -e RABBITMQ_ERLANG_COOKIE=&#x27;rabbitcookie&#x27; rabbitmq:management</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --hostname rabbit2 --name myrabbit2 -p 5673:5672 --link myrabbit1:rabbit1 -e RABBITMQ_ERLANG_COOKIE=&#x27;rabbitcookie&#x27; rabbitmq:management</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --hostname rabbit3 --name myrabbit3 -p 5674:5672 --link myrabbit1:rabbit1 --link myrabbit2:rabbit2 -e RABBITMQ_ERLANG_COOKIE=&#x27;rabbitcookie&#x27; rabbitmq:management</span><br></pre></td></tr></table></figure>



<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408155546379.png" alt="image-20210408155546379"></p>
<p><strong>注意点：</strong></p>
<ol>
<li>多个容器之间使用“–link”连接，此属性不能少；</li>
<li>Erlang Cookie值必须相同，也就是RABBITMQ_ERLANG_COOKIE参数的值必须相同，原因见下文“配置相同Erlang Cookie”部分；</li>
</ol>
<h3 id="步骤二：加入RabbitMQ节点到集群"><a href="#步骤二：加入RabbitMQ节点到集群" class="headerlink" title="步骤二：加入RabbitMQ节点到集群"></a>步骤二：加入RabbitMQ节点到集群</h3><p><strong>设置节点1：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it myrabbit1 bash</span><br><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl reset</span><br><span class="line">rabbitmqctl start_app</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>

<p><strong>设置节点2，加入到集群：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it myrabbit2 bash</span><br><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl reset</span><br><span class="line">rabbitmqctl join_cluster --ram rabbit@rabbit1</span><br><span class="line">rabbitmqctl start_app</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>

<p><strong>设置节点3，加入到集群：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it myrabbit3 bash</span><br><span class="line">rabbitmqctl stop_app</span><br><span class="line">rabbitmqctl reset</span><br><span class="line">rabbitmqctl join_cluster --ram rabbit@rabbit1</span><br><span class="line">rabbitmqctl start_app</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>

<p>参数“–ram”表示设置为内存节点，忽略次参数默认为磁盘节点</p>
<h3 id="完整过程"><a href="#完整过程" class="headerlink" title="完整过程"></a>完整过程</h3><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408160252699.png" alt="image-20210408160252699"></p>
<blockquote>
<p>设置好之后，使用http:&#x2F;&#x2F;物理机ip:15672 进行访问了，默认账号密码是guest&#x2F;guest，效果如下图：</p>
</blockquote>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408160428220.png" alt="image-20210408160428220"></p>
<h1 id="RabbitMQ-高级-分布式事务"><a href="#RabbitMQ-高级-分布式事务" class="headerlink" title="RabbitMQ-高级-分布式事务"></a>RabbitMQ-高级-分布式事务</h1><h2 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h2><p>分布式事务指事务的操作位于不同的节点上，需要保证事务的 AICD 特性。<br>例如在下单场景下，库存和订单如果不在同一个节点上，就涉及分布式事务。</p>
<h2 id="分布式事务的方式"><a href="#分布式事务的方式" class="headerlink" title="分布式事务的方式"></a>分布式事务的方式</h2><p>在分布式系统中，要实现分布式事务，无外乎那几种解决方案。</p>
<h3 id="两阶段提交（2PC）需要数据库产商的支持，java组件有atomikos等。"><a href="#两阶段提交（2PC）需要数据库产商的支持，java组件有atomikos等。" class="headerlink" title="两阶段提交（2PC）需要数据库产商的支持，java组件有atomikos等。"></a>两阶段提交（2PC）需要数据库产商的支持，java组件有atomikos等。</h3><p>两阶段提交（Two-phase Commit，2PC），通过引入协调者（Coordinator）来协调参与者的行为，并最终决定这些参与者是否要真正执行事务。</p>
<h4 id="准备阶段"><a href="#准备阶段" class="headerlink" title="准备阶段"></a>准备阶段</h4><p>协调者询问参与者事务是否执行成功，参与者发回事务执行结果。</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408183044785.png" alt="image-20210408183044785"></p>
<h4 id="提交阶段"><a href="#提交阶段" class="headerlink" title="提交阶段"></a><strong>提交阶段</strong></h4><p>如果事务在每个参与者上都执行成功，事务协调者发送通知让参与者提交事务；否则，协调者发送通知让参与者回滚事务。<br>需要注意的是，在准备阶段，参与者执行了事务，但是还未提交。只有在提交阶段接收到协调者发来的通知后，才进行提交或者回滚。</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408183147408.png" alt="image-20210408183147408"></p>
<h4 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a>存在的问题</h4><ul>
<li>2.1 <strong>同步阻塞</strong> 所有事务参与者在等待其它参与者响应的时候都处于同步阻塞状态，无法进行其它操作。</li>
<li>2.2 <strong>单点问题</strong> 协调者在 2PC 中起到非常大的作用，发生故障将会造成很大影响。特别是在阶段二发生故障，所有参与者会一直等待状态，无法完成其它操作。</li>
<li>2.3 <strong>数据不一致</strong> 在阶段二，如果协调者只发送了部分 Commit 消息，此时网络发生异常，那么只有部分参与者接收到 Commit 消息，也就是说只有部分参与者提交了事务，使得系统数据不一致。</li>
<li>2.4 <strong>太过保守</strong> 任意一个节点失败就会导致整个事务失败，没有完善的容错机制。</li>
</ul>
<h3 id="补偿事务（TCC）-严选，阿里，蚂蚁金服。"><a href="#补偿事务（TCC）-严选，阿里，蚂蚁金服。" class="headerlink" title="补偿事务（TCC） 严选，阿里，蚂蚁金服。"></a>补偿事务（TCC） 严选，阿里，蚂蚁金服。</h3><p>TCC 其实就是采用的<strong>补偿机制</strong>，其核心思想是：&#x3D;&#x3D;针对每个操作，都要注册一个与其对应的确认和补偿（撤销）操作。&#x3D;&#x3D;它分为三个阶段：</p>
<ul>
<li><strong>Try 阶段</strong>主要是对业务系统做检测及资源预留</li>
<li><strong>Confirm 阶段</strong>主要是对业务系统做确认提交，Try阶段执行成功并开始执行 Confirm阶段时，默认 - - - Confirm阶段是不会出错的。即：只要Try成功，Confirm一定成功。</li>
<li><strong>Cancel 阶段</strong>主要是在业务执行错误，需要回滚的状态下执行的业务取消，预留资源释放。</li>
</ul>
<blockquote>
<p>举个例子，假入 Bob 要向 Smith 转账，思路大概是： 我们有一个本地方法，里面依次调用<br>1：首先在 Try 阶段，要先调用远程接口把 Smith 和 Bob 的钱给冻结起来。<br>2：在 Confirm 阶段，执行远程调用的转账的操作，转账成功进行解冻。<br>3：如果第2步执行成功，那么转账成功，如果第二步执行失败，则调用远程冻结接口对应的解冻方(Cancel)。</p>
</blockquote>
<p><strong>优点：</strong> 跟2PC比起来，实现以及流程相对简单了一些，但数据的一致性比2PC也要差一些<br><strong>缺点：</strong> 缺点还是比较明显的，在2,3步中都有可能失败。TCC属于应用层的一种补偿方式，所以需要程序员在实现的时候多写很多补偿的代码，在一些场景中，一些业务流程可能用TCC不太好定义及处理。</p>
<h3 id="本地消息表（异步确保）比如：支付宝、微信支付主动查询支付状态，对账单的形式"><a href="#本地消息表（异步确保）比如：支付宝、微信支付主动查询支付状态，对账单的形式" class="headerlink" title="本地消息表（异步确保）比如：支付宝、微信支付主动查询支付状态，对账单的形式"></a>本地消息表（异步确保）比如：支付宝、微信支付主动查询支付状态，对账单的形式</h3><p>本地消息表与业务数据表处于同一个数据库中，这样就能利用本地事务来保证在对这两个表的操作满足事务特性，并且使用了消息队列来保证最终一致性。</p>
<ul>
<li>在分布式事务操作的一方完成写业务数据的操作之后向本地消息表发送一个消息，本地事务能保证这个消息一定会被写入本地消息表中。</li>
<li>之后将本地消息表中的消息转发到 Kafka 等消息队列中，如果转发成功则将消息从本地消息表中删除，否则继续重新转发。</li>
<li>在分布式事务操作的另一方从消息队列中读取一个消息，并执行消息中的操作。</li>
</ul>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408183450378.png" alt="image-20210408183450378"></p>
<blockquote>
<p>优点： 一种非常经典的实现，避免了分布式事务，实现了最终一致性。<br>缺点： 消息表会耦合到业务系统中，如果没有封装好的解决方案，会有很多杂活需要处理。</p>
</blockquote>
<h3 id="MQ-事务消息-异步场景，通用性较强，拓展性较高。"><a href="#MQ-事务消息-异步场景，通用性较强，拓展性较高。" class="headerlink" title="MQ 事务消息 异步场景，通用性较强，拓展性较高。"></a>MQ 事务消息 异步场景，通用性较强，拓展性较高。</h3><p>有一些第三方的MQ是支持事务消息的，比如RocketMQ，他们支持事务消息的方式也是类似于采用的二阶段提交，但是市面上一些主流的MQ都是不支持事务消息的，比如 Kafka 不支持。<br>以阿里的 RabbitMQ 中间件为例，其思路大致为：</p>
<ul>
<li>第一阶段Prepared消息，会拿到消息的地址。 第二阶段执行本地事务，第三阶段通过第一阶段拿到的地址去访问消息，并修改状态。</li>
<li>也就是说在业务方法内要想消息队列提交两次请求，一次发送消息和一次确认消息。如果确认消息发送失败了RabbitMQ会定期扫描消息集群中的事务消息，这时候发现了Prepared消息，它会向消息发送者确认，所以生产方需要实现一个check接口，RabbitMQ会根据发送端设置的策略来决定是回滚还是继续发送确认消息。这样就保证了<strong>消息发送与本地事务同时成功或同时失败</strong>。</li>
</ul>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408183544176.png" alt="image-20210408183544176"></p>
<p><strong>优点：</strong> 实现了最终一致性，不需要依赖本地数据库事务。<br><strong>缺点：</strong> 实现难度大，主流MQ不支持，RocketMQ事务消息部分代码也未开源。</p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>通过本文我们总结并对比了几种分布式分解方案的优缺点，分布式事务本身是一个技术难题，是没有一种完美的方案应对所有场景的，具体还是要根据业务场景去抉择吧。阿里RocketMQ去实现的分布式事务，现在也有除了很多分布式事务的协调器，比如LCN等，大家可以多去尝试。</p>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><p>分布式事务的完整架构图</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408183826833.png" alt="image-20210408183826833"></p>
<p>美团外卖架构：<br><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408183843552.png" alt="image-20210408183843552"></p>
<h3 id="系统与系统之间的分布式事务问题"><a href="#系统与系统之间的分布式事务问题" class="headerlink" title="系统与系统之间的分布式事务问题"></a>系统与系统之间的分布式事务问题</h3><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408205852053.png" alt="image-20210408205852053"></p>
<h3 id="系统间调用过程中事务回滚问题"><a href="#系统间调用过程中事务回滚问题" class="headerlink" title="系统间调用过程中事务回滚问题"></a>系统间调用过程中事务回滚问题</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.xuexiangban.rabbitmq.service;</span><br><span class="line"><span class="keyword">import</span> com.xuexiangban.rabbitmq.dao.OrderDataBaseService;</span><br><span class="line"><span class="keyword">import</span> com.xuexiangban.rabbitmq.pojo.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.client.SimpleClientHttpRequestFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"><span class="keyword">import</span> org.springframework.transaction.annotation.Transactional;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">OrderService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderDataBaseService orderDataBaseService;</span><br><span class="line">    <span class="comment">// 创建订单</span></span><br><span class="line">    <span class="meta">@Transactional(rollbackFor = Exception.class)</span> <span class="comment">// 订单创建整个方法添加事务</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createOrder</span><span class="params">(Order orderInfo)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1: 订单信息--插入丁订单系统，订单数据库事务</span></span><br><span class="line">        orderDataBaseService.saveOrder(orderInfo);</span><br><span class="line">        <span class="comment">// 2：通過Http接口发送订单信息到运单系统</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> dispatchHttpApi(orderInfo.getOrderId());</span><br><span class="line">        <span class="keyword">if</span>(!<span class="string">&quot;success&quot;</span>.equals(result)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;订单创建失败,原因是运单接口调用失败!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  模拟http请求接口发送，运单系统，将订单号传过去 springcloud</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">dispatchHttpApi</span><span class="params">(String orderId)</span> &#123;</span><br><span class="line">        <span class="type">SimpleClientHttpRequestFactory</span> <span class="variable">factory</span>  <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleClientHttpRequestFactory</span>();</span><br><span class="line">        <span class="comment">// 链接超时 &gt; 3秒</span></span><br><span class="line">        factory.setConnectTimeout(<span class="number">3000</span>);</span><br><span class="line">        <span class="comment">// 处理超时 &gt; 2秒</span></span><br><span class="line">        factory.setReadTimeout(<span class="number">2000</span>);</span><br><span class="line">        <span class="comment">// 发送http请求</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;http://localhost:9000/dispatch/order?orderId=&quot;</span>+orderId;</span><br><span class="line">        <span class="type">RestTemplate</span> <span class="variable">restTemplate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RestTemplate</span>(factory);<span class="comment">//异常</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> restTemplate.getForObject(url, String.class);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">12345678910111213141516171819202122232425262728293031323334353637383940</span></span><br></pre></td></tr></table></figure>

<h3 id="基于MQ的分布式事务整体设计思路"><a href="#基于MQ的分布式事务整体设计思路" class="headerlink" title="基于MQ的分布式事务整体设计思路"></a>基于MQ的分布式事务整体设计思路</h3><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408205904842.png" alt="image-20210408205904842"></p>
<h3 id="基于MQ的分布式事务消息的可靠生产问题"><a href="#基于MQ的分布式事务消息的可靠生产问题" class="headerlink" title="基于MQ的分布式事务消息的可靠生产问题"></a>基于MQ的分布式事务消息的可靠生产问题</h3><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408205919570.png" alt="image-20210408205919570"></p>
<p>如果这个时候MQ服务器出现了异常和故障，那么消息是无法获取到回执信息。怎么解决呢？r</p>
<h4 id="基于MQ的分布式事务消息的可靠生产问题-定时重发"><a href="#基于MQ的分布式事务消息的可靠生产问题-定时重发" class="headerlink" title="基于MQ的分布式事务消息的可靠生产问题-定时重发"></a>基于MQ的分布式事务消息的可靠生产问题-定时重发</h4><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408205933522.png" alt="image-20210408205933522"></p>
<h3 id="基于MQ的分布式事务消息的可靠消费"><a href="#基于MQ的分布式事务消息的可靠消费" class="headerlink" title="基于MQ的分布式事务消息的可靠消费"></a>基于MQ的分布式事务消息的可靠消费</h3><p><img src="https://img-blog.csdnimg.cn/img_convert/3dc25dcadc591a661fe44956066e6c54.png" alt="img"></p>
<h3 id="基于MQ的分布式事务消息的消息重发"><a href="#基于MQ的分布式事务消息的消息重发" class="headerlink" title="基于MQ的分布式事务消息的消息重发"></a>基于MQ的分布式事务消息的消息重发</h3><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408205943898.png" alt="image-20210408205943898"></p>
<h3 id="基于MQ的分布式事务消息的死信队列消息转移-人工处理"><a href="#基于MQ的分布式事务消息的死信队列消息转移-人工处理" class="headerlink" title="基于MQ的分布式事务消息的死信队列消息转移 + 人工处理"></a>基于MQ的分布式事务消息的死信队列消息转移 + 人工处理</h3><p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408205958185.png" alt="image-20210408205958185"></p>
<p>如果死信队列报错就进行人工处理</p>
<p><img src="https://xiamu-image.oss-cn-beijing.aliyuncs.com/Java/RabbitMQ/image-20210408210012467.png" alt="image-20210408210012467"></p>
<h3 id="基于MQ的分布式事务消息的死信队列消息重试注意事项"><a href="#基于MQ的分布式事务消息的死信队列消息重试注意事项" class="headerlink" title="基于MQ的分布式事务消息的死信队列消息重试注意事项"></a>基于MQ的分布式事务消息的死信队列消息重试注意事项</h3><h3 id="基于MQ的分布式事务消息的定式重发"><a href="#基于MQ的分布式事务消息的定式重发" class="headerlink" title="基于MQ的分布式事务消息的定式重发"></a>基于MQ的分布式事务消息的定式重发</h3><h2 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h2><h3 id="基于MQ的分布式事务解决方案优点："><a href="#基于MQ的分布式事务解决方案优点：" class="headerlink" title="基于MQ的分布式事务解决方案优点："></a>基于MQ的分布式事务解决方案优点：</h3><p>1、通用性强<br>2、拓展方便<br>3、耦合度低，方案也比较成熟</p>
<h3 id="基于MQ的分布式事务解决方案缺点："><a href="#基于MQ的分布式事务解决方案缺点：" class="headerlink" title="基于MQ的分布式事务解决方案缺点："></a>基于MQ的分布式事务解决方案缺点：</h3><p>1、基于消息中间件，只适合异步场景<br>2、消息会延迟处理，需要业务上能够容忍</p>
<h3 id="建议"><a href="#建议" class="headerlink" title="建议"></a>建议</h3><p>1、尽量去避免分布式事务<br>2、尽量将非核心业务做成异步</p>
<h1 id="RabbitMQ面试题分析"><a href="#RabbitMQ面试题分析" class="headerlink" title="RabbitMQ面试题分析"></a>RabbitMQ面试题分析</h1><p><strong>面试题：1、Rabbitmq 为什么需要信道，为什么不是TCP直接通信</strong></p>
<blockquote>
<p>1、TCP的创建和销毁，开销大，创建要三次握手，销毁要4次分手。</p>
<p>2、如果不用信道，那应用程序就会TCP连接到Rabbit服务器，高峰时每秒成千上万连接就会造成资源的巨大浪费，而且&#x3D;&#x3D;底层操作系统每秒处理tcp连接数也是有限制的，&#x3D;&#x3D;必定造成性能瓶颈。</p>
<p>3、信道的原理是一条线程一条信道，多条线程多条信道同用一条TCP连接，一条TCP连接可以容纳无限的信道，即使每秒成千上万的请求也不会成为性能瓶颈。</p>
</blockquote>
<p><strong>2：queue队列到底在消费者创建还是生产者创建？</strong></p>
<blockquote>
<p>1： 一般建议是在rabbitmq操作面板创建。这是一种稳妥的做法。<br>2：按照常理来说，确实应该消费者这边创建是最好，消息的消费是在这边。这样你承受一个后果，可能我生产在生产消息可能会丢失消息。<br>3：在生产者创建队列也是可以，这样稳妥的方法，消息是不会出现丢失。<br>ng() {<br>return “User{” +<br>“name&#x3D;” + name +<br>“, tags&#x3D;” + tags +<br>‘}’;<br>}<br>&#x2F;&#x2F;GET&#x2F;SET方法省略<br>public String getName() {<br>return name;<br>}<br>public void setName(String name) {<br>this.name &#x3D; name;<br>}<br>public String getTags() {<br>return tags;<br>}<br>public void setTags(String tags) {<br>this.tags &#x3D; tags;<br>}<br>}<br>public static class ClusterStatus {<br>private long diskFree;<br>private long diskLimit;<br>private long fdUsed;<br>private long fdTotal;<br>private long socketUsed;<br>private long socketTotal;<br>private long memoryUsed;<br>private long memoryLimit;<br>private long procUsed;<br>private long procTotal;<br>&#x2F;&#x2F; 此处省略了Getter和Setter方法<br>public long getDiskFree() {<br>return diskFree;<br>}<br>public void setDiskFree(long diskFree) {<br>this.diskFree &#x3D; diskFree;<br>}<br>public long getDiskLimit() {<br>return diskLimit;<br>}<br>public void setDiskLimit(long diskLimit) {<br>this.diskLimit &#x3D; diskLimit;<br>}<br>public long getFdUsed() {<br>return fdUsed;<br>}<br>public void setFdUsed(long fdUsed) {<br>this.fdUsed &#x3D; fdUsed;<br>}<br>public long getFdTotal() {<br>return fdTotal;<br>}<br>public void setFdTotal(long fdTotal) {<br>this.fdTotal &#x3D; fdTotal;<br>}<br>public long getSocketUsed() {<br>return socketUsed;<br>}<br>public void setSocketUsed(long socketUsed) {<br>this.socketUsed &#x3D; socketUsed;<br>}<br>public long getSocketTotal() {<br>return socketTotal;<br>}<br>public void setSocketTotal(long socketTotal) {<br>this.socketTotal &#x3D; socketTotal;<br>}<br>public long getMemoryUsed() {<br>return memoryUsed;<br>}<br>public void setMemoryUsed(long memoryUsed) {<br>this.memoryUsed &#x3D; memoryUsed;<br>}<br>public long getMemoryLimit() {<br>return memoryLimit;<br>}<br>public void setMemoryLimit(long memoryLimit) {<br>this.memoryLimit &#x3D; memoryLimit;<br>}<br>public long getProcUsed() {<br>return procUsed;<br>}<br>public void setProcUsed(long procUsed) {<br>this.procUsed &#x3D; procUsed;<br>}<br>public long getProcTotal() {<br>return procTotal;<br>}<br>public void setProcTotal(long procTotal) {<br>this.procTotal &#x3D; procTotal;<br>}<br>@Override<br>public String toString() {<br>return “ClusterStatus{” +<br>“diskFree&#x3D;” + diskFree +<br>“, diskLimit&#x3D;” + diskLimit +<br>“, fdUsed&#x3D;” + fdUsed +<br>“, fdTotal&#x3D;” + fdTotal +<br>“, socketUsed&#x3D;” + socketUsed +<br>“, socketTotal&#x3D;” + socketTotal +<br>“, memoryUsed&#x3D;” + memoryUsed +<br>“, memoryLimit&#x3D;” + memoryLimit +<br>“, procUsed&#x3D;” + procUsed +<br>“, procTotal&#x3D;” + procTotal +<br>‘}’;<br>}<br>}<br>}</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">3. 启动测试</span><br><span class="line"></span><br><span class="line">[外链图片转存中...(img-NT5rDu9B-1616548769364)]</span><br><span class="line"></span><br><span class="line">## 4、Zabbix 监控RabbitMQ</span><br><span class="line"></span><br><span class="line">&gt; Zabbix是一个基于WEB界面提供分布式系统监视以及网络监视功能的企业级开源解决方案,他也可以帮助我们搭建一个MQ集群的监控系统,同时提供预警等功能，但是由于其搭建配置要求比较高一般都是由运维人员负责搭建,感兴趣的同学可以访问https://www.zabbix.com/ 官网进行了解学习。</span><br><span class="line"></span><br><span class="line"># RabbitMQ面试题分析</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**面试题：1、Rabbitmq 为什么需要信道，为什么不是TCP直接通信**</span><br><span class="line"></span><br><span class="line">&gt; 1、TCP的创建和销毁，开销大，创建要三次握手，销毁要4次分手。</span><br><span class="line">&gt;</span><br><span class="line">&gt; 2、如果不用信道，那应用程序就会TCP连接到Rabbit服务器，高峰时每秒成千上万连接就会造成资源的巨大浪费，而且==底层操作系统每秒处理tcp连接数也是有限制的，==必定造成性能瓶颈。</span><br><span class="line">&gt;</span><br><span class="line">&gt; 3、信道的原理是一条线程一条信道，多条线程多条信道同用一条TCP连接，一条TCP连接可以容纳无限的信道，即使每秒成千上万的请求也不会成为性能瓶颈。</span><br><span class="line"></span><br><span class="line">**2：queue队列到底在消费者创建还是生产者创建？**</span><br><span class="line"></span><br><span class="line">&gt; 1： 一般建议是在rabbitmq操作面板创建。这是一种稳妥的做法。</span><br><span class="line">&gt; 2：按照常理来说，确实应该消费者这边创建是最好，消息的消费是在这边。这样你承受一个后果，可能我生产在生产消息可能会丢失消息。</span><br><span class="line">&gt; 3：在生产者创建队列也是可以，这样稳妥的方法，消息是不会出现丢失。</span><br><span class="line">&gt; 4：如果你生产者和消费都创建的队列，谁先启动谁先创建，后面启动就覆盖前面的</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/07/09/RabbitMQ/" data-id="cl3mrhag7000l6weog6b27not" data-title="RabbitMQ" class="article-share-link">Teilen</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Rabbit/" rel="tag">Rabbit</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/05/26/%E7%AE%97%E6%B3%95/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Neuer</strong>
      <div class="article-nav-title">
        
          算法
        
      </div>
    </a>
  
  
    <a href="/2021/06/28/SpringCloud/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Älter</strong>
      <div class="article-nav-title">SpringCloud</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Kategorien</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%B7%E9%A2%98/">刷题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/MyBatis/" rel="tag">MyBatis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Rabbit/" rel="tag">Rabbit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringCloud/" rel="tag">SpringCloud</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/SpringMVC/" rel="tag">SpringMVC</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/MyBatis/" style="font-size: 10px;">MyBatis</a> <a href="/tags/Rabbit/" style="font-size: 10px;">Rabbit</a> <a href="/tags/Spring/" style="font-size: 10px;">Spring</a> <a href="/tags/SpringCloud/" style="font-size: 10px;">SpringCloud</a> <a href="/tags/SpringMVC/" style="font-size: 10px;">SpringMVC</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/05/">May 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/07/">July 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/03/">March 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/02/">February 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/01/">January 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/05/26/title/">title</a>
          </li>
        
          <li>
            <a href="/2022/05/26/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2022/05/26/%E7%AE%97%E6%B3%95/">算法</a>
          </li>
        
          <li>
            <a href="/2021/07/09/RabbitMQ/">RabbitMQ</a>
          </li>
        
          <li>
            <a href="/2021/06/28/SpringCloud/">SpringCloud</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 FH<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>